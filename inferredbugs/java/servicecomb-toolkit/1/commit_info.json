{"hash": "c92635fd5bbefbcc10b4376d09029d185ca3ab6b", "message": "fix classmaker deadlock bug\n\nSigned-off-by: MabinGo <bin.ma@huawei.com>", "file_num_lines": 53, "diff_parsed": {"added": [[21, "import java.io.InputStream;"], [22, "import java.util.concurrent.TimeoutException;"], [23, ""], [24, "import org.apache.commons.io.IOUtils;"], [28, "  public static void compile(String projectPath) throws IOException, TimeoutException, InterruptedException {"], [31, ""], [32, "    Worker worker = new Worker(exec);"], [33, "    worker.start();"], [34, "    ProcessStatus ps = worker.getProcessStatus();"], [35, ""], [37, "      worker.join(30000);"], [38, "      if (ps.exitCode == ProcessStatus.CODE_STARTED) {"], [39, "        // not finished"], [40, "        worker.interrupt();"], [41, "        throw new TimeoutException();"], [42, "      }"], [44, "      // canceled by other thread."], [45, "      worker.interrupt();"], [46, "      throw e;"], [47, "    }"], [48, "  }"], [49, ""], [50, "  private static class Worker extends Thread {"], [51, "    private final Process process;"], [52, ""], [53, "    private ProcessStatus ps;"], [54, ""], [55, "    private Worker(Process process) {"], [56, "      this.process = process;"], [57, "      this.ps = new ProcessStatus();"], [59, ""], [60, "    @Override"], [61, "    public void run() {"], [62, "      try {"], [63, "        InputStream is = process.getInputStream();"], [64, "        try {"], [65, "          ps.output = IOUtils.toString(is);"], [66, "        } catch (IOException ignore) {"], [67, "        }"], [68, "        ps.exitCode = process.waitFor();"], [69, "      } catch (InterruptedException e) {"], [70, "        Thread.currentThread().interrupt();"], [71, "      }"], [72, "    }"], [73, ""], [74, "    ProcessStatus getProcessStatus() {"], [75, "      return this.ps;"], [76, "    }"], [77, "  }"], [78, ""], [79, "  public static class ProcessStatus {"], [80, "    static final int CODE_STARTED = -257;"], [81, ""], [82, "    volatile int exitCode;"], [83, ""], [84, "    volatile String output;"]], "deleted": [[24, "  public static void compile(String projectPath) throws IOException {"], [28, "      exec.waitFor();"], [30, "      e.printStackTrace();"]]}, "num_lines_added": 56, "num_lines_removed": 3}