{"hash": "436f78c79b60d58a6a4fba7ce818d423dcf2b780", "message": "Improve PartitionServer by always processing commands in main thread rather\nthan within the watched node callback.", "file_num_lines": 491, "diff_parsed": {"added": [[42, "import java.util.concurrent.LinkedBlockingQueue;"], [43, "import java.util.concurrent.TimeUnit;"], [59, "  private final LinkedBlockingQueue<HostCommand> commandQueue;"], [60, ""], [81, "    this.commandQueue = new LinkedBlockingQueue<HostCommand>();"], [124, "        HostCommand command = commandQueue.poll(MAIN_THREAD_STEP_SLEEP_MS, TimeUnit.MILLISECONDS);"], [125, "        if (command != null) {"], [126, "          try {"], [127, "            processCommand(command, host.getState());"], [128, "          } catch (IOException e) {"], [129, "            LOG.error(\"Failed to process command: \" + command, e);"], [130, "            break;"], [131, "          }"], [132, "        }"], [134, "        LOG.info(\"Interrupted in main loop. Exiting.\", e);"], [143, "    stopUpdating();"], [144, "    // Signal OFFLINE"], [192, "  public void onWatchedNodeChange(final HostCommand command) {"], [201, "        commandQueue.put(command);"], [203, "    } catch (InterruptedException e) {"], [204, "      LOG.error(\"Failed to process command.\", e);"], [205, "      stopSynchronized();"], [209, "  public void processCommandOnStartup() {"], [212, "      LOG.info(\"Current command is: \" + command);"], [214, "        commandQueue.put(command);"], [218, "    } catch (Exception e) {"], [341, "  private void stopUpdating() throws InterruptedException {"], [342, "    if (updateThread != null) {"], [343, "      LOG.info(\"Update thread is still running. Interrupting and waiting for it to finish...\");"], [344, "      updateThread.interrupt();"], [345, "      updateThread.join(); // In case of interrupt exception, server will stop and state will be coherent."], [346, "    }"], [347, "  }"], [348, ""]], "deleted": [[119, "        Thread.sleep(MAIN_THREAD_STEP_SLEEP_MS);"], [121, "        LOG.info(\"Interrupted in run loop. Exiting.\", e);"], [130, "    if (updateThread != null) {"], [131, "      LOG.info(\"Update thread is still running. Interrupting and waiting for it to finish...\");"], [132, "      updateThread.interrupt();"], [133, "      updateThread.join(); // In case of interrupt exception, server will stop and state will be coherent."], [134, "    }"], [182, "  public synchronized void onWatchedNodeChange(HostCommand command) {"], [191, "        processCommand(command, host.getState());"], [193, "    } catch (IOException e) {"], [194, "      LOG.error(\"Failed to process current command.\", e);"], [195, "      stop();"], [199, "  public synchronized void processCommandOnStartup() {"], [203, "        processCommand(command, host.getState());"], [207, "    } catch (IOException e) {"], [572, ""]]}, "num_lines_added": 34, "num_lines_removed": 16}