{"hash": "aa79b6b74cc5358ace954eda9d3db2609344228b", "message": "Protect critical init and shutdown sections with mutex\n\ngit-svn-id: https://svn.apache.org/repos/asf/httpcomponents/httpcore/trunk@744487 13f79535-47bb-0310-9956-ffa450edef68", "file_num_lines": 310, "diff_parsed": {"added": [[116, "    private final Object statusLock;"], [150, "        this.statusLock = new Object();"], [272, "        synchronized (this.statusLock) {"], [273, "            if (this.status.compareTo(IOReactorStatus.SHUTDOWN_REQUEST) >= 0) {"], [274, "                this.status = IOReactorStatus.SHUT_DOWN;"], [275, "                this.statusLock.notifyAll();"], [276, "                return;"], [277, "            }"], [278, "            if (this.status.compareTo(IOReactorStatus.INACTIVE) != 0) {"], [279, "                throw new IllegalStateException(\"Illegal state: \" + this.status);"], [280, "            }"], [281, "            this.status = IOReactorStatus.ACTIVE;"], [282, "            // Start I/O dispatchers"], [283, "            for (int i = 0; i < this.dispatchers.length; i++) {"], [284, "                BaseIOReactor dispatcher = new BaseIOReactor(this.selectTimeout);"], [285, "                dispatcher.setExceptionHandler(exceptionHandler);"], [286, "                this.dispatchers[i] = dispatcher;"], [287, "            }"], [288, "            for (int i = 0; i < this.workerCount; i++) {"], [289, "                BaseIOReactor dispatcher = this.dispatchers[i];"], [290, "                this.workers[i] = new Worker(dispatcher, eventDispatch);"], [291, "                this.threads[i] = this.threadFactory.newThread(this.workers[i]);"], [292, "            }"], [340, "            synchronized (this.statusLock) {"], [341, "                doShutdown();"], [342, "                this.status = IOReactorStatus.SHUT_DOWN;"], [343, "                this.statusLock.notifyAll();"], [344, "            }"], [507, "        synchronized (this.statusLock) {"], [511, "                this.statusLock.wait(remaining);"], [527, "        synchronized (this.statusLock) {"], [528, "            if (this.status.compareTo(IOReactorStatus.ACTIVE) > 0) {"], [529, "                return;"], [530, "            }"], [531, "            this.status = IOReactorStatus.SHUTDOWN_REQUEST;"], [532, "            this.selector.wakeup();"], [533, "            try {"], [534, "                awaitShutdown(waitMs);"], [535, "            } catch (InterruptedException ignore) {"], [536, "            }"]], "deleted": [[116, "    private final Object shutdownMutex;"], [150, "        this.shutdownMutex = new Object();"], [272, ""], [273, "        this.status = IOReactorStatus.ACTIVE;"], [274, ""], [275, "        // Start I/O dispatchers"], [276, "        for (int i = 0; i < this.dispatchers.length; i++) {"], [277, "            BaseIOReactor dispatcher = new BaseIOReactor(this.selectTimeout);"], [278, "            dispatcher.setExceptionHandler(exceptionHandler);"], [279, "            this.dispatchers[i] = dispatcher;"], [280, "        }"], [281, "        for (int i = 0; i < this.workerCount; i++) {"], [282, "            BaseIOReactor dispatcher = this.dispatchers[i];"], [283, "            this.workers[i] = new Worker(dispatcher, eventDispatch);"], [284, "            this.threads[i] = this.threadFactory.newThread(this.workers[i]);"], [332, "            doShutdown();"], [423, "        } finally {"], [424, "            synchronized (this.shutdownMutex) {"], [425, "                this.status = IOReactorStatus.SHUT_DOWN;"], [426, "                this.shutdownMutex.notifyAll();"], [427, "            }"], [500, "        synchronized (this.shutdownMutex) {"], [504, "                this.shutdownMutex.wait(remaining);"], [520, "        if (this.status != IOReactorStatus.ACTIVE) {"], [521, "            return;"], [522, "        }"], [523, "        this.status = IOReactorStatus.SHUTDOWN_REQUEST;"], [524, "        this.selector.wakeup();"], [525, "        try {"], [526, "            awaitShutdown(waitMs);"], [527, "        } catch (InterruptedException ignore) {"]]}, "num_lines_added": 40, "num_lines_removed": 31}