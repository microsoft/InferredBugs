{"hash": "c8445f35343a7437f6f3be9a2f45f1607c541e22", "message": "Adding a retry in the rpcThrottler. (#1069)\n\n* Adding a retry in the rpcThrottler.\r\n\r\n* Adding performRetryIfStale to RpcHandler.awaitCompletion.\r\n\r\n* Adding more defensive coding to BulkMutation,\r\nintegrating performRetryIfStale into RpcThrottler.awaitCompletion().\r\n\r\n* Simplifying BulkMutation.Batch.createRetryHandler()", "file_num_lines": 157, "diff_parsed": {"added": [[26, "import java.util.HashMap;"], [28, "import java.util.Map;"], [47, "  public static interface RetryHandler {"], [48, "    void performRetryIfStale();"], [49, "  }"], [50, ""], [63, "  private Map<Long, RetryHandler> outstandingRetries = new HashMap<>();"], [65, "  private long noSuccessCheckDeadlineNanos;"], [140, "  public <T> long registerRetry(RetryHandler handler) {"], [145, "      outstandingRetries.put(id, handler);"], [166, "        if (now >= noSuccessCheckDeadlineNanos) {"], [167, "          // There are unusual cases where an RPC could be completed, but we don't clean up"], [168, "          // the state and the locks.  Try to clean up if there is a timeout."], [169, "          for (RetryHandler retryHandler : outstandingRetries.values()) {"], [170, "            retryHandler.performRetryIfStale();"], [171, "          }"], [186, "    long lastUpdateNanos = now - noSuccessCheckDeadlineNanos + INTERVAL_NO_SUCCESS_WARNING_NANOS;"], [223, "    noSuccessCheckDeadlineNanos = clock.nanoTime() + INTERVAL_NO_SUCCESS_WARNING_NANOS;"]], "deleted": [[57, "  private Set<Long> outstandingRetries = new HashSet<>();"], [59, "  private long noSuccessWarningDeadlineNanos;"], [134, "  public <T> long registerRetry() {"], [139, "      outstandingRetries.add(id);"], [160, "        if (now >= noSuccessWarningDeadlineNanos) {"], [175, "    long lastUpdateNanos = now - noSuccessWarningDeadlineNanos + INTERVAL_NO_SUCCESS_WARNING_NANOS;"], [212, "    noSuccessWarningDeadlineNanos = clock.nanoTime() + INTERVAL_NO_SUCCESS_WARNING_NANOS;"]]}, "num_lines_added": 18, "num_lines_removed": 7}