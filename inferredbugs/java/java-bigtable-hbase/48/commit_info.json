{"hash": "a99282e9a6aa86f0a1948686306839c067d61d40", "message": "Enhancing Modify Table. (#1922)\n\n* Enhancing Modify Table.\r\n\r\n* Update TestModifyTable.java", "file_num_lines": 667, "diff_parsed": {"added": [[27, "import java.util.concurrent.CompletionException;"], [31, "import com.google.bigtable.admin.v2.GetTableRequest;"], [32, "import io.grpc.Status;"], [37, "import org.apache.hadoop.hbase.HTableDescriptor;"], [176, "    modifyColumns(tableName, columnFamilyDesc.getNameAsString(), \"add\", modification);"], [192, "    modifyColumns(tableName, columnFamilyDesc.getNameAsString(), \"update\", modification);"], [258, "    return modifyColumnsAsync(tableName, modification);"], [273, "    return modifyColumnsAsync(tableName, modification);"], [277, "  protected CompletableFuture<Void> modifyColumnsAsync(TableName tableName, Modification... modifications) {"], [278, "    ModifyColumnFamiliesRequest modifyColumnRequest = ModifyColumnFamiliesRequest"], [281, "        .setName(toBigtableName(tableName))"], [282, "        .build();"], [284, "        bigtableTableAdminClient.modifyColumnFamilyAsync(modifyColumnRequest))"], [364, "    return modifyColumnsAsync(tableName, modification);"], [374, "    super.modifyTable(tableName, new HTableDescriptor(tableDescriptor));"], [378, "  public Future<Void> modifyTableAsync(TableDescriptor tableDescriptor)"], [379, "      throws IOException {"], [380, "    return modifyTableAsync(tableDescriptor.getTableName(), tableDescriptor);"], [384, "  public Future<Void> modifyTableAsync(TableName tableName, TableDescriptor newDescriptor) {"], [385, "    return getDescriptorAsync(tableName).thenApply(descriptor -> tableModificationAdapter"], [386, "        .buildModifications(new HTableDescriptor(newDescriptor), new HTableDescriptor(descriptor)))"], [387, "        .thenApply(modifications -> {"], [388, "          try {"], [389, "            return modifyColumns(tableName, null, \"modifyTableAsync\", modifications);"], [390, "          } catch (IOException e) {"], [391, "            throw new CompletionException(e);"], [392, "          }"], [393, "        });"], [394, "  }"], [395, ""], [396, "  private CompletableFuture<TableDescriptor> getDescriptorAsync(TableName tableName) {"], [397, "    if (tableName == null) {"], [398, "      return CompletableFuture.completedFuture(null);"], [399, "    }"], [400, ""], [401, "    GetTableRequest request = GetTableRequest"], [402, "        .newBuilder()"], [403, "        .setName(bigtableInstanceName.toTableNameStr(tableName.getNameAsString()))"], [404, "        .build();"], [405, ""], [406, "    ListenableFuture<Table> tableFuture = bigtableTableAdminClient.getTableAsync(request);"], [407, "    return FutureUtils.toCompletableFuture(tableFuture).handle((resp, ex) -> {"], [408, "      if (ex != null) {"], [409, "        if (Status.fromThrowable(ex).getCode() == Status.Code.NOT_FOUND) {"], [410, "          throw new CompletionException(new TableNotFoundException(tableName));"], [411, "        } else {"], [412, "          throw new CompletionException(ex);"], [413, "        }"], [414, "      } else {"], [415, "        return tableAdapter2x.adapt(resp);"], [416, "      }"], [417, "    });"]], "deleted": [[33, "import org.apache.hadoop.hbase.HColumnDescriptor;"], [173, "    modifyColumn(tableName, columnFamilyDesc.getNameAsString(), \"add\", modification);"], [189, "    modifyColumn(tableName, columnFamilyDesc.getNameAsString(), \"update\", modification);"], [255, "    return modifyColumnAsync(tableName, modification);"], [270, "    return modifyColumnAsync(tableName, modification);"], [274, "  protected CompletableFuture<Void> modifyColumnAsync(TableName tableName, Modification... modifications) {"], [275, "    ModifyColumnFamiliesRequest.Builder modifyColumnBuilder = ModifyColumnFamiliesRequest"], [278, "        .setName(toBigtableName(tableName));"], [280, "        bigtableTableAdminClient.modifyColumnFamilyAsync(modifyColumnBuilder.build()))"], [360, "    return modifyColumnAsync(tableName, modification);"], [370, "    if (isTableAvailable(tableName)) {"], [371, "      TableDescriptor currentTableDescriptor = getTableDescriptor(tableName);"], [372, "      List<Modification> modifications = new ArrayList<>();"], [373, "      List<HColumnDescriptor> columnDescriptors = tableAdapter2x.toHColumnDescriptors(tableDescriptor);"], [374, "      List<HColumnDescriptor> currentColumnDescriptors = tableAdapter2x.toHColumnDescriptors(currentTableDescriptor);"], [375, "      modifications.addAll(tableModificationAdapter.buildModifications(columnDescriptors, currentColumnDescriptors));"], [376, "      modifyColumn(tableName, \"modifyTable\", \"update\", (Modification[]) modifications.toArray());"], [377, "    } else {"], [378, "      throw new TableNotFoundException(tableName);"], [379, "    }"], [383, "  public Future<Void> modifyTableAsync(TableDescriptor arg0) throws IOException {"], [384, "    // TODO - implementable with async hbase2"], [385, "    throw new UnsupportedOperationException(\"modifyTableAsync\");"], [389, "  public Future<Void> modifyTableAsync(TableName arg0, TableDescriptor arg1) throws IOException {"], [390, "    // TODO - implementable with async hbase2"], [391, "    throw new UnsupportedOperationException(\"modifyTableAsync\");"]]}, "num_lines_added": 52, "num_lines_removed": 26}