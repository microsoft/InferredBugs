{"hash": "886483728f0376dea748258348273b214382b535", "message": "PHOENIX-2239 Improve strict mode in psql CSV load\n\nEnforce strict mode when individual rows can't be parsed or\nupserted.", "file_num_lines": 626, "diff_parsed": {"added": [[35, "import com.google.common.collect.ImmutableList;"], [40, "import org.apache.phoenix.schema.IllegalDataException;"], [408, "    // Ensure that strict mode also causes the import to stop if a data type on a single"], [409, "    // row is not correct"], [410, "    @Test"], [411, "    public void testCSVUpsertWithInvalidNumericalData_StrictMode() throws Exception {"], [412, "        CSVParser parser = null;"], [413, "        PhoenixConnection conn = null;"], [414, "        try {"], [415, "            // Create table"], [416, "            String statements = \"CREATE TABLE IF NOT EXISTS \" + STOCK_TABLE"], [417, "                    + \"(SYMBOL VARCHAR NOT NULL PRIMARY KEY, COMPANY_ID BIGINT);\";"], [418, "            conn = DriverManager.getConnection(getUrl())"], [419, "                    .unwrap(PhoenixConnection.class);"], [420, "            PhoenixRuntime.executeStatements(conn,"], [421, "                    new StringReader(statements), null);"], [422, ""], [423, "            // Upsert CSV file in strict mode"], [424, "            CSVCommonsLoader csvUtil = new CSVCommonsLoader(conn, STOCK_TABLE,"], [425, "                    Arrays.asList(\"SYMBOL\", \"COMPANY_ID\"), true);"], [426, "            try {"], [427, "                csvUtil.upsert(new StringReader(STOCK_CSV_VALUES));"], [428, "                fail(\"Running an upsert with data that can't be upserted in strict mode \""], [429, "                        + \"should throw an exception\");"], [430, "            } catch (IllegalDataException e) {"], [431, "                // Expected"], [432, "            }"], [433, ""], [434, "        } finally {"], [435, "            if (parser != null)"], [436, "                parser.close();"], [437, "            if (conn != null)"], [438, "                conn.close();"], [439, "        }"], [440, "    }"], [441, ""], [670, "                    ImmutableList.<String>of(), true, ',', '\"', null, \"!\");"], [709, "                    ImmutableList.<String>of(), true, ',', '\"', null, \"!\");"]], "deleted": [[634, "                    null, true, ',', '\"', null, \"!\");"], [673, "                    null, true, ',', '\"', null, \"!\");"]]}, "num_lines_added": 38, "num_lines_removed": 2}