{"hash": "9224fa3f45a70392d1b244c080bf41bd561470d3", "message": "FAB-7702 GetConfigBlock\n\nChange-Id: I8426196731995c514e729e217e054d8358813c7f\nSigned-off-by: rickr <cr22rc@gmail.com>", "file_num_lines": 2216, "diff_parsed": {"added": [[104, "import org.hyperledger.fabric.sdk.transaction.GetConfigBlockBuilder;"], [718, "    private Block getConfigBlock(Peer peer) throws ProposalException {"], [719, ""], [720, "        logger.debug(format(\"getConfigBlock for channel %s with peer %s, url: %s\", name, peer.getName(), peer.getUrl()));"], [721, ""], [722, "        if (shutdown) {"], [723, "            throw new ProposalException(format(\"Channel %s has been shutdown.\", name));"], [724, "        }"], [725, ""], [726, "        try {"], [727, ""], [728, "            final Channel systemChannel = newSystemChannel(client); //needs to be invoked on system channel"], [729, ""], [730, "            TransactionContext transactionContext = systemChannel.getTransactionContext();"], [731, ""], [732, "            FabricProposal.Proposal proposal = GetConfigBlockBuilder.newBuilder()"], [733, "                    .context(transactionContext)"], [734, "                    .channelId(name)"], [735, "                    .build();"], [736, ""], [737, "            logger.debug(\"Getting signed proposal.\");"], [738, "            SignedProposal signedProposal = getSignedProposal(transactionContext, proposal);"], [739, "            logger.debug(\"Got signed proposal.\");"], [740, ""], [741, "            Collection<ProposalResponse> resp = sendProposalToPeers(new ArrayList<>(Collections.singletonList(peer)),"], [742, "                    signedProposal, transactionContext);"], [743, ""], [744, "            ProposalResponse pro = resp.iterator().next();"], [745, ""], [746, "            if (pro.getStatus() == ProposalResponse.Status.SUCCESS) {"], [747, "                logger.trace(format(\"getConfigBlock from peer %s on channel %s success\", peer.getName(), name));"], [748, "                return Block.parseFrom(pro.getProposalResponse().getResponse().getPayload().toByteArray());"], [749, "            } else {"], [750, "                throw new ProposalException(format(\"getConfigBlock for channel %s failed with peer %s.  Status %s, details: %s\","], [751, "                        name, peer.getName(), pro.getStatus().toString(), pro.getMessage()));"], [752, ""], [753, "            }"], [754, "        } catch (ProposalException e) {"], [755, "            logger.error(format(\"getConfigBlock for channel %s failed with peer %s.\", name, peer.getName()), e);"], [756, "            throw e;"], [757, "        } catch (Exception e) {"], [758, "            logger.error(format(\"getConfigBlock for channel %s failed with peer %s.\", name, peer.getName()), e);"], [759, "            throw new ProposalException(e.getMessage(), e);"], [760, "        }"], [761, ""], [762, "    }"], [763, ""], [1150, "            Block parseFrom = getConfigBlock(getRandomPeer());"], [1151, ""], [1152, "            // final Block configBlock = getConfigurationBlock();"], [1156, "            Envelope envelope = Envelope.parseFrom(parseFrom.getData().getData(0));"], [1266, "            final Block configBlock = getConfigBlock(getRandomPeer());"], [1746, "    private Peer getRandomPeer() throws InvalidArgumentException {"], [1747, ""], [1748, "        final ArrayList<Peer> randPicks = new ArrayList<>(getPeers()); //copy to avoid unlikely changes"], [1749, ""], [1750, "        if (randPicks.isEmpty()) {"], [1751, "            throw new InvalidArgumentException(\"Channel \" + name + \" does not have any peers associated with it.\");"], [1752, "        }"], [1753, ""], [1754, "        return randPicks.get(RANDOM.nextInt(randPicks.size()));"], [1755, "    }"], [1756, ""]], "deleted": [[1103, "            final Block configBlock = getConfigurationBlock();"], [1107, "            Envelope envelope = Envelope.parseFrom(configBlock.getData().getData(0));"], [1117, "        } catch (TransactionException e) {"], [1118, "            logger.error(e.getMessage(), e);"], [1119, "            throw e;"], [1220, "            final Block configBlock = getConfigurationBlock();"]]}, "num_lines_added": 63, "num_lines_removed": 6}