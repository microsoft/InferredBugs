{"hash": "db22412bad0d036e485aac168548209a936f597c", "message": "FABJ-448 Provide access to system channel configuration\n\nChange-Id: I7b03fa702096b35af36c3808b1a342d99f31b163\nSigned-off-by: rickr <cr22rc@gmail.com>", "file_num_lines": 4271, "diff_parsed": {"added": [[254, "            sendUpdateChannel(client.getUserContext(), configUpdate.toByteArray(), signers, orderer);"], [396, "     * Update channel with specified channel configuration."], [398, "     * <P></P>Note This is not a thread safe operation"], [407, "        updateChannelConfiguration(client.getUserContext(), updateChannelConfiguration, getRandomOrderer(), signers);"], [413, "     * <P></P>Note This is not a thread safe operation"], [423, "        updateChannelConfiguration(client.getUserContext(), updateChannelConfiguration, orderer, signers);"], [424, "    }"], [425, ""], [426, "    /**"], [427, "     * Update channel with specified channel configuration"], [428, "     *"], [429, "     * @param userContext                The specific user to use."], [430, "     * @param updateChannelConfiguration Channel configuration"], [431, "     * @param signers                    signers"], [432, "     * @param orderer                    The specific orderer to use."], [433, "     * @throws TransactionException"], [434, "     * @throws InvalidArgumentException"], [435, "     */"], [436, ""], [437, "    public void updateChannelConfiguration(User userContext, UpdateChannelConfiguration updateChannelConfiguration, Orderer orderer, byte[]... signers) throws TransactionException, InvalidArgumentException {"], [443, "        User.userContextCheck(userContext);"], [444, ""], [446, "            final long startLastConfigIndex = getLastConfigIndex(getTransactionContext(userContext), orderer);"], [450, "            sendUpdateChannel(userContext, updateChannelConfiguration.getUpdateChannelConfigurationAsBytes(), signers, orderer);"], [457, "                currentLastConfigIndex = getLastConfigIndex(getTransactionContext(userContext), orderer);"], [496, "    private void sendUpdateChannel(User userContext, byte[] configupdate, byte[][] signers, Orderer orderer) throws TransactionException, InvalidArgumentException {"], [509, "                TransactionContext transactionContext = getTransactionContext(userContext);"], [912, "    private Block getConfigBlock(List<Peer> peers) throws ProposalException, InvalidArgumentException {"], [913, "        return getConfigBlock(getTransactionContext(), peers);"], [914, "    }"], [915, ""], [916, "    private Block getConfigBlock(TransactionContext transactionContext, List<Peer> peers) throws ProposalException {"], [928, ""], [955, "                        logger.trace(format(\"getConfigBlock from peer %s on channel %s success\", peer, name));"], [1223, "        if (peers.isEmpty()) {"], [1224, "            logger.warn(format(\"Channel %s has no peers during initialization.\", name));"], [1225, ""], [1226, "        } else {"], [1227, "            try {"], [1228, "                loadCACertificates(false);  // put all MSP certs into cryptoSuite if this fails here we'll try again later."], [1229, "            } catch (Exception e) {"], [1230, "                logger.warn(format(\"Channel %s could not load peer CA certificates from any peers.\", name));"], [1231, "            }"], [1853, "                seekBlock(getTransactionContext(), seekInfo, deliverResponses, orderer);"], [2363, "     * @param orderer"], [2368, "    private Block getConfigurationBlock(TransactionContext transactionContext, Orderer orderer) throws TransactionException {"], [2374, "            long lastConfigIndex = getLastConfigIndex(transactionContext, orderer);"], [2378, "            Block configBlock = getBlockByNumber(transactionContext, orderer, lastConfigIndex);"], [2446, "     * Get channel configuration from a specific Orderer"], [2447, "     *"], [2448, "     * @param userContext The user to sign the action."], [2449, "     * @param orderer     To retrieve the configuration from."], [2450, "     * @return Configuration block."], [2451, "     * @throws InvalidArgumentException"], [2452, "     * @throws TransactionException"], [2453, "     */"], [2454, ""], [2455, "    public byte[] getChannelConfigurationBytes(User userContext, Orderer orderer) throws InvalidArgumentException, TransactionException {"], [2456, ""], [2457, "        try {"], [2458, "            Block configBlock = getConfigurationBlock(getTransactionContext(userContext), orderer);"], [2459, ""], [2460, "            Envelope envelopeRet = Envelope.parseFrom(configBlock.getData().getData(0));"], [2461, ""], [2462, "            Payload payload = Payload.parseFrom(envelopeRet.getPayload());"], [2463, ""], [2464, "            ConfigEnvelope configEnvelope = ConfigEnvelope.parseFrom(payload.getData());"], [2465, "            return configEnvelope.getConfig().toByteArray();"], [2466, ""], [2467, "        } catch (Exception e) {"], [2468, "            throw new TransactionException(e);"], [2469, "        }"], [2470, ""], [2471, "    }"], [2472, ""], [2473, "    /**"], [2474, "     * Get channel configuration from a specific peer"], [2475, "     *"], [2476, "     * @param userContext The user to sign the action."], [2477, "     * @param peer        To retrieve the configuration from."], [2478, "     * @return Configuration block."], [2479, "     * @throws InvalidArgumentException"], [2480, "     * @throws TransactionException"], [2481, "     */"], [2482, ""], [2483, "    public byte[] getChannelConfigurationBytes(User userContext, Peer peer) throws InvalidArgumentException, TransactionException {"], [2484, ""], [2485, "        try {"], [2486, "            Block configBlock = getConfigBlock(getTransactionContext(userContext), Arrays.asList(peer));"], [2487, ""], [2488, "            Envelope envelopeRet = Envelope.parseFrom(configBlock.getData().getData(0));"], [2489, ""], [2490, "            Payload payload = Payload.parseFrom(envelopeRet.getPayload());"], [2491, ""], [2492, "            ConfigEnvelope configEnvelope = ConfigEnvelope.parseFrom(payload.getData());"], [2493, "            return configEnvelope.getConfig().toByteArray();"], [2494, ""], [2495, "        } catch (Exception e) {"], [2496, "            throw new TransactionException(e);"], [2497, "        }"], [2498, ""], [2499, "    }"], [2500, ""], [2501, "    public byte[] getChannelConfigurationBytes() throws InvalidArgumentException, TransactionException {"], [2502, "        return getChannelConfigurationBytes(client.getUserContext());"], [2503, "    }"], [2504, ""], [2505, "    /**"], [2507, "     * If Peers exist on the channel config block will be retrieved from them."], [2508, "     * If only Orderers exist the configblock is retrieved from them."], [2521, "    public byte[] getChannelConfigurationBytes(User userContext) throws InvalidArgumentException, TransactionException {"], [2522, "        Block configBlock = null;"], [2524, ""], [2525, "            Collection<Peer> peers = getShuffledPeers();"], [2526, ""], [2527, "            if (!peers.isEmpty()) { // prefer peers."], [2528, "                configBlock = getConfigBlock(getTransactionContext(userContext), new ArrayList<>(peers));"], [2529, ""], [2530, "            } else { // no peers so look to orderers."], [2531, ""], [2532, "                List<Orderer> shuffledOrderers = getShuffledOrderers();"], [2533, "                if (shuffledOrderers.isEmpty()) {"], [2534, "                    throw new InvalidArgumentException(format(\"Channel %s has no peer or orderers defined. Can not get configuration block\", name));"], [2535, "                }"], [2536, "                StringBuilder sb = new StringBuilder(1000);"], [2537, "                Exception fe = null;"], [2538, "                String sep = \"\";"], [2539, "                for (Orderer orderer : shuffledOrderers) {"], [2540, "                    try {"], [2541, "                        configBlock = getConfigurationBlock(getTransactionContext(userContext), orderer);"], [2542, "                        fe = null; // looks good."], [2543, "                        break;"], [2544, "                    } catch (Exception e) {"], [2545, "                        fe = e;"], [2546, "                        sb.append(sep).append(orderer.toString()).append(\"-\").append(e.getMessage());"], [2547, "                        sep = \", \";"], [2548, ""], [2549, "                    }"], [2550, ""], [2551, "                }"], [2552, "                if (fe != null) {"], [2553, "                    throw new TransactionException(sb.toString(), fe);"], [2554, "                }"], [2555, ""], [2556, "            }"], [2557, "            if (configBlock == null) {"], [2558, "                throw new TransactionException(\"Transaction block could not be retrieved.\");"], [2559, "            }"], [2574, "    private long getLastConfigIndex(TransactionContext transactionContext, Orderer orderer) throws TransactionException, InvalidProtocolBufferException {"], [2575, "        Block latestBlock;"], [2576, "        latestBlock = getLatestBlock(orderer, transactionContext);"], [2587, "    private Block getBlockByNumber(TransactionContext transactionContext, Orderer orderer, final long number) throws TransactionException {"], [2609, "            seekBlock(transactionContext, seekInfo, deliverResponses, orderer);"], [2638, "    private int seekBlock(TransactionContext txContext, SeekInfo seekInfo, List<DeliverResponse> deliverResponses, Orderer ordererIn) throws TransactionException {"], [2713, "    private Block getLatestBlock(Orderer orderer, TransactionContext transactionContext) throws TransactionException {"], [2729, "        seekBlock(transactionContext, seekInfo, deliverResponses, orderer);"], [3105, "    private List<Orderer> getShuffledOrderers() {"], [3106, ""], [3107, "        ArrayList<Orderer> orderers = new ArrayList<>(getOrderers());"], [3108, "        Collections.shuffle(orderers);"], [3109, "        return orderers;"], [3110, "    }"], [3111, ""]], "deleted": [[254, "            sendUpdateChannel(configUpdate.toByteArray(), signers, orderer);"], [396, "     * Update channel with specified channel configuration"], [406, "        updateChannelConfiguration(updateChannelConfiguration, getRandomOrderer(), signers);"], [427, "            final long startLastConfigIndex = getLastConfigIndex(orderer);"], [431, "            sendUpdateChannel(updateChannelConfiguration.getUpdateChannelConfigurationAsBytes(), signers, orderer);"], [438, "                currentLastConfigIndex = getLastConfigIndex(orderer);"], [477, "    private void sendUpdateChannel(byte[] configupdate, byte[][] signers, Orderer orderer) throws TransactionException, InvalidArgumentException {"], [490, "                TransactionContext transactionContext = getTransactionContext();"], [893, "    private Block getConfigBlock(List<Peer> peers) throws ProposalException {"], [903, "        TransactionContext transactionContext = null;"], [906, "            transactionContext = getTransactionContext();"], [933, "                        logger.trace(format(\"getConfigBlock from peer %s on channel %s success\", peer.getName(), name));"], [1201, "        try {"], [1202, "            loadCACertificates(false);  // put all MSP certs into cryptoSuite if this fails here we'll try again later."], [1203, "        } catch (Exception e) {"], [1204, "            logger.warn(format(\"Channel %s could not load peer CA certificates from any peers.\", name));"], [1826, "                seekBlock(seekInfo, deliverResponses, orderer);"], [2340, "    private Block getConfigurationBlock() throws TransactionException {"], [2345, "            Orderer orderer = getRandomOrderer();"], [2347, "            long lastConfigIndex = getLastConfigIndex(orderer);"], [2351, "            Block configBlock = getBlockByNumber(lastConfigIndex);"], [2432, "    public byte[] getChannelConfigurationBytes() throws TransactionException {"], [2434, "            final Block configBlock = getConfigBlock(getShuffledPeers());"], [2449, "    private long getLastConfigIndex(Orderer orderer) throws TransactionException, InvalidProtocolBufferException {"], [2450, "        Block latestBlock = getLatestBlock(orderer);"], [2461, "    private Block getBlockByNumber(final long number) throws TransactionException {"], [2483, "            seekBlock(seekInfo, deliverResponses, getRandomOrderer());"], [2512, "    private int seekBlock(SeekInfo seekInfo, List<DeliverResponse> deliverResponses, Orderer ordererIn) throws TransactionException {"], [2527, "                TransactionContext txContext = getTransactionContext();"], [2528, ""], [2589, "    private Block getLatestBlock(Orderer orderer) throws TransactionException {"], [2605, "        seekBlock(seekInfo, deliverResponses, orderer);"]]}, "num_lines_added": 163, "num_lines_removed": 32}