{"hash": "a8eec7b96a92fe86f1025662abc6ca73951f3074", "message": "Fix unexpected provider operation cause by unordered zookeeper event. (#308)", "file_num_lines": 459, "diff_parsed": {"added": [[54, "import static com.alipay.sofa.rpc.registry.zk.ZookeeperRegistryHelper.buildConfigPath;"], [55, "import static com.alipay.sofa.rpc.registry.zk.ZookeeperRegistryHelper.buildConsumerPath;"], [56, "import static com.alipay.sofa.rpc.registry.zk.ZookeeperRegistryHelper.buildOverridePath;"], [57, "import static com.alipay.sofa.rpc.registry.zk.ZookeeperRegistryHelper.buildProviderPath;"], [166, "     * \u670d\u52a1\u5217\u8868\u89c2\u5bdf\u8005"], [238, "        closePathChildrenCache(INTERFACE_CONFIG_CACHE);"], [239, "        closePathChildrenCache(INTERFACE_OVERRIDE_CACHE);"], [255, "     * \u63a5\u53e3\u914d\u7f6e{ConsumerConfig\uff1aPathChildrenCache} <br>"], [256, "     * \u4f8b\u5982\uff1a{ConsumerConfig \uff1a PathChildrenCache }"], [257, "     */"], [258, "    private static final ConcurrentMap<ConsumerConfig, PathChildrenCache> INTERFACE_PROVIDER_CACHE = new ConcurrentHashMap<ConsumerConfig, PathChildrenCache>();"], [259, ""], [260, "    /**"], [264, "    private static final ConcurrentMap<String, PathChildrenCache>         INTERFACE_CONFIG_CACHE   = new ConcurrentHashMap<String, PathChildrenCache>();"], [270, "    private static final ConcurrentMap<String, PathChildrenCache>         INTERFACE_OVERRIDE_CACHE = new ConcurrentHashMap<String, PathChildrenCache>();"], [511, "                PathChildrenCache pathChildrenCache = INTERFACE_PROVIDER_CACHE.get(config);"], [512, "                if (pathChildrenCache == null) {"], [513, "                    // \u76d1\u542c\u914d\u7f6e\u8282\u70b9\u4e0b \u5b50\u8282\u70b9\u589e\u52a0\u3001\u5b50\u8282\u70b9\u5220\u9664\u3001\u5b50\u8282\u70b9Data\u4fee\u6539\u4e8b\u4ef6"], [514, "                    ProviderInfoListener providerInfoListener = config.getProviderInfoListener();"], [515, "                    providerObserver.addProviderListener(config, providerInfoListener);"], [516, "                    // TODO \u6362\u6210\u76d1\u542c\u7236\u8282\u70b9\u53d8\u5316\uff08\u53ea\u662f\u76d1\u542c\u53d8\u5316\u4e86\uff0c\u800c\u4e0d\u901a\u77e5\u53d8\u5316\u4e86\u4ec0\u4e48\uff0c\u7136\u540e\u5ba2\u6237\u7aef\u81ea\u5df1\u6765\u62c9\u6570\u636e\u7684\uff09"], [517, "                    pathChildrenCache = new PathChildrenCache(zkClient, providerPath, true);"], [518, "                    final PathChildrenCache finalPathChildrenCache = pathChildrenCache;"], [519, "                    pathChildrenCache.getListenable().addListener(new PathChildrenCacheListener() {"], [520, "                        @Override"], [521, "                        public void childEvent(CuratorFramework client1, PathChildrenCacheEvent event) throws Exception {"], [522, "                            if (LOGGER.isDebugEnabled(config.getAppName())) {"], [523, "                                LOGGER.debugWithApp(config.getAppName(),"], [524, "                                    \"Receive zookeeper event: \" + \"type=[\" + event.getType() + \"]\");"], [525, "                            }"], [526, "                            switch (event.getType()) {"], [527, "                                case CHILD_ADDED: //\u52a0\u4e86\u4e00\u4e2aprovider"], [528, "                                    providerObserver.addProvider(config, providerPath, event.getData(),"], [529, "                                        finalPathChildrenCache.getCurrentData());"], [530, "                                    break;"], [531, "                                case CHILD_REMOVED: //\u5220\u4e86\u4e00\u4e2aprovider"], [532, "                                    providerObserver.removeProvider(config, providerPath, event.getData(),"], [533, "                                        finalPathChildrenCache.getCurrentData());"], [534, "                                    break;"], [535, "                                case CHILD_UPDATED: // \u66f4\u65b0\u4e00\u4e2aProvider"], [536, "                                    providerObserver.updateProvider(config, providerPath, event.getData(),"], [537, "                                        finalPathChildrenCache.getCurrentData());"], [538, "                                    break;"], [539, "                                default:"], [540, "                                    break;"], [541, "                            }"], [543, "                    });"], [544, "                    pathChildrenCache.start(PathChildrenCache.StartMode.BUILD_INITIAL_CACHE);"], [545, "                    INTERFACE_PROVIDER_CACHE.put(config, pathChildrenCache);"], [546, "                }"], [592, "            PathChildrenCache childrenCache = INTERFACE_PROVIDER_CACHE.remove(config);"], [593, "            if (childrenCache != null) {"], [594, "                try {"], [595, "                    childrenCache.close();"], [596, "                } catch (Exception e) {"], [597, "                    if (!RpcRunningState.isShuttingDown()) {"], [598, "                        throw new SofaRpcRuntimeException("], [599, "                            \"Failed to unsubscribe consumer config from zookeeperRegistry!\", e);"], [600, "                    }"], [601, "                }"], [602, "            }"], [628, "     * @param config consumer config"], [641, ""], [642, "    private void closePathChildrenCache(Map<String, PathChildrenCache> map) {"], [643, "        for (Map.Entry<String, PathChildrenCache> entry : map.entrySet()) {"], [644, "            try {"], [645, "                entry.getValue().close();"], [646, "            } catch (Exception e) {"], [647, "                LOGGER.error(\"Close PathChildrenCache error!\", e);"], [648, "            }"], [649, "        }"], [650, "    }"]], "deleted": [[54, "import static com.alipay.sofa.rpc.registry.zk.ZookeeperRegistryHelper.*;"], [163, "     * \u914d\u7f6e\u9879\u89c2\u5bdf\u8005"], [253, "    private static final ConcurrentMap<String, PathChildrenCache> INTERFACE_CONFIG_CACHE   = new ConcurrentHashMap<String, PathChildrenCache>();"], [259, "    private static final ConcurrentMap<String, PathChildrenCache> INTERFACE_OVERRIDE_CACHE = new ConcurrentHashMap<String, PathChildrenCache>();"], [500, "                // \u76d1\u542c\u914d\u7f6e\u8282\u70b9\u4e0b \u5b50\u8282\u70b9\u589e\u52a0\u3001\u5b50\u8282\u70b9\u5220\u9664\u3001\u5b50\u8282\u70b9Data\u4fee\u6539\u4e8b\u4ef6"], [501, "                ProviderInfoListener providerInfoListener = config.getProviderInfoListener();"], [502, "                providerObserver.addProviderListener(config, providerInfoListener);"], [503, "                // TODO \u6362\u6210\u76d1\u542c\u7236\u8282\u70b9\u53d8\u5316\uff08\u53ea\u662f\u76d1\u542c\u53d8\u5316\u4e86\uff0c\u800c\u4e0d\u901a\u77e5\u53d8\u5316\u4e86\u4ec0\u4e48\uff0c\u7136\u540e\u5ba2\u6237\u7aef\u81ea\u5df1\u6765\u62c9\u6570\u636e\u7684\uff09"], [504, "                PathChildrenCache pathChildrenCache = new PathChildrenCache(zkClient, providerPath, true);"], [505, "                pathChildrenCache.getListenable().addListener(new PathChildrenCacheListener() {"], [506, "                    @Override"], [507, "                    public void childEvent(CuratorFramework client1, PathChildrenCacheEvent event) throws Exception {"], [508, "                        if (LOGGER.isDebugEnabled(config.getAppName())) {"], [509, "                            LOGGER.debugWithApp(config.getAppName(),"], [510, "                                \"Receive zookeeper event: \" + \"type=[\" + event.getType() + \"]\");"], [511, "                        }"], [512, "                        switch (event.getType()) {"], [513, "                            case CHILD_ADDED: //\u52a0\u4e86\u4e00\u4e2aprovider"], [514, "                                providerObserver.addProvider(config, providerPath, event.getData());"], [515, "                                break;"], [516, "                            case CHILD_REMOVED: //\u5220\u4e86\u4e00\u4e2aprovider"], [517, "                                providerObserver.removeProvider(config, providerPath, event.getData());"], [518, "                                break;"], [519, "                            case CHILD_UPDATED: // \u66f4\u65b0\u4e00\u4e2aProvider"], [520, "                                providerObserver.updateProvider(config, providerPath, event.getData());"], [521, "                                break;"], [522, "                            default:"], [523, "                                break;"], [525, "                    }"], [526, "                });"], [527, "                pathChildrenCache.start(PathChildrenCache.StartMode.BUILD_INITIAL_CACHE);"], [598, "     * @param config  consumer config"]]}, "num_lines_added": 72, "num_lines_removed": 32}