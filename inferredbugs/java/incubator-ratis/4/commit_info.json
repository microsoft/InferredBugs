{"hash": "741d8bd4fbb1c9642dd054e72cae0c7afb180170", "message": "RATIS-556 Detect node failures and close the log to prevent additional writes(Rajeshbabu)", "file_num_lines": 283, "diff_parsed": {"added": [[30, "import org.apache.ratis.protocol.RaftPeer;"], [49, "import static org.junit.Assert.*;"], [50, ""], [54, "    static List<LogServer> workers = null;"], [79, "        workers = cluster.getWorkers();"], [103, "    /**"], [104, "     * Test closing log any of the peer in ."], [105, "     * @throws IOException"], [106, "     */"], [107, "    @Test"], [108, "    public void testCloseLogOnNodeFailure() throws Exception {"], [109, "        boolean peerClosed = false;"], [110, "        try {"], [111, "            for(int i = 0; i < 5; i++) {"], [112, "                LogStream logStream1 = client.createLog(LogName.of(\"testCloseLogOnNodeFailure\"+i));"], [113, "                assertNotNull(logStream1);"], [114, "            }"], [115, "            assertTrue(((MetaStateMachine)cluster.getMasters().get(0).metaStateMachine).checkPeersAreSame());"], [116, "            workers.get(0).close();"], [117, "            peerClosed = true;"], [118, "            Thread.sleep(90000);"], [119, "            assertTrue(((MetaStateMachine)cluster.getMasters().get(0).metaStateMachine).checkPeersAreSame());"], [120, "            for(int i = 0; i < 5; i++) {"], [121, "                LogStream logStream2 = client.getLog(LogName.of(\"testCloseLogOnNodeFailure\"+i));"], [122, "                assertNotNull(logStream2);"], [123, "                assertEquals(State.CLOSED, logStream2.getState());"], [124, "            }"], [125, "        } finally {"], [126, "            if(peerClosed) {"], [127, "                // recreate the worker closed in the test."], [128, "                cluster.createWorkers(1);"], [129, "            }"], [130, "        }"], [131, "    }"]], "deleted": [[45, "import static org.junit.Assert.assertEquals;"], [46, "import static org.junit.Assert.assertNotNull;"], [47, "import static org.junit.Assert.assertNull;"], [48, "import static org.junit.Assert.fail;"], [49, ""], [80, "        List<LogServer> workers = cluster.getWorkers();"]]}, "num_lines_added": 34, "num_lines_removed": 6}