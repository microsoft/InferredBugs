{"hash": "4f5cab7c742ae12601928140a27f6de14e570164", "message": "Clean up in Operations Statistics\n\n\ngit-svn-id: http://hazelcast.googlecode.com/svn/trunk@1017 3f8e66b6-ca9d-11dd-a2b5-e5f827957e07", "file_num_lines": 59, "diff_parsed": {"added": [[28, "    long periodStart;"], [29, "    long periodEnd;"], [30, "    long numberOfPuts;"], [31, "    long numberOfGets;"], [32, "    long numberOfRemoves;"], [33, "    long numberOfOtherOperations;"], [36, "        out.writeLong(numberOfPuts);"], [37, "        out.writeLong(numberOfGets);"], [38, "        out.writeLong(numberOfRemoves);"], [39, "        out.writeLong(numberOfOtherOperations);"], [40, "        out.writeLong(periodStart);"], [41, "        out.writeLong(periodEnd);"], [45, "        numberOfPuts = in.readLong();"], [46, "        numberOfGets = in.readLong();"], [47, "        numberOfRemoves = in.readLong();"], [48, "        numberOfOtherOperations = in.readLong();"], [49, "        periodStart = in.readLong();"], [50, "        periodEnd = in.readLong();"], [54, "        return numberOfPuts + numberOfGets + numberOfRemoves + numberOfOtherOperations;"], [60, "                \", puts:\" + numberOfPuts +"], [61, "                \", gets:\" + numberOfGets +"], [62, "                \", removes:\" + numberOfRemoves +"], [63, "                \", others: \" + numberOfOtherOperations +"], [68, "        return periodStart;"], [72, "        return periodEnd;"], [76, "        return numberOfPuts;"], [80, "        return numberOfGets;"], [84, "        return numberOfRemoves;"], [85, "    }"], [86, ""], [87, "    public long getNumberOfOtherOperations() {"], [88, "        return numberOfOtherOperations;"]], "deleted": [[25, "import java.util.ArrayList;"], [26, "import java.util.List;"], [27, "import java.util.concurrent.atomic.AtomicLong;"], [30, "    private AtomicLong mapPuts = new AtomicLong();"], [31, "    private AtomicLong mapGets = new AtomicLong();"], [32, "    private AtomicLong mapRemoves = new AtomicLong();"], [33, "    private long startTime = now();"], [34, "    private long endTime = Long.MAX_VALUE;"], [35, "    private transient MapOperationStatsImpl published = null;"], [36, "    private List<MapOperationStatsImpl> listOfSubStats = new ArrayList<MapOperationStatsImpl>();"], [37, "    final private Object lock = new Object();"], [39, "    final private long interval;"], [40, ""], [41, "    public MapOperationStatsImpl() {"], [42, "        this(10000);"], [43, "    }"], [44, ""], [45, "    public MapOperationStatsImpl(long interval) {"], [46, "        this.interval = interval;"], [47, "    }"], [50, "        out.writeLong(mapPuts.get());"], [51, "        out.writeLong(mapGets.get());"], [52, "        out.writeLong(mapRemoves.get());"], [53, "        out.writeLong(startTime);"], [54, "        out.writeLong(endTime);"], [58, "        mapPuts.set(in.readLong());"], [59, "        mapGets.set(in.readLong());"], [60, "        mapRemoves.set(in.readLong());"], [61, "        startTime = in.readLong();"], [62, "        endTime = in.readLong();"], [63, "    }"], [64, ""], [65, "    private MapOperationStatsImpl getAndReset() {"], [66, "        long mapPutsNow = mapPuts.getAndSet(0);"], [67, "        long mapGetsNow = mapGets.getAndSet(0);"], [68, "        long mapRemovesNow = mapRemoves.getAndSet(0);"], [69, "        MapOperationStatsImpl newOne = new MapOperationStatsImpl();"], [70, "        newOne.mapPuts.set(mapPutsNow);"], [71, "        newOne.mapGets.set(mapGetsNow);"], [72, "        newOne.mapRemoves.set(mapRemovesNow);"], [73, "        newOne.startTime = this.startTime;"], [74, "        newOne.endTime = now();"], [75, "        this.startTime = newOne.endTime;"], [76, "        return newOne;"], [77, "    }"], [78, ""], [79, "    public MapOperationStatsImpl getPublishedStats() {"], [80, "        if (published == null) {"], [81, "            synchronized (lock) {"], [82, "                if (published == null) {"], [83, "                    published = getThis();"], [84, "                }"], [85, "            }"], [86, "        }"], [87, "        return published;"], [88, "    }"], [89, ""], [90, "    public void incrementPuts() {"], [91, "        mapPuts.incrementAndGet();"], [92, "        publishSubResult();"], [93, "    }"], [94, ""], [95, "    public void incrementGets() {"], [96, "        mapGets.incrementAndGet();"], [97, "        publishSubResult();"], [98, "    }"], [99, ""], [100, "    public void incrementRemoves() {"], [101, "        mapRemoves.incrementAndGet();"], [102, "        publishSubResult();"], [103, "    }"], [104, ""], [105, "    long now() {"], [106, "        return System.currentTimeMillis();"], [107, "    }"], [108, ""], [109, "    private void publishSubResult() {"], [110, "        long subInterval = interval / 10;"], [111, "        if (now() - startTime > subInterval) {"], [112, "            synchronized (lock) {"], [113, "                if (now() - startTime >= subInterval) {"], [114, "                    MapOperationStatsImpl copy = getAndReset();"], [115, "                    if (listOfSubStats.size() == 10) {"], [116, "                        listOfSubStats.remove(0);"], [117, "                    }"], [118, "                    listOfSubStats.add(copy);"], [119, "                    this.published = aggregate(listOfSubStats);"], [120, "                }"], [121, "            }"], [122, "        }"], [123, "    }"], [124, ""], [125, "    private MapOperationStatsImpl aggregate(List<MapOperationStatsImpl> list) {"], [126, "        MapOperationStatsImpl stats = new MapOperationStatsImpl();"], [127, "        stats.startTime = list.get(0).startTime;"], [128, "        for (int i = 0; i < list.size(); i++) {"], [129, "            MapOperationStatsImpl sub = list.get(i);"], [130, "            stats.mapGets.addAndGet(sub.mapGets.get());"], [131, "            stats.mapPuts.addAndGet(sub.mapPuts.get());"], [132, "            stats.mapRemoves.addAndGet(sub.mapRemoves.get());"], [133, "            stats.endTime = sub.getPeriodEnd();"], [134, "        }"], [135, "        return stats;"], [136, "    }"], [137, ""], [138, "    private MapOperationStatsImpl getThis() {"], [139, "        this.endTime = now();"], [140, "        return this;"], [144, "        return mapPuts.get() + mapGets.get() + mapRemoves.get();"], [150, "                \", puts:\" + mapPuts.get() +"], [151, "                \", gets:\" + mapGets.get() +"], [152, "                \", removes:\" + mapRemoves.get() +"], [157, "        return startTime;"], [161, "        return endTime;"], [165, "        return mapPuts.get();"], [169, "        return mapGets.get();"], [173, "        return mapRemoves.get();"]]}, "num_lines_added": 32, "num_lines_removed": 117}