{"hash": "12c47c3befb4bed87082b707415766867dfbe8f8", "message": "Add startmuted support and sip unmute", "file_num_lines": 930, "diff_parsed": {"added": [[25, "import org.jitsi.jigasi.JigasiBundleActivator;"], [231, "     * True if call should start muted, false otherwise."], [232, "     */"], [233, "    private boolean startAudioMuted = false;"], [234, ""], [235, "    /**"], [647, "        this.startAudioMuted = startMutedFlags[0];"], [662, "        try"], [663, "        {"], [664, ""], [665, "            if (callPeer.getCall() != this.sipCall)"], [666, "            {"], [667, "                if (logger.isTraceEnabled())"], [668, "                {"], [669, "                    logger.trace(\"Ignoring event for non session call.\");"], [670, "                }"], [671, "                return;"], [672, "            }"], [673, ""], [674, "            if (jsonObject.containsKey(\"type\") == false)"], [675, "            {"], [676, "                logger.error(\"Unknown json object type!\");"], [677, "                return;"], [678, "            }"], [679, ""], [680, "            if (jsonObject.containsKey(\"id\") == false)"], [681, "            {"], [682, "                logger.error(\"Unknown json object id!\");"], [683, "                return;"], [684, "            }"], [685, ""], [686, "            String id = (String)jsonObject.get(\"id\");"], [687, "            String type = (String)jsonObject.get(\"type\");"], [688, ""], [689, "            if (type.equalsIgnoreCase(\"muteResponse\") == true)"], [690, "            {"], [691, "                if (jsonObject.containsKey(\"status\") == false)"], [692, "                {"], [693, "                    logger.error(\"muteResponse without status!\");"], [694, "                    return;"], [695, "                }"], [696, ""], [697, "                if ( ((String)jsonObject.get(\"status\"))"], [698, "                        .equalsIgnoreCase(\"OK\") == true)"], [699, "                {"], [700, "                    JSONObject data = (JSONObject) jsonObject.get(\"data\");"], [701, ""], [702, "                    boolean bMute = (boolean)data.get(\"audio\");"], [703, ""], [704, "                    // Send presence audio muted"], [705, "                    this.jvbConference.setChatRoomAudioMuted(bMute);"], [706, "                }"], [707, "            }"], [708, "            else if (type.equalsIgnoreCase(\"muteRequest\") == true)"], [709, "            {"], [710, "                JSONObject data = (JSONObject) jsonObject.get(\"data\");"], [711, ""], [712, "                boolean bAudioMute = (boolean)data.get(\"audio\");"], [713, ""], [714, "                // Send request to jicofo"], [715, "                if (jvbConference.requestAudioMute(bAudioMute) == true)"], [716, "                {"], [717, "                    // Send response through sip"], [718, "                    respondRemoteAudioMute(bAudioMute,"], [719, "                                            true,"], [720, "                                            callPeer,"], [721, "                                            id);"], [722, ""], [723, "                    // Send presence if response succeeded"], [724, "                    this.jvbConference.setChatRoomAudioMuted(bAudioMute);"], [725, "                }"], [726, "                else"], [727, "                {"], [728, "                    respondRemoteAudioMute(bAudioMute,"], [729, "                                            false,"], [730, "                                            callPeer,"], [731, "                                            id);"], [732, "                }"], [733, "            }"], [734, "        }"], [735, "        catch(Exception ex)"], [736, "        {"], [737, "            logger.error(ex.getMessage());"], [738, "        }"], [742, "     * Creates a basic JSONObject to be sent over SIP."], [743, "     *"], [744, "     * @param type Used to identify the JSON."], [745, "     * @param data Used for JSON additional attributed."], [746, "     * @param id Used for identification."], [747, "     * @return Formed JSONObject."], [748, "     */"], [749, "    private JSONObject createSIPJSON(String type, JSONObject data, String id)"], [750, "    {"], [751, "        JSONObject req = new JSONObject();"], [752, "        req.put(\"type\", type);"], [753, "        req.put(\"data\", data);"], [754, "        req.put(\"id\", id == null ? UUID.randomUUID().toString() : id);"], [755, "        return req;"], [756, "    }"], [757, ""], [758, "    /**"], [759, "     * Creates a JSONObject to request audio to be muted over SIP."], [760, "     *"], [761, "     * @param bMuted <tt>true</tt> if audio is to be muted, <tt>false</tt> otherwise."], [762, "     * @return Formed JSONObject."], [763, "     */"], [764, "    private JSONObject createSIPJSONAudioMuteRequest(boolean bMuted)"], [765, "    {"], [766, "        JSONObject muteSettingsJson = new JSONObject();"], [767, "        muteSettingsJson.put(\"audio\", bMuted);"], [768, "        JSONObject muteRequestJson = createSIPJSON(\"muteRequest\", muteSettingsJson, null);"], [769, "        return muteRequestJson;"], [770, "    }"], [771, ""], [772, "    /**"], [773, "     * Creates a JSONObject as response to a muteRequest."], [774, "     *"], [775, "     * @param bMuted <tt>true</tt> if audio was muted, <tt>false</tt> otherwise."], [776, "     * @param bSucceeded <tt>true</tt> if muteRequest succeeded, <tt>false</tt> otherwise."], [777, "     * @param id Represents id of muteRequest."], [778, "     * @return Formed JSONObject."], [779, "     */"], [780, "    private JSONObject createSIPJSONAudioMuteResponse(boolean bMuted,"], [781, "                                                        boolean bSucceeded,"], [782, "                                                        String id)"], [783, "    {"], [784, "        JSONObject muteSettingsJson = new JSONObject();"], [785, "        muteSettingsJson.put(\"audio\", bMuted);"], [786, "        JSONObject muteResponseJson = createSIPJSON(\"muteResponse\", muteSettingsJson, id);"], [787, "        muteResponseJson.put(\"status\", bSucceeded == true ? \"OK\" : \"FAILED\");"], [788, "        return muteResponseJson;"], [789, "    }"], [790, ""], [791, "    /**"], [792, "     * Sends a JSON request over SIP to mute callPeer with bMuted flag."], [793, "     *"], [794, "     * @param bMuted true if audio should be muted, false otherwise."], [795, "     * @param callPeer CallPeer to send JSON to."], [796, "     * @throws OperationFailedException"], [797, "     */"], [798, "    private void requestRemoteAudioMute(boolean bMuted,"], [799, "                                        CallPeer callPeer)"], [800, "                                        throws OperationFailedException"], [801, "    {"], [802, "        // Mute audio"], [803, "        JSONObject muteRequestJson = createSIPJSONAudioMuteRequest(bMuted);"], [804, ""], [805, "        jitsiMeetTools.sendJSON(callPeer,"], [806, "                                muteRequestJson,"], [807, "                                new HashMap<String, Object>(){{"], [808, "                                    put(\"VIA\", (Object)(\"SIP.INFO\"));"], [809, "                                }});"], [810, "    }"], [811, ""], [812, "    /**"], [813, "     * Sends a JSON muteResponse over SIP to callPeer with specified flag."], [814, "     *"], [815, "     * @param bMuted true if audio was muted, false otherwise."], [816, "     * @param bSucceeded <tt>true</tt> if request succeeded, <tt>false</tt> otherwise."], [817, "     * @param callPeer CallPeer to send response to."], [818, "     * @param id Set as muteRequest id."], [819, "     * @throws OperationFailedException"], [820, "     */"], [821, "    private void respondRemoteAudioMute(boolean bMuted,"], [822, "                                        boolean bSucceeded,"], [823, "                                        CallPeer callPeer,"], [824, "                                        String id)"], [825, "                                        throws OperationFailedException"], [826, "    {"], [827, "        JSONObject muteResponseJson"], [828, "            = createSIPJSONAudioMuteResponse(bMuted, bSucceeded, id);"], [829, ""], [830, "        jitsiMeetTools.sendJSON(callPeer,"], [831, "                                muteResponseJson,"], [832, "                                new HashMap<String, Object>() {{"], [833, "                                    put(\"VIA\", (Object)(\"SIP.INFO\"));"], [834, "                                }});"], [835, "    }"], [836, ""], [837, "    /**"], [1335, "            if (JigasiBundleActivator.isSipStartMutedEnabled() == true)"], [1336, "            {"], [1337, "                if (CallPeerState.CONNECTED.equals(callPeerState) == true)"], [1338, "                {"], [1339, "                    // After CallPeer is in CONNECTED state handle startmuted flags"], [1340, "                    jitsiMeetTools.addRequestListener(SipGatewaySession.this);"], [1341, ""], [1342, "                    if (SipGatewaySession.this.startAudioMuted == true)"], [1343, "                    {"], [1344, "                        // Send request to jicofo"], [1345, "                        if (jvbConference.requestAudioMute(startAudioMuted) == true)"], [1346, "                        {"], [1347, "                            // Notify peer"], [1348, "                            CallPeer callPeer = evt.getSourceCallPeer();"], [1349, ""], [1350, "                            try"], [1351, "                            {"], [1352, "                                requestRemoteAudioMute(startAudioMuted, callPeer);"], [1353, "                            }"], [1354, "                            catch (Exception ex)"], [1355, "                            {"], [1356, "                                logger.error(ex.getMessage());"], [1357, "                            }"], [1358, "                        }"], [1359, "                    }"], [1360, "                }"], [1361, ""], [1362, "                if (CallPeerState.DISCONNECTED.equals(callPeerState) == true)"], [1363, "                {"], [1364, "                    jitsiMeetTools.removeRequestListener(SipGatewaySession.this);"], [1365, "                }"], [1366, "            }"], [1367, ""]], "deleted": []}, "num_lines_added": 213, "num_lines_removed": 0}