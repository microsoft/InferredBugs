{"hash": "9ce90f83578dadd151316bcebe8bd1dd68139cf6", "message": "update to v1.0.23 \u7528\u6237\u4fee\u6539\u5bc6\u7801\u529f\u80fd\u5b8c\u6210", "file_num_lines": 190, "diff_parsed": {"added": [[10, "import java.nio.charset.Charset;"], [11, "import java.nio.charset.CharsetEncoder;"], [25, "\t@Resource"], [26, "\tprivate LogUtil lu;"], [35, ""], [36, "\tprivate CharsetEncoder ios8859_1Encoder;"], [37, ""], [39, "\t\tios8859_1Encoder = Charset.forName(\"ISO-8859-1\").newEncoder();"], [70, "\t\t\tfinal String loginInfoStr = DecryptionUtil.dncryption(encrypted, ku.getPrivateKey());"], [156, ""], [157, "\t@Override"], [158, "\tpublic String changePassword(HttpServletRequest request) {"], [159, "\t\t// \u9a8c\u8bc1\u662f\u5426\u5f00\u542f\u4e86\u7528\u6237\u4fee\u6539\u5bc6\u7801\u529f\u80fd"], [160, "\t\tif(!ConfigureReader.instance().isAllowChangePassword()) {"], [161, "\t\t\treturn \"illegal\";"], [162, "\t\t}"], [163, "\t\t// \u5fc5\u987b\u767b\u5f55\u4e86\u4e00\u4e2a\u8d26\u6237"], [164, "\t\tHttpSession session = request.getSession();"], [165, "\t\tfinal String account = (String) session.getAttribute(\"ACCOUNT\");"], [166, "\t\tif(account == null) {"], [167, "\t\t\treturn \"mustlogin\";"], [168, "\t\t}"], [169, "\t\t// \u89e3\u6790\u4fee\u6539\u5bc6\u7801\u8bf7\u6c42"], [170, "\t\tfinal String encrypted = request.getParameter(\"encrypted\");"], [171, "\t\ttry {"], [172, "\t\t\tfinal String changePasswordInfoStr = DecryptionUtil.dncryption(encrypted, ku.getPrivateKey());"], [173, "\t\t\tfinal ChangePasswordInfoPojo info = gson.fromJson(changePasswordInfoStr, ChangePasswordInfoPojo.class);"], [174, "\t\t\tif (System.currentTimeMillis() - Long.parseLong(info.getTime()) > TIME_OUT) {"], [175, "\t\t\t\treturn \"error\";"], [176, "\t\t\t}"], [177, "\t\t\t// \u5982\u679c\u9a8c\u8bc1\u7801\u5f00\u542f\u4e14\u8be5\u8d26\u6237\u5df2\u88ab\u5173\u6ce8\uff0c\u5219\u8981\u6c42\u63d0\u4f9b\u9a8c\u8bc1\u7801"], [178, "\t\t\tif(!ConfigureReader.instance().getVCLevel().equals(VCLevel.Close)) {"], [179, "\t\t\t\tsynchronized (focusAccount) {"], [180, "\t\t\t\t\tif (focusAccount.contains(account)) {"], [181, "\t\t\t\t\t\tString reqVerCode = request.getParameter(\"vercode\");"], [182, "\t\t\t\t\t\tString trueVerCode = (String) session.getAttribute(\"VERCODE\");"], [183, "\t\t\t\t\t\tsession.removeAttribute(\"VERCODE\");// \u786e\u4fdd\u4e00\u4e2a\u9a8c\u8bc1\u7801\u53ea\u4f1a\u751f\u6548\u4e00\u6b21\uff0c\u65e0\u8bba\u5bf9\u9519"], [184, "\t\t\t\t\t\tif (reqVerCode == null || trueVerCode == null || !trueVerCode.equals(reqVerCode.toLowerCase())) {"], [185, "\t\t\t\t\t\t\treturn \"needsubmitvercode\";"], [186, "\t\t\t\t\t\t}"], [187, "\t\t\t\t\t}"], [188, "\t\t\t\t}"], [189, "\t\t\t}"], [190, "\t\t\tif (ConfigureReader.instance().checkAccountPwd(account, info.getOldPwd())) {"], [191, "\t\t\t\t// \u5982\u679c\u8be5\u8d26\u6237\u8f93\u5165\u6b63\u786e\u4e14\u662f\u4e00\u4e2a\u88ab\u5173\u6ce8\u7684\u8d26\u6237\uff0c\u5219\u89e3\u9664\u8be5\u8d26\u6237\u7684\u5173\u6ce8\uff0c\u91ca\u653e\u7a7a\u95f4"], [192, "\t\t\t\tif(!ConfigureReader.instance().getVCLevel().equals(VCLevel.Close)) {"], [193, "\t\t\t\t\tsynchronized (focusAccount) {"], [194, "\t\t\t\t\t\tfocusAccount.remove(account);"], [195, "\t\t\t\t\t}"], [196, "\t\t\t\t}"], [197, "\t\t\t\tString newPassword = info.getNewPwd();"], [198, "\t\t\t\t// \u65b0\u5bc6\u7801\u5408\u6cd5\u6027\u68c0\u67e5"], [199, "\t\t\t\tif(newPassword != null && newPassword.length() >= 3 && newPassword.length() <= 32 && ios8859_1Encoder.canEncode(newPassword)) {"], [200, "\t\t\t\t\tif(ConfigureReader.instance().changePassword(account, newPassword)) {"], [201, "\t\t\t\t\t\tlu.writeChangePasswordEvent(account, newPassword);"], [202, "\t\t\t\t\t\treturn \"success\";"], [203, "\t\t\t\t\t}"], [204, "\t\t\t\t}"], [205, "\t\t\t\treturn \"invalidnewpwd\";"], [206, "\t\t\t}else {"], [207, "\t\t\t\t// \u5982\u679c\u8d26\u6237\u5bc6\u7801\u4e0d\u5339\u914d\uff0c\u5219\u5c06\u8be5\u8d26\u6237\u52a0\u5165\u5230\u5173\u6ce8\u8d26\u6237\u96c6\u5408\uff0c\u907f\u514d\u5bf9\u65b9\u8fdb\u4e00\u6b65\u7834\u89e3"], [208, "\t\t\t\tsynchronized (focusAccount) {"], [209, "\t\t\t\t\tif(!ConfigureReader.instance().getVCLevel().equals(VCLevel.Close)) {"], [210, "\t\t\t\t\t\tfocusAccount.add(account);"], [211, "\t\t\t\t\t}"], [212, "\t\t\t\t}"], [213, "\t\t\t\treturn \"oldpwderror\";"], [214, "\t\t\t}"], [215, "\t\t} catch (Exception e) {"], [216, "\t\t\tlu.writeException(e);"], [217, "\t\t\te.printStackTrace();"], [218, "\t\t\treturn \"cannotchangepwd\";"], [219, "\t\t}"], [220, "\t}"]], "deleted": [[31, ""], [62, "\t\tfinal String loginInfoStr = DecryptionUtil.dncryption(encrypted, ku.getPrivateKey());"]]}, "num_lines_added": 74, "num_lines_removed": 2}