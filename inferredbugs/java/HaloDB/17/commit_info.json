{"hash": "5e2b42434a8041e7f70ea7b38efa173f321a6ffd", "message": "Merge tombstone files right after memory index is built", "file_num_lines": 662, "diff_parsed": {"added": [[72, "    private volatile boolean isTombstoneFilesMerging = false;"], [73, ""], [131, "            // merge tombstone files at background if clean up set to true"], [132, "            if (options.isCleanUpTombstonesDuringOpen()) {"], [133, "                dbInternal.isTombstoneFilesMerging = true;"], [134, "                Thread t = new Thread(() -> { dbInternal.mergeTombstoneFiles(); });"], [135, "                t.start();"], [136, "            }"], [137, ""], [649, "    private void mergeTombstoneFiles() {"], [664, "            try {"], [665, "                tombstoneFile.open();"], [666, "                TombstoneFile.TombstoneFileIterator iterator = tombstoneFile.newIterator();"], [667, ""], [668, "                long count = 0;"], [669, "                while (iterator.hasNext()) {"], [670, "                    TombstoneEntry entry = iterator.next();"], [671, "                    rateLimiter.acquire(entry.size());"], [672, "                    count++;"], [673, "                    mergedTombstoneFile = rollOverTombstoneFile(entry, mergedTombstoneFile);"], [674, "                    mergedTombstoneFile.write(entry);"], [675, "                }"], [676, "                if (count > 0) {"], [677, "                    logger.debug(\"Merged {} tombstones from {} to {}\","], [678, "                        count, tombstoneFile.getName(), mergedTombstoneFile.getName());"], [679, "                }"], [680, "                tombstoneFile.close();"], [681, "                tombstoneFile.delete();"], [682, "            } catch (IOException e) {"], [683, "                logger.error(\"IO exception when merging tombstone file\", e);"], [689, "        isTombstoneFilesMerging = false;"], [837, ""], [838, "    @VisibleForTesting"], [839, "    boolean isTombstoneFilesMerging() {"], [840, "        return isTombstoneFilesMerging;"], [841, "    }"]], "deleted": [[640, "    void mergeTombstoneFiles() throws IOException {"], [641, "        if (!options.isCleanUpTombstonesDuringOpen()) {"], [642, "            logger.info(\"CleanUpTombstonesDuringOpen is not enabled, returning\");"], [643, "            return;"], [644, "        }"], [645, ""], [660, "            tombstoneFile.open();"], [661, "            TombstoneFile.TombstoneFileIterator iterator = tombstoneFile.newIterator();"], [662, ""], [663, "            long count = 0;"], [664, "            while (iterator.hasNext()) {"], [665, "                TombstoneEntry entry = iterator.next();"], [666, "                rateLimiter.acquire(entry.size());"], [667, "                count++;"], [668, "                mergedTombstoneFile = rollOverTombstoneFile(entry, mergedTombstoneFile);"], [669, "                mergedTombstoneFile.write(entry);"], [670, "            }"], [671, "            if (count > 0) {"], [672, "                logger.debug(\"Merged {} tombstones from {} to {}\","], [673, "                    count, tombstoneFile.getName(), mergedTombstoneFile.getName());"], [675, "            tombstoneFile.close();"], [676, "            tombstoneFile.delete();"]]}, "num_lines_added": 36, "num_lines_removed": 22}