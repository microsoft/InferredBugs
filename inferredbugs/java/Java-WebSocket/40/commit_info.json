{"hash": "39264c7a3956c993aedcaa6c568f725cfcdfd526", "message": "fixed racing condition in websocket server stop", "file_num_lines": 407, "diff_parsed": {"added": [[24, "import java.util.concurrent.atomic.AtomicBoolean;"], [73, "\tprivate volatile AtomicBoolean isclosed = new AtomicBoolean( false );"], [74, ""], [173, "\t * ServerSocketChannel, effectively killing the server socket selectorthread,"], [174, "\t * freeing the port the server was bound to and stops all internal workerthreads."], [175, "\t *"], [176, "\t * If this method is called before the server is started it will never start."], [177, "\t *"], [178, "\t * Therefore"], [179, "\t *"], [180, "\t * Additionally"], [181, "\t *"], [182, "\t * @param timeout"], [183, "\t *            Specifies how many milliseconds shall pass between initiating the close handshakes with the connected clients and closing the servers socket channel."], [189, "\tpublic void stop( int timeout ) throws IOException , InterruptedException {"], [190, "\t\tif( !isclosed.compareAndSet( false, true ) ) {"], [191, "\t\t\treturn;"], [192, "\t\t}"], [193, ""], [199, "\t\tsynchronized ( this ) {"], [200, "\t\t\tif( selectorthread != null ) {"], [201, "\t\t\t\tif( Thread.currentThread() != selectorthread ) {"], [202, ""], [203, "\t\t\t\t}"], [204, "\t\t\t\tselectorthread.interrupt();"], [205, "\t\t\t\tselectorthread.join();"], [206, "\t\t\t}"], [207, "\t\t\tif( decoders != null ) {"], [208, "\t\t\t\tfor( WebSocketWorker w : decoders ) {"], [209, "\t\t\t\t\tw.interrupt();"], [210, "\t\t\t\t}"], [211, "\t\t\t}"], [212, "\t\t\tif( server != null ) {"], [213, "\t\t\t\tserver.close();"], [214, "\t\t\t}"], [216, "\t}"], [218, "\tpublic void stop() throws IOException , InterruptedException {"], [219, "\t\tstop( 0 );"], [270, "\t\t\tif( isclosed.get() ) {"], [271, "\t\t\t\treturn;"], [272, "\t\t\t}"]], "deleted": [[170, "\t * ServerSocketChannel, effectively killing the server socket selectorthread and"], [171, "\t * freeing the port the server was bound to."], [177, "\tpublic void stop() throws IOException , InterruptedException {"], [183, "\t\tselectorthread.interrupt();"], [184, "\t\tselectorthread.join();"], [185, "\t\tfor( WebSocketWorker w : decoders ) {"], [186, "\t\t\tw.interrupt();"], [188, "\t\tthis.server.close();"]]}, "num_lines_added": 41, "num_lines_removed": 8}