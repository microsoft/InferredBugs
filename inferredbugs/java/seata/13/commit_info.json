{"hash": "b3a3e8e42c4cbdac0dae86e6101d26ca9be2ae32", "message": "optimize codec of RPC head map using zero-copy. (#1288)", "file_num_lines": 57, "diff_parsed": {"added": [[31, " * <pre>"], [34, " * |   magic   |Proto|     Full length       |    Head   | Msg |Seria|Compr|     RequestId         |"], [45, " * </pre>"], [47, " * <li>Full Length: include all data </li>"], [48, " * <li>Head Length: include head data from magic code to head map. </li>"], [49, " * <li>Body Length: Full Length - Head Length</li>"], [50, " * </p>"], [54, " * @see ProtocolV1Decoder"], [67, "                int fullLength = ProtocolConstants.V1_HEAD_LENGTH;"], [68, "                int headLength = ProtocolConstants.V1_HEAD_LENGTH;"], [70, "                byte messageType = rpcMessage.getMessageType();"], [71, "                out.writeBytes(ProtocolConstants.MAGIC_CODE_BYTES);"], [72, "                out.writeByte(ProtocolConstants.VERSION);"], [73, "                // full Length(4B) and head length(2B) will fix in the end."], [74, "                out.writerIndex(out.writerIndex() + 6);"], [75, "                out.writeByte(messageType);"], [76, "                out.writeByte(rpcMessage.getCodec());"], [77, "                out.writeByte(rpcMessage.getCompressor());"], [78, "                out.writeInt(rpcMessage.getId());"], [79, ""], [80, "                // direct write head with zero-copy"], [83, "                    int headMapBytesLength = HeadMapSerializer.getInstance().encode(headMap, out);"], [84, "                    headLength += headMapBytesLength;"], [85, "                    fullLength += headMapBytesLength;"], [100, ""], [101, "                // fix fullLength and headLength"], [102, "                int writeIndex = out.writerIndex();"], [103, "                // skip magic code(2B) + version(1B)"], [104, "                out.writerIndex(writeIndex - fullLength + 3);"], [105, "                out.writeInt(fullLength);"], [106, "                out.writeShort(headLength);"], [107, "                out.writerIndex(writeIndex);"], [113, "        }"]], "deleted": [[31, " * <p>"], [34, " * |   magic   |Proto|     Full length       |  HeadMap  | Msg |Seria|Compr|     RequestId         |"], [45, " * </p>"], [62, "                int fullLength = 13;"], [63, "                int headLength = 0;"], [65, "                // count head"], [66, "                byte[] headBytes = null;"], [69, "                    headBytes = HeadMapSerializer.getInstance().encode(headMap);"], [70, "                    headLength = headBytes.length;"], [71, "                    fullLength += headLength;"], [75, "                byte messageType = rpcMessage.getMessageType();"], [84, "                out.writeBytes(ProtocolConstants.MAGIC_CODE_BYTES);"], [85, "                out.writeByte(ProtocolConstants.VERSION);"], [86, "                out.writeInt(fullLength);"], [87, "                out.writeShort(headLength);"], [88, "                out.writeByte(messageType);"], [89, "                out.writeByte(rpcMessage.getCodec());"], [90, "                out.writeByte(rpcMessage.getCompressor());"], [91, "                out.writeInt(rpcMessage.getId());"], [92, ""], [93, "                if (headBytes != null) {"], [94, "                    out.writeBytes(headBytes);"], [95, "                }"], [96, ""], [105, "        }"]]}, "num_lines_added": 33, "num_lines_removed": 25}