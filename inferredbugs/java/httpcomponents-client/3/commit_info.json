{"hash": "2b91201275339cc39e5853c5600387c6c17ee3bb", "message": "Refactoring of the TSCCM code:\n* Removed code maintaining a weak reference to the parent connection manager in the AbstractConnPool. The weak reference to the connection manager is currently used to shut down the pool when the connection manager gets GC-ed. The same net result can be achieved by calling #shutdown from #finalize() of the connection manager class.\n* Shut down connection managers in #finalize().\n* There is no point passing ClientConnectionOperator around. It can be assigned to the connection pool once at the construction time.\n\n\ngit-svn-id: https://svn.apache.org/repos/asf/httpcomponents/httpclient/trunk@649035 13f79535-47bb-0310-9956-ffa450edef68", "file_num_lines": 128, "diff_parsed": {"added": [[103, "    protected AbstractConnPool() {"], [169, "                TimeUnit tunit)"], [171, "        return newPoolEntryRequest().getPoolEntry(route, state, timeout, tunit);"]], "deleted": [[36, "import java.lang.ref.WeakReference;"], [46, "import org.apache.http.conn.ClientConnectionOperator;"], [47, "import org.apache.http.conn.ClientConnectionManager;"], [54, ""], [89, "     * The connection manager."], [90, "     * This weak reference is used only to detect garbage collection"], [91, "     * of the manager. The connection pool MUST NOT keep a hard reference"], [92, "     * to the manager, or else the manager might never be GCed."], [93, "     */"], [94, "    protected ConnMgrRef connManager;"], [95, ""], [96, ""], [97, "    /**"], [111, ""], [112, "    /**"], [113, "     * A weak reference to the connection manager, to detect GC."], [114, "     */"], [115, "    private static class ConnMgrRef"], [116, "        extends WeakReference<ClientConnectionManager> {"], [117, ""], [118, "        /**"], [119, "         * Creates a new reference."], [120, "         *"], [121, "         * @param ccmgr   the connection manager"], [122, "         * @param queue   the reference queue, or <code>null</code>"], [123, "         */"], [124, "        public ConnMgrRef(ClientConnectionManager ccmgr,"], [125, "                          ReferenceQueue<Object> queue) {"], [126, "            super(ccmgr, queue);"], [127, "        }"], [128, "    }"], [129, ""], [130, ""], [136, "    protected AbstractConnPool(ClientConnectionManager mgr) {"], [142, ""], [143, "        connManager = new ConnMgrRef(mgr, null);"], [179, ""], [180, "        connManager = new ConnMgrRef(connManager.get(), refQueue);"], [206, "                TimeUnit tunit,"], [207, "                ClientConnectionOperator operator)"], [209, "        return newPoolEntryRequest().getPoolEntry(route, state, timeout, tunit, operator);"], [251, "            } else if (ref instanceof ConnMgrRef) {"], [252, "                if (LOG.isDebugEnabled()) {"], [253, "                    LOG.debug(\"Connection manager garbage collected.\");"], [254, "                }"], [255, "                shutdown();"]]}, "num_lines_added": 3, "num_lines_removed": 46}