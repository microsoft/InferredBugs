{"hash": "798aa0ff0dfeb8f421bbb5cee12600afc0556885", "message": "\u4fee\u590d\u53ef\u80fd\u4f1a\u4e22\u6d88\u606f\u7684bug\uff0c\u5c06url\u4fe1\u606f\u5c01\u88c5\u6210\u4e86ApiUrl\uff0c\u8fd9HttpClient\u7528\u8d77\u6765\u771f\u5fc3\u70e6\uff01\uff01\uff01", "file_num_lines": 374, "diff_parsed": {"added": [[7, "import com.scienjus.smartqq.constant.ApiUrl;"], [71, "        //\u53d1\u9001\u8bf7\u6c42\u7684\u5ba2\u6237\u7aef"], [72, "        CloseableHttpClient client = HttpClients.createDefault();"], [74, "        HttpGet get = defaultHttpGet(ApiUrl.GET_QE_CODE);"], [76, "            FileOutputStream out = new FileOutputStream(filePath)) {"], [92, "        HttpGet get = defaultHttpGet(ApiUrl.VERIFY_QR_CODE);"], [93, "        //\u53d1\u9001\u8bf7\u6c42\u7684\u5ba2\u6237\u7aef"], [94, "        CloseableHttpClient client = HttpClients.createDefault();"], [121, "        //\u53d1\u9001\u8bf7\u6c42\u7684\u5ba2\u6237\u7aef"], [122, "        CloseableHttpClient client = HttpClients.createDefault();"], [123, "        HttpGet get = defaultHttpGet(ApiUrl.GET_PTWEBQQ, url);"], [139, "        //\u53d1\u9001\u8bf7\u6c42\u7684\u5ba2\u6237\u7aef"], [140, "        CloseableHttpClient client = HttpClients.createDefault();"], [141, "        HttpGet get = defaultHttpGet(ApiUrl.GET_VFWEBQQ, ptwebqq);"], [159, "            HttpPost post = defaultHttpPost(ApiUrl.GET_UIN_AND_PSESSIONID, new BasicNameValuePair(\"r\", r.toJSONString()));"], [160, "            try (CloseableHttpClient client = HttpClients.createDefault();"], [161, "                 CloseableHttpResponse response = client.execute(post, context)) {"], [184, "            //\u53d1\u9001\u8bf7\u6c42\u7684\u5ba2\u6237\u7aef"], [185, "            HttpPost post = defaultHttpPost(ApiUrl.GET_GROUP_LIST, new BasicNameValuePair(\"r\", r.toJSONString()));"], [187, "            try (CloseableHttpClient client = HttpClients.createDefault();"], [188, "                 CloseableHttpResponse response = client.execute(post, context)) {"], [212, "            HttpPost post = defaultHttpPost(ApiUrl.POLL_MESSAGE, new BasicNameValuePair(\"r\", r.toJSONString()));"], [216, "            pollMessageFuture = POOL.scheduleWithFixedDelay(new PollMessageTask(post, callback), 1, 1, TimeUnit.MILLISECONDS);"], [247, "            HttpPost post = defaultHttpPost(ApiUrl.SEND_MESSAGE_TO_GROUP, new BasicNameValuePair(\"r\", r.toJSONString()));"], [248, "            try (CloseableHttpClient client = HttpClients.createDefault();"], [249, "                 CloseableHttpResponse response = client.execute(post, context)) {"], [279, "            //\u53d1\u9001\u8bf7\u6c42\u7684\u5ba2\u6237\u7aef"], [280, "            HttpPost post = defaultHttpPost(ApiUrl.SEND_MESSAGE_TO_FRIEND, new BasicNameValuePair(\"r\", r.toJSONString()));"], [281, "            try (CloseableHttpClient client = HttpClients.createDefault();"], [282, "                 CloseableHttpResponse response = client.execute(post, context)) {"], [307, "            HttpPost post = defaultHttpPost(ApiUrl.GET_FRIEND_LIST, new BasicNameValuePair(\"r\", r.toJSONString()));"], [308, "            try (CloseableHttpClient client = HttpClients.createDefault();"], [309, "                 CloseableHttpResponse response = client.execute(post, context)) {"], [417, "    private static HttpGet defaultHttpGet(ApiUrl apiUrl, Object... params) {"], [418, "        String url = apiUrl.buildUrl(params);"], [420, "        if (apiUrl.getReferer() != null) {"], [421, "            get.setHeader(\"Referer\", apiUrl.getReferer());"], [423, "        get.setHeader(\"User-Agent\", ApiUrl.getUserAgent());"], [428, "    private static HttpPost defaultHttpPost(ApiUrl apiUrl, BasicNameValuePair... params) throws UnsupportedEncodingException {"], [429, "        HttpPost post = new HttpPost(apiUrl.getUrl());"], [430, "        if (apiUrl.getReferer() != null) {"], [431, "            post.setHeader(\"Referer\", apiUrl.getReferer());"], [433, "        post.setEntity(new UrlEncodedFormEntity(Arrays.asList(params), \"UTF-8\"));"], [434, "        post.setHeader(\"Origin\", apiUrl.getOrigin());"], [435, "        post.setHeader(\"User-Agent\", ApiUrl.getUserAgent());"], [455, "            try (CloseableHttpClient client = HttpClients.createDefault();"], [456, "                 CloseableHttpResponse response = client.execute(post, context)) {"], [474, "                LOGGER.error(\"\u6682\u65f6\u6ca1\u6709\u6d88\u606f\");"]], "deleted": [[8, "import org.apache.http.client.config.RequestConfig;"], [18, "import org.apache.http.params.CoreConnectionPNames;"], [43, "    //\u53d1\u9001\u8bf7\u6c42\u7684\u5ba2\u6237\u7aef"], [44, "    private CloseableHttpClient client = HttpClients.createDefault();"], [45, ""], [76, "        HttpGet get = defaultHttpGet(\"https://ssl.ptlogin2.qq.com/ptqrshow?appid=501004106&e=0&l=M&s=5&d=72&v=4&t=0.1\", null);"], [78, "             FileOutputStream out = new FileOutputStream(filePath)) {"], [94, "        HttpGet get = defaultHttpGet("], [95, "                \"https://ssl.ptlogin2.qq.com/ptqrlogin?webqq_type=10&remember_uin=1&login2qq=1&aid=501004106&u1=h\" +"], [96, "                        \"ttp%3A%2F%2Fw.qq.com%2Fproxy.html%3Flogin2qq%3D1%26webqq_type%3D10&ptredirect=0&ptlang=2052&daid=164&from_ui=1&ptty\" +"], [97, "                        \"pe=1&dumy=&fp=loginerroralert&action=0-0-157510&mibao_css=m_webqq&t=1&g=1&js_type=0&js_ver=10143&login_sig=&pt_randsalt=0\","], [98, ""], [99, "                \"https://ui.ptlogin2.qq.com/cgi-bin/login?daid=164&target=self&style=16&mibao_css=m_webqq&appid=501004106&enable_q\" +"], [100, "                        \"login=0&no_verifyimg=1&s_url=http%3A%2F%2Fw.qq.com%2Fproxy.html&f_url=loginerroralert&strong_login=1&login_state=10&t=20131024001\");"], [127, "        HttpGet get = defaultHttpGet(url, null);"], [143, "        HttpGet get = defaultHttpGet("], [144, "                \"http://s.web2.qq.com/api/getvfwebqq?ptwebqq=\" + ptwebqq + \"&clientid=53999199&psessionid=&t=0.1\","], [145, "                \"http://s.web2.qq.com/proxy.html?v=20130916001&callback=1&id=1\");"], [157, "        HttpPost post = defaultHttpPost("], [158, "                \"http://d1.web2.qq.com/channel/login2\","], [159, "                \"http://d1.web2.qq.com/proxy.html?v=20151105001&callback=1&id=2\");"], [166, "            post.setEntity(new UrlEncodedFormEntity(Arrays.asList(new BasicNameValuePair(\"r\", r.toJSONString()))));"], [167, "            try (CloseableHttpResponse response = client.execute(post, context)) {"], [186, "        HttpPost post = defaultHttpPost("], [187, "                \"http://s.web2.qq.com/api/get_group_name_list_mask2\","], [188, "                \"http://d1.web2.qq.com/proxy.html?v=20151105001&callback=1&id=2\");"], [194, "            try (CloseableHttpResponse response = client.execute(post, context)) {"], [212, "        HttpPost post = defaultHttpPost("], [213, "                \"http://d1.web2.qq.com/channel/poll2\","], [214, "                \"http://d1.web2.qq.com/proxy.html?v=20151105001&callback=1&id=2\");"], [221, "            post.setEntity(new UrlEncodedFormEntity(Arrays.asList(new BasicNameValuePair(\"r\", r.toJSONString()))));"], [225, "            pollMessageFuture = POOL.scheduleWithFixedDelay(new PollMessageTask(post, callback), 1, 1, TimeUnit.SECONDS);"], [248, "        HttpPost post = defaultHttpPost("], [249, "                \"http://d1.web2.qq.com/channel/send_qun_msg2\","], [250, "                \"http://d1.web2.qq.com/proxy.html?v=20151105001&callback=1&id=2\");"], [259, "            UrlEncodedFormEntity entity = new UrlEncodedFormEntity(Arrays.asList(new BasicNameValuePair(\"r\", r.toJSONString())), \"UTF-8\");"], [260, "            post.setEntity(entity);"], [261, "            try (CloseableHttpResponse response = client.execute(post, context)) {"], [283, "        HttpPost post = defaultHttpPost("], [284, "                \"http://d1.web2.qq.com/channel/send_buddy_msg2\","], [285, "                \"http://d1.web2.qq.com/proxy.html?v=20151105001&callback=1&id=2\");"], [294, "            UrlEncodedFormEntity entity = new UrlEncodedFormEntity(Arrays.asList(new BasicNameValuePair(\"r\", r.toJSONString())), \"UTF-8\");"], [295, "            post.setEntity(entity);"], [296, "            try (CloseableHttpResponse response = client.execute(post, context)) {"], [317, "        HttpPost post = defaultHttpPost("], [318, "                \"http://s.web2.qq.com/api/get_user_friends2\","], [319, "                \"http://s.web2.qq.com/proxy.html?v=20130916001&callback=1&id=1\");"], [324, "            post.setEntity(new UrlEncodedFormEntity(Arrays.asList(new BasicNameValuePair(\"r\", r.toJSONString()))));"], [325, "            try (CloseableHttpResponse response = client.execute(post, context)) {"], [433, "    private static HttpGet defaultHttpGet(String url, String referer) {"], [435, "        if (referer != null) {"], [436, "            get.setHeader(\"Referer\", referer);"], [438, "        RequestConfig requestConfig = RequestConfig.custom()"], [439, "                .setConnectTimeout(120 * 1000)"], [440, "                .setConnectionRequestTimeout(120 * 1000)"], [441, "                .setSocketTimeout(120 * 1000)"], [442, "                .build();"], [443, "        get.setConfig(requestConfig);"], [444, "        get.setHeader(\"User-Agent\", \"Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.101 Safari/537.36\");"], [449, "    private static HttpPost defaultHttpPost(String url, String referer) {"], [450, "        HttpPost post = new HttpPost(url);"], [451, "        if (referer != null) {"], [452, "            post.setHeader(\"Referer\", referer);"], [454, "        RequestConfig requestConfig = RequestConfig.custom()"], [455, "                .setConnectTimeout(120 * 1000)"], [456, "                .setConnectionRequestTimeout(120 * 1000)"], [457, "                .setSocketTimeout(120 * 1000)"], [458, "                .build();"], [459, "        post.setConfig(requestConfig);"], [460, "        post.setHeader(\"Origin\", getOrigin(url));"], [461, "        post.setHeader(\"User-Agent\", \"Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.101 Safari/537.36\");"], [465, "    //\u622a\u53d6url\u5f97\u5230origin"], [466, "    private static String getOrigin(String url) {"], [467, "        return url.substring(0, url.lastIndexOf(\"/\"));"], [468, "    }"], [469, ""], [470, ""], [487, "            try (CloseableHttpResponse response = client.execute(post, context)) {"], [505, "                LOGGER.error(\"\u83b7\u53d6\u63a5\u53d7\u6d88\u606f\u5931\u8d25\");"]]}, "num_lines_added": 48, "num_lines_removed": 79}