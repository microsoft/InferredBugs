{"hash": "4ff784226d24dbd01be41e0a315c640c8ba417b1", "message": "Fixed an issue related to setting of response timeout of more than 24 seconds for the device method invoke", "file_num_lines": 571, "diff_parsed": {"added": [[55, ""], [79, "                STANDARD_REQUEST_ID,"], [80, "                0);"], [98, "                STANDARD_REQUEST_ID,"], [99, "                0);"], [116, "                STANDARD_REQUEST_ID,"], [117, "                0);"], [134, "                STANDARD_REQUEST_ID,"], [135, "                0);"], [152, "                null,"], [153, "                0);"], [157, ""], [158, "    /* Tests_SRS_DEVICE_OPERATIONS_99_018: [The request shall throw IllegalArgumentException if the provided `timeoutInMs` plus DEFAULT_HTTP_TIMEOUT_MS exceed Integer.MAX_VALUE.] */"], [159, "    @Test (expected = IllegalArgumentException.class)"], [160, "    public void request_TimeoutExceeds_failed() throws Exception"], [161, "    {"], [162, "        //arrange"], [163, ""], [164, "        //act"], [165, "        HttpResponse response = DeviceOperations.request("], [166, "                IOT_HUB_CONNECTION_STRING,"], [167, "                new URL(STANDARD_URL),"], [168, "                HttpMethod.POST,"], [169, "                STANDARD_PAYLOAD,"], [170, "                STANDARD_REQUEST_ID,"], [171, "                Integer.MAX_VALUE);"], [172, ""], [173, "        //assert"], [174, "    }"], [175, ""], [176, ""], [190, "                \"\","], [191, "                0);"], [216, "                STANDARD_REQUEST_ID,"], [217, "                0);"], [239, "                STANDARD_REQUEST_ID,"], [240, "                0);"], [262, "                STANDARD_REQUEST_ID,"], [263, "                0);"], [292, "                STANDARD_REQUEST_ID,"], [293, "                DEFAULT_HTTP_TIMEOUT_MS);"], [296, "    /* Tests_SRS_DEVICE_OPERATIONS_21_009: [The request shall add to the HTTP header the sum of timeout and default timeout in milliseconds.] */"], [320, "                STANDARD_REQUEST_ID,"], [321, "                0);"], [350, "                STANDARD_REQUEST_ID,"], [351, "                0);"], [382, "                STANDARD_REQUEST_ID,"], [383, "                0);"], [416, "                STANDARD_REQUEST_ID,"], [417, "                0);"], [452, "                STANDARD_REQUEST_ID,"], [453, "                0);"], [490, "                STANDARD_REQUEST_ID,"], [491, "                0);"], [530, "                STANDARD_REQUEST_ID,"], [531, "                0);"], [578, "                STANDARD_REQUEST_ID,"], [579, "                0);"], [625, "                STANDARD_REQUEST_ID,"], [626, "                0);"], [646, ""], [647, " /* Tests_SRS_DEVICE_OPERATIONS_21_017: [If the resulted status represents success, the request shall return the http response.] */"], [648, "    @Test"], [649, "    public void invoke_httprequesttimeout_succeed("], [650, "            @Mocked IotHubServiceSasToken iotHubServiceSasToken,"], [651, "            @Mocked HttpRequest httpRequest)"], [652, "            throws Exception"], [653, "    {"], [654, "        //arrange"], [655, "        final long responseTimeout = 30000; // 30 seconds"], [656, "        final long connectTimeout = 5000;   // 5 seconds"], [657, ""], [658, "        // Calculate total timeout in milliseconds"], [659, "        int timeoutInMs = (int)(responseTimeout + connectTimeout);"], [660, ""], [661, "        final int status = 200;"], [662, "        final byte[] body = { 1 };"], [663, "        final Map<String, List<String>> headerFields = new HashMap<>();"], [664, "        final byte[] errorReason = \"succeed\".getBytes();"], [665, "        HttpResponse sendResponse = new HttpResponse(status, body, headerFields, errorReason);"], [666, ""], [667, "        new NonStrictExpectations()"], [668, "        {"], [669, "            {"], [670, "                iotHubServiceSasToken.toString();"], [671, "                result = STANDARD_SASTOKEN_STRING;"], [672, "                httpRequest.setReadTimeoutMillis(timeoutInMs + DEFAULT_HTTP_TIMEOUT_MS);"], [673, "                result = httpRequest;"], [674, "                httpRequest.setHeaderField(AUTHORIZATION, STANDARD_SASTOKEN_STRING);"], [675, "                result = httpRequest;"], [676, "                httpRequest.setHeaderField(REQUEST_ID, STANDARD_REQUEST_ID);"], [677, "                result = httpRequest;"], [678, "                httpRequest.setHeaderField(USER_AGENT, TransportUtils.getJavaServiceClientIdentifier() + TransportUtils.getServiceVersion());"], [679, "                result = httpRequest;"], [680, "                httpRequest.setHeaderField(ACCEPT, ACCEPT_VALUE);"], [681, "                result = httpRequest;"], [682, "                httpRequest.setHeaderField(CONTENT_TYPE, ACCEPT_VALUE + \"; \" + ACCEPT_CHARSET);"], [683, "                result = httpRequest;"], [684, "                httpRequest.send();"], [685, "                result = sendResponse;"], [686, "                IotHubExceptionManager.httpResponseVerification(sendResponse);"], [687, "            }"], [688, "        };"], [690, "        //act"], [691, "        HttpResponse response = DeviceOperations.request("], [692, "                IOT_HUB_CONNECTION_STRING,"], [693, "                new URL(STANDARD_URL),"], [694, "                HttpMethod.POST,"], [695, "                STANDARD_PAYLOAD,"], [696, "                STANDARD_REQUEST_ID,"], [697, "                timeoutInMs);"], [698, ""], [699, "        //assert"], [700, "        assertEquals(response, sendResponse);"], [701, "        new Verifications()"], [702, "        {"], [703, "            {"], [704, "                iotHubServiceSasToken.toString();"], [705, "                times = 1;"], [706, "                httpRequest.setReadTimeoutMillis(timeoutInMs + DEFAULT_HTTP_TIMEOUT_MS);"], [707, "                times = 1;"], [708, "                httpRequest.setHeaderField(anyString, anyString);"], [709, "                times = 5;"], [710, "                httpRequest.send();"], [711, "                times = 1;"], [712, "                IotHubExceptionManager.httpResponseVerification(sendResponse);"], [713, "                times = 1;"], [714, "            }"], [715, "        };"], [716, "    }"]], "deleted": [[55, ""], [79, "                STANDARD_REQUEST_ID);"], [97, "                STANDARD_REQUEST_ID);"], [114, "                STANDARD_REQUEST_ID);"], [131, "                STANDARD_REQUEST_ID);"], [148, "                null);"], [165, "                \"\");"], [190, "                STANDARD_REQUEST_ID);"], [212, "                STANDARD_REQUEST_ID);"], [234, "                STANDARD_REQUEST_ID);"], [263, "                STANDARD_REQUEST_ID);"], [266, "    /* Tests_SRS_DEVICE_OPERATIONS_21_009: [The request shall add to the HTTP header an default timeout in milliseconds.] */"], [290, "                STANDARD_REQUEST_ID);"], [319, "                STANDARD_REQUEST_ID);"], [350, "                STANDARD_REQUEST_ID);"], [383, "                STANDARD_REQUEST_ID);"], [418, "                STANDARD_REQUEST_ID);"], [455, "                STANDARD_REQUEST_ID);"], [494, "                STANDARD_REQUEST_ID);"], [541, "                STANDARD_REQUEST_ID);"], [587, "                STANDARD_REQUEST_ID);"]]}, "num_lines_added": 130, "num_lines_removed": 21}