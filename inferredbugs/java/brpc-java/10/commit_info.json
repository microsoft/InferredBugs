{"hash": "ec558773d267fb4f0c1e129eb8288f3956a2beeb", "message": "ensure create thread pool thread safe", "file_num_lines": 132, "diff_parsed": {"added": [[22, "    private volatile EventLoopGroup defaultIoThreadPool;"], [25, "    private volatile ThreadPool defaultWorkThreadPool;"], [58, "        EventLoopGroup threadPool;"], [59, "        if ((threadPool = ioThreadPoolMap.get(serviceName)) == null) {"], [60, "            synchronized (serviceName.intern()) {"], [61, "                if ((threadPool = ioThreadPoolMap.get(serviceName)) == null) {"], [62, "                    threadPool = createClientIoThreadPool("], [63, "                            threadNum, \"brpc-client-io-thread-\" + serviceName, ioEventType);"], [64, "                    EventLoopGroup prev = ioThreadPoolMap.putIfAbsent(serviceName, threadPool);"], [65, "                    if (prev != null) {"], [66, "                        log.warn(\"brpc io thread pool exist for service:{}\", serviceName);"], [67, "                        threadPool.shutdownGracefully().awaitUninterruptibly();"], [68, "                    }"], [69, "                }"], [70, "            }"], [100, "        ThreadPool threadPool;"], [101, "        if ((threadPool = workThreadPoolMap.get(serviceName)) == null) {"], [102, "            synchronized (serviceName.intern()) {"], [103, "                if ((threadPool = workThreadPoolMap.get(serviceName)) == null) {"], [104, "                    threadPool = new ThreadPool(threadNum,"], [105, "                            new CustomThreadFactory(\"brpc-client-work-thread-\" + serviceName));"], [106, "                    workThreadPoolMap.put(serviceName, threadPool);"], [107, "                }"], [108, "            }"]], "deleted": [[22, "    private EventLoopGroup defaultIoThreadPool;"], [25, "    private ThreadPool defaultWorkThreadPool;"], [58, "        EventLoopGroup threadPool = ioThreadPoolMap.get(serviceName);"], [59, "        if (threadPool != null) {"], [60, "            return threadPool;"], [61, "        }"], [62, "        threadPool = createClientIoThreadPool("], [63, "                threadNum, \"brpc-client-io-thread-\" + serviceName, ioEventType);"], [64, "        EventLoopGroup prev = ioThreadPoolMap.putIfAbsent(serviceName, threadPool);"], [65, "        if (prev != null) {"], [66, "            log.warn(\"brpc io thread pool exist for service:{}\", serviceName);"], [67, "            threadPool.shutdownGracefully().awaitUninterruptibly();"], [97, "        ThreadPool threadPool = workThreadPoolMap.get(serviceName);"], [98, "        if (threadPool != null) {"], [99, "            return threadPool;"], [101, "        threadPool = new ThreadPool(threadNum,"], [102, "                new CustomThreadFactory(\"brpc-client-work-thread-\" + serviceName));"], [103, "        workThreadPoolMap.put(serviceName, threadPool);"]]}, "num_lines_added": 24, "num_lines_removed": 18}