{"hash": "5d4256936497171b0e9f4d969b4b2f1a64addda7", "message": "More functionality moved from DatasetPage and into the Ingest Service.", "file_num_lines": 489, "diff_parsed": {"added": [[484, ""], [485, "                    // If we've made it this far, we must have been able to"], [486, "                    // make a successful HTTP call to the DropBox server and"], [487, "                    // obtain an InputStream - so we can now create a new"], [488, "                    // DataFile object:"], [489, ""], [490, "                    dFile = ingestService.createDataFile(editVersion, dropBoxStream, fileName, null);"], [491, "                    newFiles.add(dFile);"], [504, "                        //logger.whocares(\"...\");"], [507, "            }"], [513, "        DataFile dFile = null;"], [514, ""], [515, "        try {"], [516, "            dFile = ingestService.createDataFile(editVersion, uFile.getInputstream(), uFile.getFileName(), uFile.getContentType());"], [517, "        } catch (IOException ioex) {"], [518, "            logger.warning(\"Failed to process and/or save the file \" + uFile.getFileName() + \"; \" + ioex.getMessage());"], [519, "            return;"], [520, "        }"], [521, ""], [522, "        newFiles.add(dFile);"], [523, ""], [524, "        /*"], [577, ""], [580, "        */"], [581, ""], [582, ""]], "deleted": [[484, "                    dFile = new DataFile(\"application/octet-stream\");"], [485, "                    dFile.setOwner(dataset);"], [486, ""], [487, "                    // save the file, in the temporary location for now:"], [488, "                    datasetService.generateFileSystemName(dFile);"], [489, "                    if (ingestService.getFilesTempDirectory() != null) {"], [490, "                        logger.info(\"Will attempt to save the DropBox file as: \" + ingestService.getFilesTempDirectory() + \"/\" + dFile.getFileSystemName());"], [491, "                        Files.copy(dropBoxStream, Paths.get(ingestService.getFilesTempDirectory(), dFile.getFileSystemName()), StandardCopyOption.REPLACE_EXISTING);"], [492, "                        File tempFile = Paths.get(ingestService.getFilesTempDirectory(), dFile.getFileSystemName()).toFile();"], [493, "                        if (tempFile.exists()) {"], [494, "                            long writtenBytes = tempFile.length();"], [495, "                            logger.info(\"File size, expected: \" + fileSize + \", written: \" + writtenBytes);"], [496, "                        } else {"], [497, "                            throw new IOException();"], [498, "                        }"], [499, "                    }"], [514, "            }"], [515, ""], [516, "            // If we've made it this far, we must have downloaded the file"], [517, "            // successfully, so let's finish processing it as a new DataFile"], [518, "            // object:"], [519, "            FileMetadata fmd = new FileMetadata();"], [520, "            fmd.setDataFile(dFile);"], [521, "            dFile.getFileMetadatas().add(fmd);"], [522, "            fmd.setLabel(fileName);"], [523, "            fmd.setCategory(dFile.getContentType());"], [524, "            if (editVersion.getFileMetadatas() == null) {"], [525, "                editVersion.setFileMetadatas(new ArrayList());"], [526, "            }"], [527, "            editVersion.getFileMetadatas().add(fmd);"], [528, "            fmd.setDatasetVersion(editVersion);"], [529, "            dataset.getFiles().add(dFile);"], [530, ""], [531, "            // When uploading files from dropBox, we don't get the benefit of"], [532, "            // having the browser recognize the mime type of the file. So we'll"], [533, "            // have to rely on our own utilities (Jhove, etc.) to try and determine"], [534, "            // what it is."], [535, "            String fileType = null;"], [536, "            try {"], [537, "                fileType = FileUtil.determineFileType(Paths.get(ingestService.getFilesTempDirectory(), dFile.getFileSystemName()).toFile(), fileName);"], [538, "                logger.fine(\"File utility recognized the file as \" + fileType);"], [539, "                if (fileType != null && !fileType.equals(\"\")) {"], [540, "                    dFile.setContentType(fileType);"], [541, "                }"], [542, "            } catch (IOException ex) {"], [543, "                logger.warning(\"Failed to run the file utility mime type check on file \" + fileName);"], [544, "            }"], [545, ""], [546, "            newFiles.add(dFile);"], [604, ""]]}, "num_lines_added": 26, "num_lines_removed": 50}