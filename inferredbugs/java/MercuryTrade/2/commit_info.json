{"hash": "ddda68d37c66e8be3d8de0e51cb69599eac59bda", "message": "Refactoring ConfigManager, now all frames can store their size, fix some bugs and performance issues", "file_num_lines": 195, "diff_parsed": {"added": [[3, "import com.mercury.platform.shared.pojo.FrameSettings;"], [8, "import org.json.simple.parser.ParseException;"], [35, "    private Map<String, String> cachedButtonsConfig;"], [36, "    private Map<String, FrameSettings> cachedFramesSettings;"], [37, "    private String gamePath = null;"], [38, ""], [57, "                cachedFramesSettings = getDefaultFramesSettings();"], [58, "                getDefaultFramesSettings().forEach(this::saveFrameSettings);"], [63, "            loadConfigFile();"], [64, "        }"], [65, "    }"], [66, "    private void loadConfigFile(){"], [67, "        JSONParser parser = new JSONParser();"], [68, "        try {"], [69, "            JSONObject root = (JSONObject) parser.parse(new FileReader(CONFIG_FILE));"], [70, "            gamePath = (String) root.get(\"gamePath\");"], [71, ""], [72, "            JSONArray buttons = (JSONArray) root.get(\"buttons\");"], [73, "            cachedButtonsConfig = new HashMap<>();"], [74, "            for (JSONObject next : (Iterable<JSONObject>) buttons) {"], [75, "                cachedButtonsConfig.put((String) next.get(\"title\"), (String) next.get(\"value\"));"], [76, "            }"], [77, ""], [78, "            JSONArray framesSetting = (JSONArray) root.get(\"framesSettings\");"], [79, "            cachedFramesSettings = new HashMap<>();"], [80, "            for (JSONObject next : (Iterable<JSONObject>) framesSetting) {"], [81, "                JSONObject location = (JSONObject) next.get(\"location\");"], [82, "                JSONObject size = (JSONObject) next.get(\"size\");"], [83, "                FrameSettings settings = new FrameSettings("], [84, "                        new Point(Integer.valueOf(String.valueOf(location.get(\"frameX\"))), Integer.valueOf(String.valueOf(location.get(\"frameY\")))),"], [85, "                        new Dimension(Integer.valueOf(String.valueOf(size.get(\"width\"))), Integer.valueOf(String.valueOf(size.get(\"height\"))))"], [86, "                );"], [87, "                cachedFramesSettings.put((String) next.get(\"frameClassName\"), settings);"], [89, "        } catch (Exception e) {"], [90, "            logger.error(\"Error in loadConfigFile: \",e);"], [105, "    public Map<String, String> getButtonsConfig(){"], [106, "        return cachedButtonsConfig;"], [109, "    public FrameSettings getFrameSettings(String frameClass){"], [110, "        return cachedFramesSettings.get("], [111, "                frameClass) == null ?"], [112, "                getDefaultFramesSettings().get(frameClass) :  cachedFramesSettings.get(frameClass);"], [113, "    }"], [117, "     * @param frameClassName frame name, always insert frame.getClass().getSimpleName()"], [121, "    public void saveFrameLocation(String frameClassName, Point point) {"], [123, "        Timer timer = componentsTimers.get(frameClassName);"], [130, "                    FrameSettings settings = cachedFramesSettings.get(frameClassName);"], [131, "                    //x,y from PointListener"], [132, "                    settings.setFrameLocation(new Point(x,y));"], [133, "                    saveFrameSettings(frameClassName,settings);"], [137, "            componentsPointListeners.put(frameClassName, pointListener);"], [138, "            componentsTimers.put(frameClassName, timer);"], [141, "            PointListener pointListener = componentsPointListeners.get(frameClassName);"], [149, "    public void saveFrameSize(String frameClassName, Dimension size){"], [150, ""], [151, "    }"], [152, ""], [163, "    public String getGamePath() {"], [164, "        return gamePath;"], [165, "    }"], [166, ""], [172, "        cachedButtonsConfig = buttons;"], [182, ""], [183, "    private void saveFrameSettings(String frameClassName,FrameSettings settings){"], [184, "        cachedFramesSettings.put(frameClassName, settings);"], [185, "        JSONArray frames = new JSONArray();"], [186, "        cachedFramesSettings.forEach((frameName,frameSettings)->{"], [187, "            JSONObject object = new JSONObject();"], [188, "            JSONObject location = new JSONObject();"], [189, "            location.put(\"frameX\",frameSettings.getFrameLocation().x);"], [190, "            location.put(\"frameY\",frameSettings.getFrameLocation().y);"], [191, ""], [192, "            JSONObject size = new JSONObject();"], [193, "            size.put(\"width\",frameSettings.getFrameSize().width);"], [194, "            size.put(\"height\",frameSettings.getFrameSize().height);"], [195, ""], [196, "            object.put(\"location\",location);"], [197, "            object.put(\"size\",size);"], [198, "            object.put(\"frameClassName\", frameName);"], [199, ""], [200, "            frames.add(object);"], [201, "        });"], [202, ""], [203, "        saveProperty(\"framesSettings\",frames);"], [204, "    }"], [232, "    private Map<String,FrameSettings> getDefaultFramesSettings(){"], [233, "        Map<String,FrameSettings> dFramesSettings = new HashMap<>();"], [234, "        dFramesSettings.put(\"TaskBarFrame\",new FrameSettings(new Point(500, 500),new Dimension(114,50)));"], [235, "        dFramesSettings.put(\"MessageFrame\",new FrameSettings(new Point(700, 500),new Dimension(370,115)));"], [236, "        dFramesSettings.put(\"GamePathChooser\",new FrameSettings(new Point(600, 500),new Dimension(570,100)));"], [237, "        dFramesSettings.put(\"TestCasesFrame\",new FrameSettings(new Point(900, 500),new Dimension(400,100)));"], [238, "        dFramesSettings.put(\"SettingsFrame\",new FrameSettings(new Point(600, 600),new Dimension(114,50)));"], [239, "        dFramesSettings.put(\"HistoryFrame\",new FrameSettings(new Point(600, 600),new Dimension(400,100)));"], [240, ""], [241, "        Dimension screenSize = Toolkit.getDefaultToolkit().getScreenSize();"], [242, "        double width = screenSize.getWidth();"], [243, "        double height = screenSize.getHeight();"], [244, "        dFramesSettings.put(\"NotificationFrame\",new FrameSettings(new Point((int) width / 2, (int) height / 2),new Dimension(114,50)));"], [245, "        return dFramesSettings;"], [246, "    }"]], "deleted": [[30, "    private Map<String, Object> properties = new HashMap<>();"], [52, "                Dimension screenSize = Toolkit.getDefaultToolkit().getScreenSize();"], [53, "                double width = screenSize.getWidth();"], [54, "                double height = screenSize.getHeight();"], [55, "                saveComponentLocation(\"TaskBarFrame\", new Point(500, 500));"], [56, "                saveComponentLocation(\"MessageFrame\", new Point(700, 500));"], [57, "                saveComponentLocation(\"GamePathChooser\", new Point(600, 500));"], [58, "                saveComponentLocation(\"TestCasesFrame\", new Point(900, 500));"], [59, "                saveComponentLocation(\"SettingsFrame\", new Point(600, 600));"], [60, "                saveComponentLocation(\"HistoryFrame\", new Point(600, 600));"], [61, "                saveComponentLocation(\"NotificationFrame\", new Point((int) width / 2, (int) height / 2));"], [66, "            JSONParser parser = new JSONParser();"], [67, "            try {"], [68, "                Object obj = parser.parse(new FileReader(CONFIG_FILE));"], [69, "                JSONObject jsonObject = (JSONObject) obj;"], [70, "                String gamePath = (String) jsonObject.get(\"gamePath\");"], [71, ""], [72, "                JSONArray buttons = (JSONArray) jsonObject.get(\"buttons\");"], [73, "                Map<String, String> buttonsConfig = new HashMap<>();"], [74, "                if (buttons != null) {"], [75, "                    for (JSONObject next : (Iterable<JSONObject>) buttons) {"], [76, "                        buttonsConfig.put((String) next.get(\"title\"), (String) next.get(\"value\"));"], [77, "                    }"], [78, "                } else {"], [79, "                    buttonsConfig = getDefaultButtons();"], [80, "                }"], [81, "                JSONObject taskBarLocation = (JSONObject) jsonObject.get(\"TaskBarFrame\");"], [82, "                Point taskBarPoint = new Point("], [83, "                        Integer.valueOf(String.valueOf(taskBarLocation.get(\"x\"))),"], [84, "                        Integer.valueOf(String.valueOf(taskBarLocation.get(\"y\"))));"], [85, ""], [86, "                JSONObject messageLocation = (JSONObject) jsonObject.get(\"MessageFrame\");"], [87, "                Point messagePoint = new Point("], [88, "                        Integer.valueOf(String.valueOf(messageLocation.get(\"x\"))),"], [89, "                        Integer.valueOf(String.valueOf(messageLocation.get(\"y\"))));"], [90, "                JSONObject gamePathLocation = (JSONObject) jsonObject.get(\"GamePathChooser\");"], [91, "                Point gamePathPoint = new Point("], [92, "                        Integer.valueOf(String.valueOf(gamePathLocation.get(\"x\"))),"], [93, "                        Integer.valueOf(String.valueOf(gamePathLocation.get(\"y\"))));"], [94, "                JSONObject settingsLocation = (JSONObject) jsonObject.get(\"SettingsFrame\");"], [95, "                Point settingsPoint = new Point("], [96, "                        Integer.valueOf(String.valueOf(settingsLocation.get(\"x\"))),"], [97, "                        Integer.valueOf(String.valueOf(settingsLocation.get(\"y\"))));"], [98, "                JSONObject historyLocation = (JSONObject) jsonObject.get(\"HistoryFrame\");"], [99, "                Point historyPoint = new Point("], [100, "                        Integer.valueOf(String.valueOf(historyLocation.get(\"x\"))),"], [101, "                        Integer.valueOf(String.valueOf(historyLocation.get(\"y\"))));"], [102, "                JSONObject notificationLocation = (JSONObject) jsonObject.get(\"NotificationFrame\");"], [103, "                Point notificationPoint = new Point("], [104, "                        Integer.valueOf(String.valueOf(notificationLocation.get(\"x\"))),"], [105, "                        Integer.valueOf(String.valueOf(notificationLocation.get(\"y\"))));"], [106, ""], [107, "                //removing"], [108, "                JSONObject testLocation = (JSONObject) jsonObject.get(\"TestCasesFrame\");"], [109, "                Point testPoint = new Point("], [110, "                        Integer.valueOf(String.valueOf(testLocation.get(\"x\"))),"], [111, "                        Integer.valueOf(String.valueOf(testLocation.get(\"y\"))));"], [112, ""], [113, "                properties.put(\"gamePath\", gamePath);"], [114, "                properties.put(\"buttons\", buttonsConfig);"], [115, "                properties.put(\"TaskBarFrame\", taskBarPoint);"], [116, "                properties.put(\"MessageFrame\", messagePoint);"], [117, "                properties.put(\"GamePathChooser\", gamePathPoint);"], [118, "                properties.put(\"SettingsFrame\", settingsPoint);"], [119, "                properties.put(\"HistoryFrame\", historyPoint);"], [120, "                properties.put(\"NotificationFrame\", notificationPoint);"], [121, "                //removing"], [122, "                properties.put(\"TestCasesFrame\", testPoint);"], [123, "            } catch (Exception e) {"], [124, "                logger.error(\"Error in ConfigManager.load\", e);"], [140, "    /**"], [141, "     * Get property from loaded data."], [142, "     *"], [143, "     * @param token property name"], [144, "     * @return property value"], [145, "     */"], [146, "    public Object getProperty(String token) {"], [147, "        return properties.get(token);"], [153, "     * @param componentName frame name, always insert frame.getClass().getSimpleName()"], [157, "    public void saveComponentLocation(String componentName, Point point) {"], [158, "        properties.put(componentName, point);"], [160, "        Timer timer = componentsTimers.get(componentName);"], [167, "                    JSONObject object = new JSONObject();"], [168, "                    //x and y from PointListener"], [169, "                    object.put(\"x\", x);"], [170, "                    object.put(\"y\", y);"], [171, "                    saveProperty(componentName, object);"], [175, "            componentsPointListeners.put(componentName, pointListener);"], [176, "            componentsTimers.put(componentName, timer);"], [179, "            PointListener pointListener = componentsPointListeners.get(componentName);"], [193, "            properties.put(\"gamePath\", gamePath);"], [203, "        properties.put(\"buttons\",buttons);"]]}, "num_lines_added": 99, "num_lines_removed": 92}