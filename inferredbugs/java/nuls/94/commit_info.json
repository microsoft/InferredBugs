{"hash": "3f33da9ef4274b3bbee55a64d3de378351373eb0", "message": "update consensus", "file_num_lines": 111, "diff_parsed": {"added": [[3, " * <p>"], [5, " * <p>"], [12, " * <p>"], [15, " * <p>"], [74, "        RegisterAgentTransaction raTx = (RegisterAgentTransaction) joinTx;"], [75, "        Consensus<Agent> ca = raTx.getTxData();"], [76, "        ca.getExtend().setBlockHeight(raTx.getBlockHeight());"], [77, "        ca.getExtend().setStatus(ConsensusStatusEnum.WAITING.getCode());"], [78, "        AgentPo agentPo = ConsensusTool.agentToPojo(ca);"], [79, "        agentPo.setBlockHeight(joinTx.getBlockHeight());"], [80, "        agentPo.setDelHeight(0L);"], [81, "        this.agentDataService.updateSelective(agentPo);"], [85, "        UpdateDepositByAgentIdParam dpo = new UpdateDepositByAgentIdParam();"], [86, "        dpo.setAgentId(ca.getHexHash());"], [87, "        dpo.setOldDelHeight(joinTx.getBlockHeight());"], [88, "        dpo.setNewDelHeight(0L);"], [89, "        this.depositDataService.updateSelectiveByAgentHash(dpo);"], [90, ""], [91, "        //cache deposit"], [92, "        Map<String, Object> params = new HashMap<>();"], [93, "        params.put(\"agentHash\", raTx.getTxData().getHexHash());"], [94, "        List<DepositPo> polist = this.depositDataService.getList(params);"], [95, "        if (null != polist) {"], [96, "            for (DepositPo po : polist) {"], [97, "                Consensus<Deposit> cd = ConsensusTool.fromPojo(po);"], [98, "                this.ledgerService.unlockTxRollback(po.getTxHash());"], [100, "        }"], [106, "        Consensus<Agent> agent = manager.getAgentById(ca.getHexHash());"], [107, "        agent.setDelHeight(0L);"], [108, "        manager.putAgent(agent);"], [109, ""], [110, "        List<Consensus<Deposit>> depositList = manager.getAllDepositList();"], [111, "        for (Consensus<Deposit> depositConsensus : depositList) {"], [112, "            if (!depositConsensus.getExtend().getAgentHash().equals(agent.getHexHash())) {"], [113, "                continue;"], [114, "            }"], [115, "            if (depositConsensus.getExtend().getBlockHeight() > joinTx.getBlockHeight()) {"], [116, "                continue;"], [118, "            if (depositConsensus.getDelHeight() < tx.getBlockHeight()) {"], [119, "                continue;"], [120, "            }"], [121, "            depositConsensus.setDelHeight(0L);"], [122, "            manager.putDeposit(depositConsensus);"], [124, ""], [131, "        RegisterAgentTransaction raTx = (RegisterAgentTransaction) joinTx;"], [134, "        Map<String, Object> paramsMap = new HashMap<>();"], [135, "        paramsMap.put(\"agentHash\", raTx.getTxData().getHexHash());"], [136, "        List<DepositPo> poList = depositDataService.getList(paramsMap);"], [137, "        for (DepositPo po : poList) {"], [138, "            this.ledgerService.unlockTxSave(po.getTxHash(), 0);"], [140, "        this.agentDataService.deleteById(raTx.getTxData().getHexHash(), tx.getBlockHeight());"], [141, "        DepositPo delPo = new DepositPo();"], [142, "        delPo.setAgentHash(raTx.getTxData().getHexHash());"], [143, "        delPo.setDelHeight(tx.getBlockHeight());"], [144, "        this.depositDataService.deleteByAgentHash(delPo);"], [145, "        manager.delAgent(raTx.getTxData().getHexHash(), tx.getBlockHeight());"], [146, "        manager.delDepositByAgentId(raTx.getTxData().getHexHash(), tx.getBlockHeight());"], [147, ""], [158, "        RegisterAgentTransaction realTx = (RegisterAgentTransaction) joinTx;"], [159, "        manager.delAgent(realTx.getTxData().getHexHash(), tx.getBlockHeight());"], [160, "        manager.delDepositByAgentId(realTx.getTxData().getHexHash(), tx.getBlockHeight());"], [161, ""]], "deleted": [[3, " *"], [5, " *"], [12, " *"], [15, " *"], [74, "        if (joinTx.getType() == TransactionConstant.TX_TYPE_REGISTER_AGENT) {"], [75, "            RegisterAgentTransaction raTx = (RegisterAgentTransaction) joinTx;"], [76, "            Consensus<Agent> ca = raTx.getTxData();"], [77, "            ca.getExtend().setBlockHeight(raTx.getBlockHeight());"], [78, "            ca.getExtend().setStatus(ConsensusStatusEnum.WAITING.getCode());"], [79, "            AgentPo agentPo = ConsensusTool.agentToPojo(ca);"], [80, "            agentPo.setBlockHeight(joinTx.getBlockHeight());"], [81, "            agentPo.setDelHeight(0L);"], [82, "            this.agentDataService.updateSelective(agentPo);"], [86, "            UpdateDepositByAgentIdParam dpo = new UpdateDepositByAgentIdParam();"], [87, "            dpo.setAgentId(ca.getHexHash());"], [88, "            dpo.setOldDelHeight(joinTx.getBlockHeight());"], [89, "            dpo.setNewDelHeight(0L);"], [90, "            this.depositDataService.updateSelectiveByAgentHash(dpo);"], [91, ""], [92, "            //cache deposit"], [93, "            Map<String, Object> params = new HashMap<>();"], [94, "            params.put(\"agentHash\", raTx.getTxData().getHexHash());"], [95, "            List<DepositPo> polist = this.depositDataService.getList(params);"], [96, "            if (null != polist) {"], [97, "                for (DepositPo po : polist) {"], [98, "                    Consensus<Deposit> cd = ConsensusTool.fromPojo(po);"], [99, "                    this.ledgerService.unlockTxRollback(po.getTxHash());"], [100, "                }"], [107, "            Consensus<Agent> agent = manager.getAgentById(ca.getHexHash());"], [108, "            agent.setDelHeight(0L);"], [109, "            manager.putAgent(agent);"], [110, ""], [111, "            List<Consensus<Deposit>> depositList = manager.getAllDepositList();"], [112, "            for(Consensus<Deposit> depositConsensus:depositList){"], [113, "                if(!depositConsensus.getExtend().getAgentHash().equals(agent.getHexHash())){"], [114, "                    continue;"], [115, "                }"], [116, "                if(depositConsensus.getExtend().getBlockHeight()>joinTx.getBlockHeight()){"], [117, "                    continue;"], [118, "                }"], [119, "                if(depositConsensus.getDelHeight()<tx.getBlockHeight()){"], [120, "                    continue;"], [121, "                }"], [122, "                depositConsensus.setDelHeight(0L);"], [123, "                manager.putDeposit(depositConsensus);"], [125, "            return;"], [127, "        PocJoinConsensusTransaction pjcTx = (PocJoinConsensusTransaction) joinTx;"], [128, "        Consensus<Deposit> cd = pjcTx.getTxData();"], [129, "        cd.getExtend().setStatus(ConsensusStatusEnum.IN.getCode());"], [130, "        DepositPo dpo = new DepositPo();"], [131, "        dpo.setId(cd.getHexHash());"], [132, "        dpo.setDelHeight(0L);"], [133, "        this.depositDataService.updateSelective(dpo);"], [134, "        StopConsensusNotice notice = new StopConsensusNotice();"], [135, "        notice.setEventBody(tx);"], [136, "        NulsContext.getServiceBean(EventBroadcaster.class).publishToLocal(notice);"], [137, "        this.ledgerService.unlockTxRollback(tx.getTxData().getDigestHex());"], [138, ""], [139, "        Consensus<Deposit> depositConsensus = manager.getDepositById(cd.getHexHash());"], [140, "        depositConsensus.setDelHeight(0L);"], [141, "        manager.putDeposit(depositConsensus);"], [148, "        if (joinTx.getType() == TransactionConstant.TX_TYPE_REGISTER_AGENT) {"], [149, "            RegisterAgentTransaction raTx = (RegisterAgentTransaction) joinTx;"], [152, "            Map<String, Object> paramsMap = new HashMap<>();"], [153, "            paramsMap.put(\"agentHash\", raTx.getTxData().getHexHash());"], [154, "            List<DepositPo> poList = depositDataService.getList(paramsMap);"], [155, "            for (DepositPo po : poList) {"], [156, "                this.ledgerService.unlockTxSave(po.getTxHash(), 0);"], [157, "            }"], [158, "            this.agentDataService.deleteById(raTx.getTxData().getHexHash(), tx.getBlockHeight());"], [159, "            DepositPo delPo = new DepositPo();"], [160, "            delPo.setAgentHash(raTx.getTxData().getHexHash());"], [161, "            delPo.setDelHeight(tx.getBlockHeight());"], [162, "            this.depositDataService.deleteByAgentHash(delPo);"], [163, "            manager.delAgent(raTx.getTxData().getHexHash(),tx.getBlockHeight());"], [164, "            manager.delDepositByAgentId(raTx.getTxData().getHexHash(),tx.getBlockHeight());"], [165, "            return;"], [167, "        PocJoinConsensusTransaction pjcTx = (PocJoinConsensusTransaction) joinTx;"], [168, "        Consensus<Deposit> cd = pjcTx.getTxData();"], [169, "        DepositPo dpo = new DepositPo();"], [170, "        dpo.setDelHeight(tx.getBlockHeight());"], [171, "        dpo.setId(cd.getHexHash());"], [172, "        this.depositDataService.deleteById(dpo);"], [173, "        this.ledgerService.unlockTxSave(tx.getTxData().getDigestHex(), 0);"], [174, "        manager.delDeposit(pjcTx.getTxData().getHexHash(),tx.getBlockHeight());"], [184, "        if (joinTx.getType() == TransactionConstant.TX_TYPE_REGISTER_AGENT) {"], [186, "            RegisterAgentTransaction realTx = (RegisterAgentTransaction) joinTx;"], [187, "            manager.delAgent(realTx.getTxData().getHexHash(),tx.getBlockHeight());"], [188, "            manager.delDepositByAgentId(realTx.getTxData().getHexHash(),tx.getBlockHeight());"], [189, "            return;"], [190, "        }"], [191, "        PocJoinConsensusTransaction realTx = (PocJoinConsensusTransaction) joinTx;"], [192, "        this.ledgerService.unlockTxApprove(tx.getTxData().getDigestHex(), 0);"], [193, "        manager.delDeposit(realTx.getTxData().getHexHash(),tx.getBlockHeight());"]]}, "num_lines_added": 62, "num_lines_removed": 94}