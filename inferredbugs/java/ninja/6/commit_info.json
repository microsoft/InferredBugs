{"hash": "db2d0746d5084f4229e7e14d1fd94b935f04a489", "message": "Revert \"BugFix #157. @UnitOfWork did not work when nested with @Transactional or other @UnitOfWork annotations.\"\n\nThis reverts commit c2d8e8f802cd54ecd75b7c87fc563d65b5c0c9e3.\n\nConflicts:\n\tninja-core/src/site/markdown/developer/changelog.md\n\tninja-servlet-jpa-blog-integration-test/src/test/java/controllers/BugReproductionControllerDocTesterTest.java", "file_num_lines": 26, "diff_parsed": {"added": [[32, "    @Inject"], [33, "    com.google.inject.persist.UnitOfWork unitOfWork;"], [51, "        if (null == didWeStartWork.get()) {"], [52, ""], [55, ""]], "deleted": [[20, "import com.google.inject.Provider;"], [21, "import com.google.inject.persist.PersistService;"], [22, "import com.google.inject.persist.UnitOfWork;"], [23, "import javax.persistence.EntityManager;"], [36, "    final Provider<com.google.inject.persist.UnitOfWork> unitOfWorkProvider;"], [50, ""], [51, "    final Provider<EntityManager> entityManagerProvider;"], [52, ""], [53, "    @Inject"], [54, "    public UnitOfWorkInterceptor("], [55, "            Provider<com.google.inject.persist.UnitOfWork> unitOfWorkProvider,"], [56, "            Provider<EntityManager> entityManagerProvider) {"], [57, "        this.unitOfWorkProvider = unitOfWorkProvider;"], [58, "        this.entityManagerProvider = entityManagerProvider;"], [59, "    }"], [64, "        final UnitOfWork unitOfWork;"], [65, ""], [66, "        // Only start a new unit of work if the entitymanager is empty"], [67, "        // otherwise someone else has started the unit of work already"], [68, "        // and we do nothing"], [69, "        // Please compare to com.google.inject.persist.jpa.JpaLocalTxnInterceptor"], [70, "        // we just mimick that interceptor"], [71, "        //"], [72, "        // IMPORTANT:"], [73, "        // Nesting of begin() end() of unitOfWork is NOT allowed. Contrary to"], [74, "        // the documentation of Google Guice as of March 2014."], [75, "        // Related Ninja issue: https://github.com/ninjaframework/ninja/issues/157"], [76, "        if (entityManagerProvider.get() == null) {"], [77, ""], [78, "            unitOfWork = unitOfWorkProvider.get();"], [81, ""]]}, "num_lines_added": 5, "num_lines_removed": 31}