{"hash": "89fd7625fe97bbcf30d669d38b8ff86697c6c15e", "message": "Synchronize access to the Agent's state. Harden state checks to avoid\nbugs due to race conditions. Don't fire state change events unless the\nstate indeed changed. Improve logging.", "file_num_lines": 1141, "diff_parsed": {"added": [[212, "     * Object used to synchronize access to {@link #state}."], [213, "     */"], [214, "    private final Object stateSyncRoot = new Object();"], [215, ""], [216, "    /**"], [726, "     * @return <tt>true</tt> iff the state of this <tt>Agent</tt> changed as"], [727, "     * a result of this call."], [729, "    private boolean setState(IceProcessingState newState)"], [731, "        IceProcessingState oldState;"], [732, "        synchronized (stateSyncRoot)"], [733, "        {"], [734, "            oldState = state;"], [735, "            this.state = newState;"], [736, "        }"], [738, "        if (!oldState.equals(newState))"], [739, "        {"], [740, "            logger.info(\"ICE state changed from \" + oldState + \" to \""], [741, "                                + newState);"], [742, "            fireStateChange(oldState, newState);"], [743, ""], [744, "            return true;"], [745, "        }"], [746, ""], [747, "        return false;"], [1740, "        // The race condition in which another thread enters COMPLETED right"], [1741, "        // under our nose here has been observed (and not in a single instance)"], [1742, "        // So check that we did indeed just trigger the change."], [1743, "        if (!setState(IceProcessingState.COMPLETED))"], [1744, "            return;"], [1748, "        if (stunKeepAliveThread == null"]], "deleted": [[722, "    private void setState(IceProcessingState newState)"], [724, "        IceProcessingState oldState = state;"], [726, "        this.state = newState;"], [727, "        fireStateChange(oldState, newState);"], [1708, "            logger.info(\"ICE state is FAILED\");"], [1721, "        logger.info(\"ICE state is COMPLETED\");"], [1722, ""], [1723, "        setState(IceProcessingState.COMPLETED);"], [1727, "        if(stunKeepAliveThread == null"], [2020, "            logger.info(\"ICE state is TERMINATED\");"]]}, "num_lines_added": 30, "num_lines_removed": 10}