{"hash": "2db67a31f8422b1dc6bad6b97fd0e673a33cc25c", "message": "v4.4 cms\u6a21\u5f0f\u7f51\u7ad9\u7ba1\u7406\u540e\u53f0\uff0c\u6a21\u7248\u7f16\u8f91\uff0c\u589e\u52a0\u7eaf\u4ee3\u7801\u7f16\u8f91\u6a21\u5f0f", "file_num_lines": 613, "diff_parsed": {"added": [[187, ""], [188, ""], [189, "\t\t//\u5224\u65ad\u662f\u4ee3\u7801\u6a21\u5f0f\uff0c\u8fd8\u662f\u667a\u80fd\u6a21\u5f0f"], [190, "\t\tif(templatePage.getEditMode() != null && templatePage.getEditMode() - TemplatePage.EDIT_MODE_CODE == 0){"], [191, ""], [192, "\t\t\t//\u4ee3\u7801\u6a21\u5f0f\u7f16\u8f91\uff0c\u90a3\u4e48\u76f4\u63a5\u4fdd\u5b58\u5373\u53ef\uff0c\u4e0d\u9700\u8981\u5378\u8f7d\u6a21\u7248\u53d8\u91cf\u7b49"], [193, ""], [194, "\t\t}else{"], [195, "\t\t\t//\u53ef\u89c6\u5316\u7f16\u8f91\uff0c\u9700\u8981\u63d0\u53d6\u6a21\u7248\u53d8\u91cf\u3001\u8fc7\u6ee4 htmledit \u7b49"], [196, ""], [197, "\t\t\t//\u5224\u65ad\u5176\u662f\u5426\u662f\u8fdb\u884c\u4e86\u81ea\u7531\u7f16\u8f91\uff0c\u66ff\u6362\u6389\u5176\u4e2dhtmledit\u52a0\u5165\u7684js\u8ddfcss\u6587\u4ef6\uff0c\u4e5f\u5c31\u662f\u66ff\u6362\u6389<!--XNX3HTMLEDIT-->\u8ddf</head>\u4e2d\u95f4\u7684\u6240\u6709\u5b57\u7b26\uff0c\u7f51\u9875\u6e90\u7801\u672c\u8eab<!--XNX3HTMLEDIT-->\u8ddf</head>\u662f\u6328\u7740\u7684"], [198, "\t\t\tint htmledit_start = html.indexOf(\"<!--XNX3HTMLEDIT-->\");"], [199, "\t\t\tif(htmledit_start > 0){"], [200, "\t\t\t\tint htmledit_head = html.indexOf(\"</head>\");"], [201, "\t\t\t\tif(htmledit_head == -1){"], [202, "\t\t\t\t\t//\u51fa\u9519\u4e86\uff0c\u5ffd\u7565"], [203, "\t\t\t\t}else{"], [204, "\t\t\t\t\t//\u6210\u529f\uff0c\u8fdb\u884c\u8fc7\u6ee4\u4e2d\u95f4\u7684htmledit\u52a0\u5165\u7684js\u8ddfcss"], [205, "\t\t\t\t\thtml = html.substring(0, htmledit_start)+html.substring(htmledit_head, html.length());"], [206, "\t\t\t\t}"], [207, ""], [208, "\t\t\t\t//contenteditable=true\u53bb\u6389"], [209, "\t\t\t\tif(html.indexOf(\"<body contenteditable=\\\"true\\\">\") > -1){"], [210, "\t\t\t\t\thtml = html.replace(\"<body contenteditable=\\\"true\\\">\", \"<body>\");"], [211, "\t\t\t\t}else{"], [212, "\t\t\t\t\thtml = html.replaceAll(\" contenteditable=\\\"true\\\"\", \"\");"], [213, "\t\t\t\t}"], [214, "\t\t\t}"], [215, ""], [216, "\t\t\t//\u5982\u679c\u8fd9\u4e2a\u9875\u9762\u4e2d\u4f7f\u7528\u4e86\u6a21\u7248\u53d8\u91cf\uff0c\u4fdd\u5b58\u65f6\uff0c\u5c06\u6a21\u7248\u53d8\u91cf\u53bb\u6389\uff0c\u53d8\u56de\u6a21\u7248\u8c03\u7528\u5f62\u5f0f{includeid=},\u5378\u8f7d\u53d8\u91cf\u6a21\u7248"], [217, "\t\t\tif(html.indexOf(\"<!--templateVarStart-->\") > -1){"], [218, "\t\t\t\tTemplate temp = new Template(site);"], [219, "\t\t\t\tPattern p = Pattern.compile(\"<!--templateVarStart-->([\\\\s|\\\\S]*?)<!--templateVarEnd-->\");"], [220, "\t\t        Matcher m = p.matcher(html);"], [221, "\t\t        while (m.find()) {"], [222, "\t\t        \tString templateVarText = m.group(1);\t//<!--templateVarName=-->+\u6a21\u7248\u53d8\u91cf\u7684\u5185\u5bb9"], [223, "\t\t        \tString templateVarName = temp.getConfigValue(templateVarText, \"templateVarName\");\t//\u6a21\u7248\u53d8\u91cf\u7684\u540d\u5b57"], [224, "\t\t        \ttemplateVarName = Sql.filter(templateVarName);"], [225, ""], [226, "\t\t        \t//\u66ff\u6362\u51fa\u5f53\u524d\u6a21\u7248\u53d8\u91cf\u7684\u5185\u5bb9\uff0c\u5373\u53bb\u6389templateVarText\u6ce8\u91ca"], [227, "\t\t        \ttemplateVarText = templateVarText.replace(\"<!--templateVarName=\"+templateVarName+\"-->\", \"\");"], [228, ""], [229, "\t\t        \t//\u5224\u65ad\u6a21\u7248\u53d8\u91cf\u662f\u5426\u6709\u8fc7\u53d8\u52a8\uff0c\u5f53\u524d\u7528\u6237\u662f\u5426\u4fee\u6539\u8fc7\u6a21\u7248\u53d8\u91cf\uff0c\u5982\u679c\u4fee\u6539\u8fc7\uff0c\u5c06\u4fee\u6539\u8fc7\u7684\u6a21\u7248\u53d8\u91cf\u4fdd\u5b58"], [230, "\t\t        \t//\u4ece\u5185\u5b58\u4e2d\u53d6\u6a21\u7248\u53d8\u91cf\u5185\u5bb9"], [231, "\t\t        \tString content = null;"], [232, "\t\t        \tBaseVO tvVO = getTemplateVarByCache(templateVarName);"], [233, "\t\t        \tif(tvVO.getResult() - BaseVO.SUCCESS == 0){"], [234, "\t\t        \t\tcontent = tvVO.getInfo();"], [235, "\t\t        \t}else{"], [236, "\t\t        \t\tvo.setBaseVO(BaseVO.FAILURE, \"\u5176\u4e2d\u4f7f\u7528\u7684\u6a21\u7248\u53d8\u91cf\u201c\"+templateVarName+\"\u201d\u4e0d\u5b58\u5728\uff01\u4fdd\u5b58\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u4fee\u6539\u540e\u518d\u5c1d\u8bd5\u4fdd\u5b58\");"], [237, "\t\t    \t\t\treturn vo;"], [238, "\t\t        \t}"], [239, "//\t\t        \tString content = G.templateVarMap.get(site.getTemplateName()).get(templateVarName);"], [240, ""], [241, "\t\t        \t//\u8bb2\u7528\u6237\u4fdd\u5b58\u7684\u8ddf\u5185\u5b58\u4e2d\u7684\u6a21\u7248\u53d8\u91cf\u5185\u5bb9\u6bd4\u8f83\uff0c\u662f\u5426\u4e00\u6837\uff0c\u82e5\u4e0d\u4e00\u6837\uff0c\u8981\u5c06\u5f53\u524d\u7684\u4fdd\u5b58"], [242, "\t\t        \tif(!(content.replaceAll(\"\\r|\\n|\\t\", \"\").equals(templateVarText.replaceAll(\"\\r|\\n|\\t\", \"\")))){"], [243, "\t\t        \t\t//\u4e0d\u4e00\u6837\uff0c\u8fdb\u884c\u4fdd\u5b58"], [244, ""], [245, "\t\t        \t    //\u6a21\u7248\u540d\u5b57\u68c0\u7d22\uff0c\u662f\u5426\u662f\u4f7f\u7528\u7684\u5bfc\u5165\u7684\u6a21\u7248\uff0c\u82e5\u662f\u4f7f\u7528\u7684\u5bfc\u5165\u7684\u6a21\u7248\uff0c\u5219\u53ea\u5217\u51fa\u5bfc\u5165\u7684\u6a21\u7248\u53d8\u91cf"], [246, "\t\t        \t    String templateNameWhere = \"\";"], [247, "\t\t        \t    if(site.getTemplateName() != null && site.getTemplateName().length() > 0){"], [248, "\t\t        \t    \ttemplateNameWhere = \" AND template_var.template_name = '\"+ site.getTemplateName() +\"'\";"], [249, "\t\t        \t    }"], [250, "\t\t        \t\tcom.xnx3.wangmarket.admin.entity.TemplateVar tv = sqlDAO.findAloneBySqlQuery(\"SELECT * FROM template_var WHERE siteid = \" + site.getId() + templateNameWhere + \" AND var_name = '\"+templateVarName+\"'\", com.xnx3.wangmarket.admin.entity.TemplateVar.class);"], [251, "\t\t        \t\tif(tv != null){"], [252, "\t\t        \t\t\ttv.setUpdatetime(DateUtil.timeForUnix10());"], [253, "\t\t\t        \t\tsqlDAO.save(tv);"], [254, ""], [255, "\t\t\t        \t\tTemplateVarData templateVarData = sqlDAO.findById(TemplateVarData.class, tv.getId());"], [256, "\t\t\t        \t\ttemplateVarData.setText(templateVarText);"], [257, "\t\t\t        \t\tsqlDAO.save(templateVarData);"], [258, ""], [259, "\t\t\t        \t\t//\u4fdd\u5b58\u5b8c\u540e\uff0c\u8981\u5c06\u5176\u66f4\u65b0\u5230\u5168\u5c40\u7f13\u5b58\u4e2d"], [260, "\t\t\t        \t\tupdateTemplateVarForCache(tv, templateVarData);"], [261, "\t\t        \t\t}"], [262, "\t\t        \t}"], [263, ""], [264, "//\t\t            \u5c06\u7528\u6237\u4fdd\u5b58\u7684\u5f53\u524d\u7684\u6a21\u7248\u9875\u9762\uff0c\u6a21\u7248\u53d8\u91cf\u6458\u9664\u51fa\u6765\uff0c\u8fd8\u539f\u4e3a\u6a21\u7248\u8c03\u7528\u7684\u6a21\u5f0f"], [265, "\t\t            html = html.replaceAll(\"<!--templateVarStart--><!--templateVarName=\"+templateVarName+\"-->([\\\\s|\\\\S]*?)<!--templateVarEnd-->\", \"{include=\"+templateVarName+\"}\");"], [266, "\t\t        }"], [267, "\t\t\t}"], [268, ""], [269, "\t\t}"], [270, ""], [623, "\t\t\tmap.put(\"editMode\", tp.getEditMode() == null? TemplatePage.EDIT_MODE_VISUAL:tp.getEditMode());"]], "deleted": [[175, "\t\t//\u5224\u65ad\u5176\u662f\u5426\u662f\u8fdb\u884c\u4e86\u81ea\u7531\u7f16\u8f91\uff0c\u66ff\u6362\u6389\u5176\u4e2dhtmledit\u52a0\u5165\u7684js\u8ddfcss\u6587\u4ef6\uff0c\u4e5f\u5c31\u662f\u66ff\u6362\u6389<!--XNX3HTMLEDIT-->\u8ddf</head>\u4e2d\u95f4\u7684\u6240\u6709\u5b57\u7b26\uff0c\u7f51\u9875\u6e90\u7801\u672c\u8eab<!--XNX3HTMLEDIT-->\u8ddf</head>\u662f\u6328\u7740\u7684"], [176, "\t\tint htmledit_start = html.indexOf(\"<!--XNX3HTMLEDIT-->\");"], [177, "\t\tif(htmledit_start > 0){"], [178, "\t\t\tint htmledit_head = html.indexOf(\"</head>\");"], [179, "\t\t\tif(htmledit_head == -1){"], [180, "\t\t\t\t//\u51fa\u9519\u4e86\uff0c\u5ffd\u7565"], [181, "\t\t\t}else{"], [182, "\t\t\t\t//\u6210\u529f\uff0c\u8fdb\u884c\u8fc7\u6ee4\u4e2d\u95f4\u7684htmledit\u52a0\u5165\u7684js\u8ddfcss"], [183, "\t\t\t\thtml = html.substring(0, htmledit_start)+html.substring(htmledit_head, html.length());"], [184, "\t\t\t}"], [185, ""], [186, "\t\t\t//contenteditable=true\u53bb\u6389"], [187, "\t\t\tif(html.indexOf(\"<body contenteditable=\\\"true\\\">\") > -1){"], [188, "\t\t\t\thtml = html.replace(\"<body contenteditable=\\\"true\\\">\", \"<body>\");"], [189, "\t\t\t}else{"], [190, "\t\t\t\thtml = html.replaceAll(\" contenteditable=\\\"true\\\"\", \"\");"], [191, "\t\t\t}"], [192, "\t\t}"], [193, ""], [194, "\t\t//\u5982\u679c\u8fd9\u4e2a\u9875\u9762\u4e2d\u4f7f\u7528\u4e86\u6a21\u7248\u53d8\u91cf\uff0c\u4fdd\u5b58\u65f6\uff0c\u5c06\u6a21\u7248\u53d8\u91cf\u53bb\u6389\uff0c\u53d8\u56de\u6a21\u7248\u8c03\u7528\u5f62\u5f0f{includeid=},\u5378\u8f7d\u53d8\u91cf\u6a21\u7248"], [195, "\t\tif(html.indexOf(\"<!--templateVarStart-->\") > -1){"], [196, "\t\t\tTemplate temp = new Template(site);"], [197, "\t\t\tPattern p = Pattern.compile(\"<!--templateVarStart-->([\\\\s|\\\\S]*?)<!--templateVarEnd-->\");"], [198, "\t        Matcher m = p.matcher(html);"], [199, "\t        while (m.find()) {"], [200, "\t        \tString templateVarText = m.group(1);\t//<!--templateVarName=-->+\u6a21\u7248\u53d8\u91cf\u7684\u5185\u5bb9"], [201, "\t        \tString templateVarName = temp.getConfigValue(templateVarText, \"templateVarName\");\t//\u6a21\u7248\u53d8\u91cf\u7684\u540d\u5b57"], [202, "\t        \ttemplateVarName = Sql.filter(templateVarName);"], [203, ""], [204, "\t        \t//\u66ff\u6362\u51fa\u5f53\u524d\u6a21\u7248\u53d8\u91cf\u7684\u5185\u5bb9\uff0c\u5373\u53bb\u6389templateVarText\u6ce8\u91ca"], [205, "\t        \ttemplateVarText = templateVarText.replace(\"<!--templateVarName=\"+templateVarName+\"-->\", \"\");"], [206, ""], [207, ""], [208, "\t        \t//\u5224\u65ad\u6a21\u7248\u53d8\u91cf\u662f\u5426\u6709\u8fc7\u53d8\u52a8\uff0c\u5f53\u524d\u7528\u6237\u662f\u5426\u4fee\u6539\u8fc7\u6a21\u7248\u53d8\u91cf\uff0c\u5982\u679c\u4fee\u6539\u8fc7\uff0c\u5c06\u4fee\u6539\u8fc7\u7684\u6a21\u7248\u53d8\u91cf\u4fdd\u5b58"], [209, "\t        \t//\u4ece\u5185\u5b58\u4e2d\u53d6\u6a21\u7248\u53d8\u91cf\u5185\u5bb9"], [210, "\t        \tString content = null;"], [211, "\t        \tBaseVO tvVO = getTemplateVarByCache(templateVarName);"], [212, "\t        \tif(tvVO.getResult() - BaseVO.SUCCESS == 0){"], [213, "\t        \t\tcontent = tvVO.getInfo();"], [214, "\t        \t}else{"], [215, "\t        \t\tvo.setBaseVO(BaseVO.FAILURE, \"\u5176\u4e2d\u4f7f\u7528\u7684\u6a21\u7248\u53d8\u91cf\u201c\"+templateVarName+\"\u201d\u4e0d\u5b58\u5728\uff01\u4fdd\u5b58\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u4fee\u6539\u540e\u518d\u5c1d\u8bd5\u4fdd\u5b58\");"], [216, "\t    \t\t\treturn vo;"], [217, "\t        \t}"], [218, "//\t        \tString content = G.templateVarMap.get(site.getTemplateName()).get(templateVarName);"], [219, ""], [220, "\t        \t//\u8bb2\u7528\u6237\u4fdd\u5b58\u7684\u8ddf\u5185\u5b58\u4e2d\u7684\u6a21\u7248\u53d8\u91cf\u5185\u5bb9\u6bd4\u8f83\uff0c\u662f\u5426\u4e00\u6837\uff0c\u82e5\u4e0d\u4e00\u6837\uff0c\u8981\u5c06\u5f53\u524d\u7684\u4fdd\u5b58"], [221, "\t        \tif(!(content.replaceAll(\"\\r|\\n|\\t\", \"\").equals(templateVarText.replaceAll(\"\\r|\\n|\\t\", \"\")))){"], [222, "\t        \t\t//\u4e0d\u4e00\u6837\uff0c\u8fdb\u884c\u4fdd\u5b58"], [223, ""], [224, "\t        \t    //\u6a21\u7248\u540d\u5b57\u68c0\u7d22\uff0c\u662f\u5426\u662f\u4f7f\u7528\u7684\u5bfc\u5165\u7684\u6a21\u7248\uff0c\u82e5\u662f\u4f7f\u7528\u7684\u5bfc\u5165\u7684\u6a21\u7248\uff0c\u5219\u53ea\u5217\u51fa\u5bfc\u5165\u7684\u6a21\u7248\u53d8\u91cf"], [225, "\t        \t    String templateNameWhere = \"\";"], [226, "\t        \t    if(site.getTemplateName() != null && site.getTemplateName().length() > 0){"], [227, "\t        \t    \ttemplateNameWhere = \" AND template_var.template_name = '\"+ site.getTemplateName() +\"'\";"], [228, "\t        \t    }"], [229, "\t        \t\tcom.xnx3.wangmarket.admin.entity.TemplateVar tv = sqlDAO.findAloneBySqlQuery(\"SELECT * FROM template_var WHERE siteid = \" + site.getId() + templateNameWhere + \" AND var_name = '\"+templateVarName+\"'\", com.xnx3.wangmarket.admin.entity.TemplateVar.class);"], [230, "\t        \t\tif(tv != null){"], [231, "\t        \t\t\ttv.setUpdatetime(DateUtil.timeForUnix10());"], [232, "\t\t        \t\tsqlDAO.save(tv);"], [233, ""], [234, "\t\t        \t\tTemplateVarData templateVarData = sqlDAO.findById(TemplateVarData.class, tv.getId());"], [235, "\t\t        \t\ttemplateVarData.setText(templateVarText);"], [236, "\t\t        \t\tsqlDAO.save(templateVarData);"], [237, ""], [238, "\t\t        \t\t//\u4fdd\u5b58\u5b8c\u540e\uff0c\u8981\u5c06\u5176\u66f4\u65b0\u5230\u5168\u5c40\u7f13\u5b58\u4e2d"], [239, "\t\t        \t\tupdateTemplateVarForCache(tv, templateVarData);"], [240, "\t        \t\t}"], [241, "\t        \t}"], [242, ""], [243, "//\t            \u5c06\u7528\u6237\u4fdd\u5b58\u7684\u5f53\u524d\u7684\u6a21\u7248\u9875\u9762\uff0c\u6a21\u7248\u53d8\u91cf\u6458\u9664\u51fa\u6765\uff0c\u8fd8\u539f\u4e3a\u6a21\u7248\u8c03\u7528\u7684\u6a21\u5f0f"], [244, "\t            html = html.replaceAll(\"<!--templateVarStart--><!--templateVarName=\"+templateVarName+\"-->([\\\\s|\\\\S]*?)<!--templateVarEnd-->\", \"{include=\"+templateVarName+\"}\");"], [245, "\t        }"], [246, "\t\t}"]]}, "num_lines_added": 85, "num_lines_removed": 72}