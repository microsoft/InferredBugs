{"hash": "0ef9c94f1812e0b6222e5fdb6e378600b87dc07e", "message": "Bulk Workflow Manager - Fixes for edge cases (1 bucket size, no search results, etc.)", "file_num_lines": 429, "diff_parsed": {"added": [[112, "        log.trace(\"Entering initialized\");"], [113, ""], [131, "        long size = nodes.getSize();"], [142, "        final String relPath = params.get(KEY_RELATIVE_PATH, \"\");"], [143, ""], [147, "        Node previousBatchNode = null, batchItemNode = null;"], [149, "            Node payloadNode = nodes.nextNode();"], [150, "            log.debug(\"nodes has next: {}\", nodes.hasNext());"], [151, ""], [152, "            log.trace(\"Processing search result [ {} ]\", payloadNode.getPath());"], [154, "            if(StringUtils.isNotBlank(relPath)) {"], [155, "                if(payloadNode.hasNode(relPath)) {"], [156, "                    payloadNode = payloadNode.getNode(relPath);"], [157, "                } else {"], [158, "                    log.warn(\"Could not find node at [ {} ]\", payloadNode.getPath() + \"/\" + relPath);"], [159, "                    continue;"], [160, "                }"], [161, "                // No rel path, so use the Query result node as the payload Node"], [162, "            }"], [163, ""], [164, "            total++;"], [172, "            final String batchItemPath = batchPath + \"/\" + total;"], [173, ""], [174, "            batchItemNode = JcrUtil.createPath(batchItemPath, SLING_FOLDER, JcrConstants.NT_UNSTRUCTURED, session,"], [175, "                    false);"], [177, "            log.trace(\"Created batch item path at [ {} ]\", batchItemPath);"], [178, ""], [179, "            JcrUtil.setProperty(batchItemNode, KEY_PATH, payloadNode.getPath());"], [180, "            log.trace(\"Added payload [ {} ] for batch item [ {} ]\", payloadNode.getPath(), batchItemNode.getPath());"], [183, "                previousBatchNode = batchItemNode.getParent();"], [187, "                JcrUtil.setProperty(previousBatchNode, KEY_NEXT_BATCH, batchItemNode.getParent().getPath());"], [193, "        } // while"], [195, "        if(total > 0) {"], [196, "            // Set last batch's \"next batch\" property to complete so we know we're done"], [197, "            JcrUtil.setProperty(batchItemNode.getParent(), KEY_NEXT_BATCH, STATE_COMPLETE);"], [199, "            if (total % SAVE_THRESHOLD != 0) {"], [200, "                session.save();"], [201, "            }"], [203, "            properties.put(KEY_CURRENT_BATCH, currentBatch);"], [204, "            properties.put(KEY_TOTAL, total);"], [205, "            properties.put(KEY_INITIALIZED, true);"], [206, "            properties.put(KEY_STATE, STATE_NOT_STARTED);"], [208, "            resource.getResourceResolver().commit();"], [209, ""], [210, "            log.info(\"Completed initialization of Bulk Workflow Manager\");"], [211, "        } else {"], [212, "            throw new IllegalArgumentException(\"Query returned zero results.\");"], [213, "        }"], [277, ""], [278, "        log.info(\"Completed starting of Bulk Workflow Manager\");"]], "deleted": [[129, "        long size = queryResult.getNodes().getSize();"], [143, "        Node previousBatchNode = null, node = null;"], [153, "            final String batchItemPath = batchPath + \"/\" + total++;"], [154, "            node = JcrUtil.createPath(batchItemPath, SLING_FOLDER, JcrConstants.NT_UNSTRUCTURED, session, false);"], [156, "            JcrUtil.setProperty(node, KEY_PATH, nodes.nextNode().getPath());"], [159, "                previousBatchNode = node.getParent();"], [163, "                JcrUtil.setProperty(previousBatchNode, KEY_NEXT_BATCH, node.getParent().getPath());"], [169, "        }"], [171, "        // Set last batch's \"next batch\" property to complete so we know we're done"], [172, "        JcrUtil.setProperty(node.getParent(), KEY_NEXT_BATCH, STATE_COMPLETE);"], [174, "        if (total % SAVE_THRESHOLD != 0) {"], [175, "            session.save();"], [176, "        }"], [178, "        properties.put(KEY_CURRENT_BATCH, currentBatch);"], [179, "        properties.put(KEY_TOTAL, total);"], [180, "        properties.put(KEY_INITIALIZED, true);"], [181, "        properties.put(KEY_STATE, STATE_NOT_STARTED);"], [183, "        resource.getResourceResolver().commit();"]]}, "num_lines_added": 50, "num_lines_removed": 18}