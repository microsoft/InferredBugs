{"hash": "f5cbe77170da0c33fc6cfdda1e9aebbffa190c96", "message": "Optimized. Avoid large ClassPool memory usage", "file_num_lines": 40, "diff_parsed": {"added": [[4, "import java.io.DataInputStream;"], [32, "\t\t\tgeneratorParams.put(getClassName(bytes), new GeneratorParams(generatorStrategy, classGenerator));"], [33, "\t\t} catch (Exception e) {"], [37, ""], [38, "\t/**"], [39, "\t * http://stackoverflow.com/questions/1649674/resolve-class-name-from-bytecode"], [40, "\t *"], [41, "\t * @param bytes"], [42, "\t * @return"], [43, "\t * @throws Exception"], [44, "\t */"], [45, "\tpublic static String getClassName(byte[] bytes) throws Exception {"], [46, "\t\tDataInputStream dis = new DataInputStream(new ByteArrayInputStream(bytes));"], [47, "\t\tdis.readLong(); // skip header and class version"], [48, "\t\tint cpcnt = (dis.readShort() & 0xffff) - 1;"], [49, "\t\tint[] classes = new int[cpcnt];"], [50, "\t\tString[] strings = new String[cpcnt];"], [51, "\t\tfor (int i = 0; i < cpcnt; i++) {"], [52, "\t\t\tint t = dis.read();"], [53, "\t\t\tif (t == 7)"], [54, "\t\t\t\tclasses[i] = dis.readShort() & 0xffff;"], [55, "\t\t\telse if (t == 1)"], [56, "\t\t\t\tstrings[i] = dis.readUTF();"], [57, "\t\t\telse if (t == 5 || t == 6) {"], [58, "\t\t\t\tdis.readLong();"], [59, "\t\t\t\ti++;"], [60, "\t\t\t} else if (t == 8)"], [61, "\t\t\t\tdis.readShort();"], [62, "\t\t\telse"], [63, "\t\t\t\tdis.readInt();"], [64, "\t\t}"], [65, "\t\tdis.readShort(); // skip access flags"], [66, "\t\treturn strings[classes[(dis.readShort() & 0xffff) - 1] - 1].replace('/', '.');"], [67, "\t}"]], "deleted": [[4, "import java.io.IOException;"], [8, "import org.hotswap.agent.javassist.ClassPool;"], [9, "import org.hotswap.agent.javassist.CtClass;"], [11, "import org.hotswap.agent.plugin.proxy.ProxyTransformationUtils;"], [35, "\t\t\tClassPool classPool = ProxyTransformationUtils.getClassPool(generatorStrategy.getClass().getClassLoader());"], [36, "\t\t\tCtClass cc = classPool.makeClass(new ByteArrayInputStream(bytes), false);"], [37, "\t\t\tgeneratorParams.put(cc.getName(), new GeneratorParams(generatorStrategy, classGenerator));"], [38, "\t\t\tcc.detach();"], [39, "\t\t} catch (IOException | RuntimeException e) {"]]}, "num_lines_added": 34, "num_lines_removed": 9}