{"hash": "6e60ee2436502fd0934414104a6d51a51a4b153b", "message": "#30 Add Hibernate 4.3.x support", "file_num_lines": 118, "diff_parsed": {"added": [[3, "import org.hibernate.Version;"], [4, "import org.hotswap.agent.javassist.compiler.ast.StringL;"], [6, "import org.hotswap.agent.util.ReflectionHelper;"], [9, "import javax.persistence.Persistence;"], [56, "        String[] version = Version.getVersionString().split(\"\\\\.\");"], [57, "        boolean version43OrGreater = false;"], [58, "        try {"], [59, "            version43OrGreater = Integer.valueOf(version[0]) >= 4 && Integer.valueOf(version[1]) >= 3;"], [60, "        } catch (Exception e) {"], [61, "            LOGGER.warning(\"Unable to resolve hibernate version '{}'\", version);"], [62, "        }"], [63, ""], [68, "                    if (version43OrGreater) {"], [69, "                        wrapper.refreshProxiedFactoryVersion43OrGreater();"], [70, "                    } else {"], [71, "                        wrapper.refreshProxiedFactory();"], [72, "                    }"], [79, "    public void refreshProxiedFactoryVersion43OrGreater() {"], [80, "        if (info == null) {"], [81, "            currentInstance = Persistence.createEntityManagerFactory(persistenceUnitName, properties);"], [82, "        } else {"], [83, "            try {"], [84, "                Class bootstrapClazz = loadClass(\"org.hibernate.jpa.boot.spi.Bootstrap\");"], [85, "                Class builderClazz = loadClass(\"org.hibernate.jpa.boot.spi.EntityManagerFactoryBuilder\");"], [86, ""], [87, "                Object builder = ReflectionHelper.invoke(null, bootstrapClazz, \"getEntityManagerFactoryBuilder\","], [88, "                        new Class[]{PersistenceUnitInfo.class, Map.class}, info, properties);"], [89, ""], [90, "                currentInstance = (EntityManagerFactory) ReflectionHelper.invoke(builder, builderClazz, \"build\","], [91, "                        new Class[]{});"], [92, "            } catch (Exception e) {"], [93, "                e.printStackTrace();"], [94, "                LOGGER.error(\"Unable to reload persistence unit {}\", info, e);"], [95, "            }"], [96, "        }"], [97, "    }"], [98, ""], [104, "        try {"], [105, "            Class entityManagerFactoryRegistryClazz = loadClass(\"org.hibernate.ejb.internal.EntityManagerFactoryRegistry\");"], [106, "            Object instance = ReflectionHelper.get(null, entityManagerFactoryRegistryClazz, \"INSTANCE\");"], [107, "            ReflectionHelper.invoke(instance, entityManagerFactoryRegistryClazz, \"removeEntityManagerFactory\","], [108, "                    new Class[] {String.class, EntityManagerFactory.class}, persistenceUnitName, currentInstance);"], [109, "        } catch (Exception e) {"], [110, "            LOGGER.error(\"Unable to clear previous instance of entity manager factory\");"], [111, "        }"], [112, ""], [118, "    // from HibernatePersistence.createContainerEntityManagerFactory()"], [120, "        try {"], [121, "            Class ejb3ConfigurationClazz = loadClass(\"org.hibernate.ejb.Ejb3Configuration\");"], [122, "            LOGGER.trace(\"new Ejb3Configuration()\");"], [123, "            Object cfg = ejb3ConfigurationClazz.newInstance();"], [124, ""], [125, "            LOGGER.trace(\"cfg.configure( info, properties );\");"], [126, ""], [127, "            if (info != null) {"], [128, "                ReflectionHelper.invoke(cfg, ejb3ConfigurationClazz, \"configure\","], [129, "                        new Class[]{PersistenceUnitInfo.class, Map.class}, info, properties);"], [130, "            }"], [131, "            else {"], [132, "                ReflectionHelper.invoke(cfg, ejb3ConfigurationClazz, \"configure\","], [133, "                        new Class[]{String.class, Map.class}, persistenceUnitName, properties);"], [134, "            }"], [135, ""], [136, "            LOGGER.trace(\"configured.buildEntityManagerFactory()\");"], [137, "            currentInstance = (EntityManagerFactory) ReflectionHelper.invoke(cfg, ejb3ConfigurationClazz, \"buildEntityManagerFactory\","], [138, "                    new Class[]{});"], [139, ""], [140, ""], [141, "        } catch (Exception e) {"], [142, "            LOGGER.error(\"Unable to build fresh entity manager factory for persistence unit {}\", persistenceUnitName);"], [143, "        }"], [166, "                        // if reload in progress, wait for it"], [173, ""], [174, "    private Class loadClass(String name) throws ClassNotFoundException {"], [175, "        return getClass().getClassLoader().loadClass(name);"], [176, "    }"]], "deleted": [[3, "import org.hibernate.ejb.Ejb3Configuration;"], [4, "import org.hibernate.ejb.internal.EntityManagerFactoryRegistry;"], [58, "                    wrapper.refreshProxiedFactory();"], [70, "        EntityManagerFactoryRegistry.INSTANCE.removeEntityManagerFactory(persistenceUnitName, currentInstance);"], [72, "        // from HibernatePersistence.createContainerEntityManagerFactory()"], [78, "        LOGGER.trace(\"new Ejb3Configuration()\");"], [79, "        Ejb3Configuration cfg = new Ejb3Configuration();"], [80, "        LOGGER.trace(\"cfg.configure( info, properties );\");"], [81, ""], [82, "        Ejb3Configuration configured;"], [83, "        if (info != null)"], [84, "            configured = cfg.configure(info, properties);"], [85, "        else"], [86, "            configured = cfg.configure(persistenceUnitName, properties);"], [87, ""], [88, "        LOGGER.trace(\"configured.buildEntityManagerFactory()\");"], [89, "        currentInstance = configured != null ? configured.buildEntityManagerFactory() : null;"], [112, "                        // if reload in progress, waitForResult for it"]]}, "num_lines_added": 76, "num_lines_removed": 18}