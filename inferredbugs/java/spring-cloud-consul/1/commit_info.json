{"hash": "af03a6b0f7e2e4a93219ae6a2c75f3d692e96abd", "message": "Removes consulDiscoveryProperties from config client bootstrap.\n\nThe need to set a property to disable registration is no longer needed\nsince auto registration is separate and not imported in bootstrap.\n\nfixes gh-465", "file_num_lines": 62, "diff_parsed": {"added": [[2, " * Copyright 2013-2018 the original author or authors."], [19, "import org.apache.catalina.webresources.TomcatURLStreamHandlerFactory;"], [21, "import org.junit.Before;"], [25, "import org.springframework.boot.autoconfigure.EnableAutoConfiguration;"], [26, "import org.springframework.boot.builder.SpringApplicationBuilder;"], [31, "import org.springframework.context.ConfigurableApplicationContext;"], [33, "import org.springframework.context.support.AbstractApplicationContext;"], [46, "\tprivate ConfigurableApplicationContext context;"], [47, ""], [48, "\t@Before"], [49, "\tpublic void init() {"], [50, "\t\t//FIXME: why do I need to do this? (fails in maven build without it."], [51, "\t\tTomcatURLStreamHandlerFactory.disable();"], [52, "\t}"], [58, "\t\t\t\t((AbstractApplicationContext) this.context.getParent()).close();"], [66, "\t\tsetup(\"server.port=0\", \"spring.cloud.config.discovery.enabled=true\","], [67, "\t\t\t\t\"logging.level.org.springframework.cloud.config.client=DEBUG\","], [68, "\t\t\t\t\"spring.cloud.consul.discovery.test.enabled:true\","], [69, "\t\t\t\t\"spring.application.name=discoveryclientconfigservicetest\","], [73, ""], [85, "\t\tthis.context = new SpringApplicationBuilder(TestConfig.class)"], [86, "\t\t\t\t.properties(env)"], [87, "\t\t\t\t.run();"], [91, "\t@EnableAutoConfiguration"], [92, "\tprotected static class TestConfig { }"]], "deleted": [[2, " * Copyright 2013-2016 the original author or authors."], [19, "import java.util.Arrays;"], [20, ""], [25, "import org.springframework.boot.autoconfigure.context.PropertyPlaceholderAutoConfiguration;"], [26, "import org.springframework.boot.test.util.TestPropertyValues;"], [27, "import org.springframework.cloud.client.DefaultServiceInstance;"], [28, "import org.springframework.cloud.client.ServiceInstance;"], [29, "import org.springframework.cloud.commons.util.UtilAutoConfiguration;"], [31, "import org.springframework.cloud.config.client.DiscoveryClientConfigServiceBootstrapConfiguration;"], [32, "import org.springframework.cloud.consul.ConsulAutoConfiguration;"], [34, "import org.springframework.cloud.consul.discovery.ConsulDiscoveryClientConfiguration;"], [35, "import org.springframework.cloud.consul.discovery.ConsulDiscoveryProperties;"], [38, "import org.springframework.context.annotation.AnnotationConfigApplicationContext;"], [39, "import org.springframework.context.annotation.Bean;"], [43, "import static org.mockito.BDDMockito.given;"], [45, "import static org.mockito.Mockito.mock;"], [55, "\tprivate AnnotationConfigApplicationContext context;"], [61, "\t\t\t\t((AnnotationConfigApplicationContext) this.context.getParent()).close();"], [69, "\t\tsetup(\"server.port=7000\", \"spring.cloud.config.discovery.enabled=true\","], [84, "\t\tAnnotationConfigApplicationContext parent = new AnnotationConfigApplicationContext();"], [85, "\t\tTestPropertyValues.of(env).applyTo(parent);"], [86, "\t\tparent.register(UtilAutoConfiguration.class,"], [87, "\t\t\t\tPropertyPlaceholderAutoConfiguration.class, EnvironmentKnobbler.class,"], [88, "\t\t\t\tConsulDiscoveryClientConfigServiceBootstrapConfiguration.class,"], [89, "\t\t\t\tDiscoveryClientConfigServiceBootstrapConfiguration.class,"], [90, "\t\t\t\tConfigClientProperties.class);"], [91, "\t\tparent.refresh();"], [92, "\t\tthis.context = new AnnotationConfigApplicationContext();"], [93, "\t\tthis.context.setParent(parent);"], [94, "\t\tthis.context.register(PropertyPlaceholderAutoConfiguration.class,"], [95, "\t\t\t\tConsulConfigServerAutoConfiguration.class, ConsulAutoConfiguration.class,"], [96, "\t\t\t\tConsulDiscoveryClientConfiguration.class);"], [97, "\t\tthis.context.refresh();"], [101, "\tprotected static class EnvironmentKnobbler {"], [102, ""], [103, "\t\t@Bean"], [104, "\t\tpublic ConsulDiscoveryClient consulDiscoveryClient("], [105, "\t\t\t\tConsulDiscoveryProperties properties) {"], [106, "\t\t\tConsulDiscoveryClient client = mock(ConsulDiscoveryClient.class);"], [107, "\t\t\tServiceInstance instance = new DefaultServiceInstance(\"configserver\","], [108, "\t\t\t\t\tproperties.getHostname(), properties.getPort(), false);"], [109, "\t\t\tgiven(client.getInstances(\"configserver\"))"], [110, "\t\t\t\t\t.willReturn(Arrays.asList(instance));"], [111, "\t\t\treturn client;"], [112, "\t\t}"], [113, ""], [114, "\t}"]]}, "num_lines_added": 25, "num_lines_removed": 47}