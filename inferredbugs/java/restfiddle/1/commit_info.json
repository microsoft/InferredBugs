{"hash": "b359dc65ce6a192a6fd8050448400f39c6fd325d", "message": "#189 redefine relation", "file_num_lines": 193, "diff_parsed": {"added": [[23, "import org.bson.BSONObject;"], [86, "\t    dbRefToRelation(dbObject);"], [105, "\tdbRefToRelation(resultObject);"], [133, ""], [134, "\trelationToDBRef(dbObject, projectId);"], [137, "\tdbRefToRelation(dbObject);"], [156, "\t    JSONObject uiJson = new JSONObject(map);"], [158, "\t    DBObject obj = (DBObject) JSON.parse(uiJson.toString());"], [159, "\t    obj.removeField(\"_id\");"], [166, "\t    Set<String> keySet = obj.keySet();"], [168, "\t\tresultObject.put(key, obj.get(key));"], [170, "\t    relationToDBRef(resultObject, projectId);"], [173, "\tdbRefToRelation(resultObject);"], [215, "    private void dbRefToRelation(DBObject dbObject) {"], [216, "\tif (dbObject == null) {"], [217, "\t    return;"], [218, "\t}"], [219, "\tif (dbObject.containsField(\"_id\"))"], [220, "\t    dbObject.put(\"_id\", ((ObjectId) dbObject.get(\"_id\")).toHexString());"], [221, "\tfor (String key : dbObject.keySet()) {"], [222, "\t    Object obj = dbObject.get(key);"], [223, "\t    if (obj instanceof DBRef) {"], [224, "\t\tDBRef ref = (DBRef) obj;"], [225, "\t\tdbObject.put(key, dbRefToRel(ref));"], [226, "\t    } else if (obj instanceof DBObject) {"], [227, "\t\tdbRefToRelation((DBObject) obj);"], [228, "\t    }"], [230, ""], [231, "    }"], [232, ""], [233, "    private DBObject dbRefToRel(DBRef obj){"], [234, "\treturn new BasicDBObject().append(\"_rel\",new BasicDBObject().append(\"entity\", obj.getRef().split(\"_\")[1]).append(\"_id\", ((ObjectId)obj.getId()).toHexString()));"], [235, "    }"], [236, ""], [237, "    private void relationToDBRef(DBObject dbObject, String projectId) {"], [238, "\tfor (String key : dbObject.keySet()) {"], [239, "\t    Object obj = dbObject.get(key);"], [240, "\t    if (obj instanceof DBObject) {"], [241, "\t\tDBObject doc = (DBObject) obj;"], [242, "\t\tif (doc.containsField(\"_rel\")) {"], [243, "\t\t    DBObject relation = (DBObject) doc.get(\"_rel\");"], [244, "\t\t    dbObject.put(key, new DBRef(mongoTemplate.getDb(), projectId + \"_\" + (String) relation.get(\"entity\"), (new ObjectId((String) relation.get(\"_id\")))));"], [245, "\t\t} else {"], [246, "\t\t    relationToDBRef(doc, projectId);"], [248, "\t    }"], [249, "\t}"]], "deleted": [[85, "\t    resolveDBRef(dbObject);"], [104, "\tresolveDBRef(resultObject);"], [132, "\tfor(String key : dbObject.keySet()){"], [133, "\t    Object obj = dbObject.get(key);"], [134, "\t    if(obj instanceof DBObject) {"], [135, "\t\tDBObject doc = (DBObject)obj;"], [136, "\t\tif(doc.containsField(\"_relation\")){"], [137, "\t\t    DBObject relation = (DBObject) doc.get(\"_relation\");"], [138, "\t\t    dbObject.put(key,new DBRef(mongoTemplate.getDb(),projectId+\"_\"+(String)relation.get(\"entity\") ,new ObjectId((String)relation.get(\"_id\"))));"], [139, "\t\t}"], [140, "\t    }"], [141, "\t}"], [144, "\tresolveDBRef(dbObject);"], [163, "\t    JSONObject uiJson = createJsonFromMap(map);"], [165, "\t    uiJson.remove(\"_id\");"], [172, "\t    Set<String> keySet = uiJson.keySet();"], [174, "\t\tObject obj = uiJson.get(key);"], [175, "\t\tif (obj instanceof Map) {"], [176, "\t\t    Map doc = (Map) obj;"], [177, "\t\t    if (doc.containsKey(\"_relation\")) {"], [178, "\t\t\tMap relation = (Map) doc.get(\"_relation\");"], [179, "\t\t\tresultObject.put(key, new DBRef(mongoTemplate.getDb(), projectId + \"_\" + (String) relation.get(\"entity\"), new ObjectId((String) relation.get(\"_id\"))));"], [180, "\t\t    } else {"], [181, "\t\t\tresultObject.put(key, uiJson.get(key));"], [182, "\t\t    }"], [183, "\t\t} else {"], [184, "\t\t    resultObject.put(key, uiJson.get(key));"], [185, "\t\t}"], [189, "\tresolveDBRef(resultObject);"], [231, "    private DBObject resolveDBRef(DBObject dbObject){"], [232, "\tif(dbObject == null){"], [233, "\t    return null;"], [235, "\tdbObject.put(\"_id\", ((ObjectId)dbObject.get(\"_id\")).toHexString());"], [236, "\t    for(String key : dbObject.keySet()){"], [237, "\t\tObject data = dbObject.get(key);"], [238, "\t\tif(data instanceof DBRef){"], [239, "\t\t   DBRef obj = (DBRef)data;"], [240, "\t\t   dbObject.put(key, resolveDBRef(obj.fetch()));"], [241, ""], [243, "\t    }"], [244, "\treturn dbObject;"]]}, "num_lines_added": 46, "num_lines_removed": 41}