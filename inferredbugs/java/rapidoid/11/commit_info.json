{"hash": "b37553416045529562df7c240d7f38450e2f64a9", "message": "Refactored out multi-instance DB logic and state into new class \"DBs\".", "file_num_lines": 108, "diff_parsed": {"added": [[34, "\tstatic final Class<Db> DB_IMPL_CLASS;"], [36, "\tprivate static Db db;"], [42, "\t\tinit();"], [43, "\t}"], [45, "\tpublic static String path() {"], [46, "\t\tString path = U.option(\"db\", \"\");"], [48, "\t\tif (!path.isEmpty() && !path.endsWith(File.separator)) {"], [49, "\t\t\tpath += File.separator;"], [50, "\t\t}"], [52, "\t\treturn path;"], [55, "\tpublic static void init() {"], [56, "\t\tdb = (Db) U.newInstance(DB.DB_IMPL_CLASS, \"default\", path() + \"default.db\");"], [59, "\tpublic static Db db() {"], [60, "\t\tassert U.must(db != null, \"Database not initialized!\");"], [61, "\t\treturn db;"]], "deleted": [[24, "import java.util.Collections;"], [26, "import java.util.Map;"], [29, "import org.rapidoid.lambda.Mapper;"], [37, "\tprivate static final Class<Db> DB_IMPL_CLASS;"], [39, "\tprivate static Db defaultDb;"], [40, ""], [41, "\tprivate static final Map<String, Db> DB_INSTANCES;"], [48, "\t\tDB_INSTANCES = U.autoExpandingMap(new Mapper<String, Db>() {"], [49, "\t\t\t@Override"], [50, "\t\t\tpublic Db map(String name) throws Exception {"], [51, "\t\t\t\tString dbPath = U.option(\"db\", \"\");"], [52, "\t\t\t\tif (!dbPath.isEmpty() && !dbPath.endsWith(File.separator)) {"], [53, "\t\t\t\t\tdbPath += File.separator;"], [54, "\t\t\t\t}"], [55, "\t\t\t\tString dbFilename = dbPath + name + \".db\";"], [56, "\t\t\t\treturn (Db) U.newInstance(DB_IMPL_CLASS, name, dbFilename);"], [57, "\t\t\t}"], [58, "\t\t});"], [60, "\t\tdefaultDb = instance(\"default\");"], [61, "\t}"], [63, "\tpublic static Db db() {"], [64, "\t\tassert U.must(defaultDb != null, \"Database not initialized!\");"], [65, "\t\treturn defaultDb;"], [68, "\tpublic static Db instance(String dbName) {"], [69, "\t\treturn DB_INSTANCES.get(dbName);"], [72, "\tpublic static Map<String, Db> instances() {"], [73, "\t\treturn Collections.unmodifiableMap(DB_INSTANCES);"], [164, "\tpublic static void destroy(String name) {"], [165, "\t\tinstance(name).destroy();"], [166, "\t\tremove(name);"], [167, "\t}"], [168, ""], [169, "\tpublic synchronized static void destroyAll() {"], [170, "\t\tfor (Db db : DB_INSTANCES.values()) {"], [171, "\t\t\tdb.destroy();"], [172, "\t\t}"], [173, ""], [174, "\t\tDB_INSTANCES.clear();"], [175, "\t\tdefaultDb = instance(\"default\");"], [176, "\t}"], [177, ""], [178, "\tpublic static void remove(String name) {"], [179, "\t\tDB_INSTANCES.remove(name);"], [180, "\t\tif (name.equals(\"default\")) {"], [181, "\t\t\tdefaultDb = instance(\"default\");"], [182, "\t\t}"], [183, "\t}"], [184, ""]]}, "num_lines_added": 15, "num_lines_removed": 48}