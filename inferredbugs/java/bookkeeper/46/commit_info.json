{"hash": "4250c1f93962af30e6e40759e006035a7089613e", "message": "BOOKKEEPER-538: Race condition in BookKeeper#close (ivank via fpj)\n\n\n\ngit-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1431536 13f79535-47bb-0310-9956-ffa450edef68", "file_num_lines": 509, "diff_parsed": {"added": [[94, "        DISCONNECTED, CONNECTING, CONNECTED, CLOSED"], [141, "                    } else if (future.isSuccess() && (state == ConnectionState.CLOSED"], [142, "                                                      || state == ConnectionState.DISCONNECTED)) {"], [151, "                        if (state != ConnectionState.CLOSED) {"], [152, "                            state = ConnectionState.DISCONNECTED;"], [153, "                        }"], [172, "        boolean completeOpNow = false;"], [173, "        int opRc = BKException.Code.OK;"], [176, "            completeOpNow = true;"], [182, "                    completeOpNow = true;"], [183, "                    opRc = BKException.Code.OK;"], [184, "                } else if (state == ConnectionState.CLOSED) {"], [185, "                    completeOpNow = true;"], [186, "                    opRc = BKException.Code.BookieHandleNotAvailableException;"], [203, "            if (!completeOpNow) {"], [209, "        if (completeOpNow) {"], [210, "            op.operationComplete(opRc, null);"], [347, "    /**"], [348, "     * Disconnects the bookie client. It can be reused."], [349, "     */"], [350, "    public void disconnect() {"], [351, "        closeInternal(false);"], [352, "    }"], [353, ""], [354, "    /**"], [355, "     * Closes the bookie client permanently. It cannot be reused."], [356, "     */"], [358, "        closeInternal(true);"], [359, "    }"], [360, ""], [361, "    private void closeInternal(boolean permanent) {"], [363, "            if (permanent) {"], [364, "                state = ConnectionState.CLOSED;"], [365, "            } else if (state != ConnectionState.CLOSED) {"], [366, "                state = ConnectionState.DISCONNECTED;"], [367, "            }"], [474, "        Channel c = this.channel;"], [475, "        if (c != null) {"], [476, "            c.close();"], [477, "        }"], [479, "            if (state != ConnectionState.CLOSED) {"], [480, "                state = ConnectionState.DISCONNECTED;"], [481, "            }"]], "deleted": [[94, "        DISCONNECTED, CONNECTING, CONNECTED"], [141, "                    } else if (future.isSuccess() && state == ConnectionState.DISCONNECTED) {"], [150, "                        state = ConnectionState.DISCONNECTED;"], [169, "        boolean doOpNow = false;"], [170, ""], [173, "            doOpNow = true;"], [179, "                    doOpNow = true;"], [196, "            if (!doOpNow) {"], [202, "        if (doOpNow) {"], [203, "            op.operationComplete(BKException.Code.OK, null);"], [342, "            state = ConnectionState.DISCONNECTED;"], [449, "        channel.close();"], [451, "            state = ConnectionState.DISCONNECTED;"]]}, "num_lines_added": 43, "num_lines_removed": 13}