{"hash": "e18d8c9bfb269fcf13277df671f381e2be89e751", "message": "Add test coverage for SocketContext max request size\n\nhttps://www.pivotaltracker.com/story/show/108453676\n\nFixed service error response propagation in FactoryService\nfor forwarded POSTs.\n\nFixed broadcast query task tests that relied on\nspecific text in exception message, which is a no-no.\n\nNEVER assert inside a completion: the resulting\nexception is just logged and will not terminate the\ntest\n\nChange-Id: I3a0b1df3099c006e3b7fcbca60df8dd636345120", "file_num_lines": 1899, "diff_parsed": {"added": [[916, ""], [917, "        VerificationHost targetHost = this.host.getPeerHost();"], [918, "        URI exampleFactoryURI = UriUtils.buildUri(targetHost, ExampleFactoryService.SELF_LINK);"], [919, ""], [920, "        this.host.testStart(this.serviceCount);"], [921, "        List<URI> exampleServices = new ArrayList<>();"], [922, "        for (int i = 0; i < this.serviceCount; i++) {"], [923, "            ExampleServiceState s = new ExampleServiceState();"], [924, "            s.name = \"document\" + i;"], [925, "            s.documentSelfLink = s.name;"], [926, "            exampleServices.add(UriUtils.buildUri(this.host.getUri(),"], [927, "                    ExampleFactoryService.SELF_LINK, s.documentSelfLink));"], [928, "            this.host.send(Operation.createPost(exampleFactoryURI)"], [929, "                    .setBody(s)"], [930, "                    .setCompletion(this.host.getCompletion()));"], [931, "        }"], [932, "        this.host.testWait();"], [933, ""], [934, "        nonpaginatedBroadcastQueryTasksOnExampleStates(targetHost);"], [960, "                    validateBroadcastQueryPostFailure(targetHost, o, e);"], [987, "                    validateBroadcastQueryPostFailure(targetHost, o, e);"], [994, "    private void validateBroadcastQueryPostFailure(VerificationHost targetHost, Operation o,"], [995, "            Throwable e) {"], [996, "        if (e != null) {"], [997, "            ServiceErrorResponse rsp = o.getBody(ServiceErrorResponse.class);"], [998, "            if (rsp.message == null"], [999, "                    || !rsp.message.contains(QueryOption.BROADCAST.toString())) {"], [1000, "                targetHost.failIteration(new IllegalStateException(\"Expected failure\"));"], [1001, "                return;"], [1002, "            }"], [1003, "            targetHost.completeIteration();"], [1004, "        } else {"], [1005, "            targetHost.failIteration(new IllegalStateException(\"expected failure\"));"], [1007, "        targetHost.completeIteration();"], [1008, "    }"], [1010, "    private void nonpaginatedBroadcastQueryTasksOnExampleStates(VerificationHost targetHost)"], [1011, "            throws Throwable {"], [1034, "                    assertTrue(this.serviceCount == rsp.results.documentCount);"]], "deleted": [[916, "        nonpaginatedBroadcastQueryTasksOnExampleStates();"], [942, "                    assertNotNull(e);"], [943, "                    assertTrue(e.getMessage().contains(\"broadcasted query only supports sorting on [\" +"], [944, "                            ServiceDocument.FIELD_NAME_SELF_LINK + \"]\"));"], [945, ""], [946, "                    targetHost.completeIteration();"], [973, "                    assertNotNull(e);"], [974, "                    assertTrue(e.getMessage().contains(\"Direct query is not supported in broadcast\"));"], [975, ""], [976, "                    targetHost.completeIteration();"], [983, "    private void nonpaginatedBroadcastQueryTasksOnExampleStates() throws Throwable {"], [984, ""], [985, "        VerificationHost targetHost = this.host.getPeerHost();"], [986, "        URI exampleFactoryURI = UriUtils.buildUri(targetHost, ExampleFactoryService.SELF_LINK);"], [987, ""], [988, "        int serviceCount = 100;"], [989, "        this.host.testStart(serviceCount);"], [990, "        List<URI> exampleServices = new ArrayList<>();"], [991, "        for (int i = 0; i < serviceCount; i++) {"], [992, "            ExampleServiceState s = new ExampleServiceState();"], [993, "            s.name = \"document\" + i;"], [994, "            s.documentSelfLink = s.name;"], [995, ""], [996, "            exampleServices.add(UriUtils.buildUri(this.host.getUri(),"], [997, "                    ExampleFactoryService.SELF_LINK, s.documentSelfLink));"], [998, ""], [999, "            this.host.send(Operation.createPost(exampleFactoryURI)"], [1000, "                    .setBody(s)"], [1001, "                    .setCompletion(this.host.getCompletion()));"], [1003, "        this.host.testWait();"], [1027, "                    assertTrue(serviceCount == rsp.results.documentCount);"], [1028, ""], [1038, "        URI exampleFactoryURI = UriUtils.buildUri(targetHost, ExampleFactoryService.SELF_LINK);"], [1042, "        this.host.testStart(serviceCount);"], [1043, "        List<URI> exampleServices = new ArrayList<>();"], [1044, "        for (int i = 0; i < serviceCount; i++) {"], [1045, "            ExampleServiceState s = new ExampleServiceState();"], [1046, "            s.name = \"document\" + i;"], [1047, "            s.documentSelfLink = s.name;"], [1048, ""], [1049, "            exampleServices.add(UriUtils.buildUri(this.host.getUri(),"], [1050, "                    ExampleFactoryService.SELF_LINK, s.documentSelfLink));"], [1051, ""], [1052, "            this.host.send(Operation.createPost(exampleFactoryURI)"], [1053, "                    .setBody(s)"], [1054, "                    .setCompletion(this.host.getCompletion()));"], [1055, "        }"], [1056, "        this.host.testWait();"]]}, "num_lines_added": 38, "num_lines_removed": 48}