{"hash": "1fb7d0024e40ce22143ab404bd71fa9312c12145", "message": "Handle applications not closing sessions better.\n\n- Introduces basic finalizer to the InternalSession object, which closes\n  the underlying connection if the session was not closed by the user,\n  and prints a warning to stderr.", "file_num_lines": 135, "diff_parsed": {"added": [[25, "import java.util.Map;"], [26, "import java.util.concurrent.atomic.AtomicBoolean;"], [27, ""], [28, "import org.neo4j.driver.internal.logging.DevNullLogger;"], [30, "import org.neo4j.driver.internal.spi.Logger;"], [31, "import org.neo4j.driver.internal.spi.StreamCollector;"], [33, "import org.neo4j.driver.v1.Value;"], [37, "import static org.jsoup.helper.Validate.fail;"], [39, "import static org.mockito.Mockito.spy;"], [48, "    private final Connection mock = mock( Connection.class );"], [49, "    private InternalSession sess = new InternalSession( mock, new DevNullLogger() );"], [50, ""], [56, "        InternalSession sess = new InternalSession( mock, new DevNullLogger() );"], [146, ""], [147, "    @Test"], [148, "    public void shouldWarnAndCloseOnLeak() throws Throwable"], [149, "    {"], [150, "        // Given"], [151, "        CloseTrackingConnection connection = new CloseTrackingConnection();"], [152, "        Logger logger = spy( Logger.class );"], [153, ""], [154, "        // When"], [155, "        new InternalSession( connection, logger );"], [156, ""], [157, "        // Then"], [158, "        long deadline = System.currentTimeMillis() + 1000 * 30;"], [159, "        while ( !connection.closeCalled.get() )"], [160, "        {"], [161, "            System.gc();"], [162, "            if ( System.currentTimeMillis() > deadline )"], [163, "            {"], [164, "                fail( \"Expected unclosed session object to close its inner connection on finalize.\" );"], [165, "            }"], [166, "        }"], [167, ""], [168, "        verify( logger ).error( \"Neo4j Session object leaked, please ensure that your application calls the `close` method on Sessions before disposing of the objects.\", null );"], [169, "    }"], [170, ""], [171, "    private static class CloseTrackingConnection implements Connection"], [172, "    {"], [173, "        AtomicBoolean closeCalled = new AtomicBoolean();"], [174, ""], [175, "        @Override"], [176, "        public void init( String clientName )"], [177, "        {"], [178, ""], [179, "        }"], [180, ""], [181, "        @Override"], [182, "        public void run( String statement, Map<String,Value> parameters, StreamCollector collector )"], [183, "        {"], [184, ""], [185, "        }"], [186, ""], [187, "        @Override"], [188, "        public void discardAll()"], [189, "        {"], [190, ""], [191, "        }"], [192, ""], [193, "        @Override"], [194, "        public void pullAll( StreamCollector collector )"], [195, "        {"], [196, ""], [197, "        }"], [198, ""], [199, "        @Override"], [200, "        public void reset( StreamCollector collector )"], [201, "        {"], [202, ""], [203, "        }"], [204, ""], [205, "        @Override"], [206, "        public void sync()"], [207, "        {"], [208, ""], [209, "        }"], [210, ""], [211, "        @Override"], [212, "        public void close()"], [213, "        {"], [214, "            closeCalled.set( true );"], [215, "        }"], [216, ""], [217, "        @Override"], [218, "        public boolean isOpen()"], [219, "        {"], [220, "            return true;"], [221, "        }"], [222, "    }"]], "deleted": [[43, "        Connection mock = mock( Connection.class );"], [45, "        InternalSession sess = new InternalSession( mock );"], [58, "        Connection mock = mock( Connection.class );"], [60, "        InternalSession sess = new InternalSession( mock );"], [74, "        Connection mock = mock( Connection.class );"], [76, "        InternalSession sess = new InternalSession( mock );"], [90, "        Connection mock = mock( Connection.class );"], [92, "        InternalSession sess = new InternalSession( mock );"], [106, "        Connection mock = mock( Connection.class );"], [108, "        InternalSession sess = new InternalSession( mock );"], [122, "        Connection mock = mock( Connection.class );"], [124, "        InternalSession sess = new InternalSession( mock );"], [137, "        Connection mock = mock( Connection.class );"], [139, "        InternalSession sess = new InternalSession( mock );"]]}, "num_lines_added": 90, "num_lines_removed": 14}