{"hash": "8f409eb28ac5e270dd76eeee88db8d9613857172", "message": "Fixed deviantArt downloading low res when higher res is available\n\nAlso fixed a few bugs related to non-image items that crashed the rip.", "file_num_lines": 369, "diff_parsed": {"added": [[4, "import java.net.HttpURLConnection;"], [118, "            cookies.put(\"agegate_state\",\"1\"); // Bypasses the age gate"], [128, "                try {"], [129, "                    String script = tag.html();"], [130, "                    script = script.substring(script.indexOf(\"window.__pageload\"));"], [131, "                    if (script.indexOf(id) < 0) {"], [132, "                        continue;"], [133, "                    }"], [134, "                    script = script.substring(script.indexOf(id));"], [135, "                    script = script.substring(script.indexOf(\"},\\\"src\\\":\\\"\") + 9, script.indexOf(\"\\\",\\\"type\\\"\"));                        // first },\"src\":\"url\" after id"], [136, "                    return script.replace(\"\\\\/\", \"/\");"], [137, "                } catch (StringIndexOutOfBoundsException e) {"], [138, "                    logger.debug(\"Unable to get json link from \" + page.location());"], [139, "                }"], [159, "\t\t\tif (thumb.attr(\"data-super-full-img\").contains(\"//orig\")) {"], [163, "\t\t\t\tString fullSize1 = jsonToImage(page,spanUrl.substring(spanUrl.lastIndexOf('-') + 1));"], [164, "\t\t\t\tif (fullSize1 == null || !fullSize1.contains(\"//orig\")) {"], [165, "                    fullSize = smallToFull(img.attr(\"src\"), spanUrl);"], [167, "\t\t\t\tif (fullSize == null && fullSize1 != null) {"], [168, "                    fullSize = fullSize1;"], [169, "                }"], [172, "\t\t\t    if (thumb.attr(\"data-super-full-img\") != null) {"], [173, "\t\t\t        fullSize = thumb.attr(\"data-super-full-img\");"], [174, "                } else if (thumb.attr(\"data-super-img\") != null) {"], [175, "\t\t\t        fullSize = thumb.attr(\"data-super-img\");"], [176, "                } else {"], [177, "                    continue;"], [178, "                }"], [299, "            Document documentz = resp.parse();"], [300, "            Element ele = documentz.select(\"div.dev-description\").first();"], [301, "            if (ele == null) {"], [316, "                if (fullSize != null) {"], [317, "                    String[] split = fullSize.split(\"/\");"], [318, "                    fullSize = split[split.length - 1];"], [319, "                }"], [328, "                logger.info(\"Failed to get description at \" + url + \": '\" + ioe.getMessage() + \"'\");"], [350, "            Elements els = doc.select(\"img.dev-content-full\");"], [351, "            String fsimage = null;"], [355, "                fsimage = els.get(0).attr(\"src\");"], [357, "                if (fsimage.contains(\"//orig\")) {"], [358, "                    return fsimage;"], [359, "                }"], [360, "            }"], [361, "            // Try to find the download button"], [362, "            els = doc.select(\"a.dev-page-download\");"], [363, "            if (els.size() > 0) {"], [364, "                // Full-size image"], [365, "                String downloadLink = els.get(0).attr(\"href\");"], [366, "                logger.info(\"Found download page: \" + downloadLink);"], [367, "                HttpURLConnection con = (HttpURLConnection) new URL(downloadLink).openConnection();"], [368, "                con.setRequestProperty(\"Referer\",this.url.toString());"], [369, "                String cookieString = \"\";"], [370, "                for (Map.Entry<String, String> entry : cookies.entrySet()) {"], [371, "                    cookieString = cookieString + entry.getKey() + \"=\" + entry.getValue() + \"; \";"], [372, "                }"], [373, "                cookieString = cookieString.substring(0,cookieString.length() - 1);"], [374, "                con.setRequestProperty(\"Cookie\",cookieString);"], [375, "                con.setRequestProperty(\"User-Agent\",this.USER_AGENT);"], [376, "                con.setInstanceFollowRedirects(true);"], [377, "                con.connect();"], [378, "                int code = con.getResponseCode();"], [379, "                String location = con.getHeaderField(\"Location\");"], [380, "                con.disconnect();"], [381, "                if (location.contains(\"//orig\")) {"], [382, "                    fsimage = location;"], [383, "                }"], [384, "            }"], [385, "            if (fsimage != null) {"]], "deleted": [[126, "                String script = tag.html();"], [127, "                script = script.substring(script.indexOf(\"window.__pageload\"));"], [128, "                script = script.substring(script.indexOf(id));"], [129, "                script = script.substring(script.indexOf(\"},\\\"src\\\":\\\"\") + 9,script.indexOf(\"\\\",\\\"type\\\"\"));\t\t\t\t\t\t// first },\"src\":\"url\" after id"], [130, "                return script.replace(\"\\\\/\",\"/\");"], [150, "\t\t\tif (!thumb.attr(\"data-super-full-img\").isEmpty()) {"], [154, "\t\t\t\tfullSize = jsonToImage(page,spanUrl.substring(spanUrl.lastIndexOf('-') + 1));"], [155, "\t\t\t\tif (fullSize == null) {"], [156, "\t\t\t\t\ttry {"], [157, "\t\t\t\t\t\tfullSize = thumbToFull(img.attr(\"src\"), true);"], [158, "\t\t\t\t\t} catch (Exception e) {"], [159, "\t\t\t\t\t\tlogger.info(\"Attempting to get full size image from \" + thumb.attr(\"href\"));"], [160, "\t\t\t\t\t\tfullSize = smallToFull(img.attr(\"src\"), thumb.attr(\"href\"));"], [161, "\t\t\t\t\t}"], [165, "                continue;"], [286, "            Elements els = resp.parse().select(\"div[class=dev-description]\");"], [287, "            if (els.size() == 0) {"], [290, "            Document documentz = resp.parse();"], [291, "            Element ele = documentz.select(\"div[class=dev-description]\").get(0);"], [304, "                String[] split = fullSize.split(\"/\");"], [305, "                fullSize = split[split.length - 1];"], [314, "                logger.info(\"Failed to get description \" + page + \" : '\" + ioe.getMessage() + \"'\");"], [335, ""], [336, "            // Try to find the download button"], [338, "            Elements els = doc.select(\"a.dev-page-download\");"], [339, "            if (els.size() > 0) {"], [340, "                // Full-size image"], [341, "                String fsimage = els.get(0).attr(\"href\");"], [342, "                logger.info(\"Found download page: \" + fsimage);"], [343, "                return fsimage;"], [344, "            }"], [345, ""], [347, "            els = doc.select(\"img.dev-content-full\");"], [350, "                String fsimage = els.get(0).attr(\"src\");"]]}, "num_lines_added": 68, "num_lines_removed": 34}