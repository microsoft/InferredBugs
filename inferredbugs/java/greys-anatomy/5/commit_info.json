{"hash": "16476e7995d023251fdad510d31560177a197ffe", "message": "\u5b8c\u6210\u5bf9\u81ea\u5b9a\u4e49ClassLoader\u7684\u652f\u6301", "file_num_lines": 77, "diff_parsed": {"added": [[6, "import java.util.Properties;"], [14, ""], [15, "    public static final String KEY_GREYS_CLASS_LOADER = \"KEY_GREYS_CLASS_LOADER\";"], [16, "    public static final String KEY_GREYS_ADVICE_BEFORE_METHOD = \"KEY_GREYS_ADVICE_BEFORE_METHOD\";"], [17, "    public static final String KEY_GREYS_ADVICE_RETURN_METHOD = \"KEY_GREYS_ADVICE_RETURN_METHOD\";"], [18, "    public static final String KEY_GREYS_ADVICE_THROWS_METHOD = \"KEY_GREYS_ADVICE_THROWS_METHOD\";"], [19, ""], [29, "    private static ClassLoader loadOrDefineClassLoader(String agentJar) throws Throwable {"], [30, ""], [31, "        final Properties props = System.getProperties();"], [32, "        final ClassLoader classLoader;"], [33, "        if (props.containsKey(KEY_GREYS_CLASS_LOADER)) {"], [34, "            classLoader = (ClassLoader) props.get(KEY_GREYS_CLASS_LOADER);"], [35, "        } else {"], [36, "            classLoader = new URLClassLoader(new URL[]{new URL(\"file:\" + agentJar)}) {"], [37, ""], [38, "                @Override"], [39, "                protected synchronized Class<?> loadClass(String name, boolean resolve) throws ClassNotFoundException {"], [40, "                    final Class<?> loadedClass = findLoadedClass(name);"], [41, "                    if (loadedClass != null) {"], [42, "                        return loadedClass;"], [43, "                    }"], [44, ""], [45, "                    try {"], [46, "                        Class<?> aClass = findClass(name);"], [47, "                        if (resolve) {"], [48, "                            resolveClass(aClass);"], [49, "                        }"], [50, "                        return aClass;"], [51, "                    } catch (Exception e) {"], [52, "                        return super.loadClass(name, resolve);"], [53, "                    }"], [54, "                }"], [55, ""], [56, "            };"], [57, ""], [58, "            final Class<?> clazz = classLoader.loadClass(\"com.github.ompc.greys.advisor.AdviceWeaver\");"], [59, "            props.put(KEY_GREYS_CLASS_LOADER, classLoader);"], [60, "            props.put(KEY_GREYS_ADVICE_BEFORE_METHOD, clazz.getMethod(\"methodOnBegin\","], [61, "                    int.class,"], [62, "                    String.class,"], [63, "                    String.class,"], [64, "                    String.class,"], [65, "                    Object.class,"], [66, "                    Object[].class));"], [67, "            props.put(KEY_GREYS_ADVICE_RETURN_METHOD, clazz.getMethod(\"methodOnReturnEnd\", Object.class));"], [68, "            props.put(KEY_GREYS_ADVICE_THROWS_METHOD, clazz.getMethod(\"methodOnThrowingEnd\", Throwable.class));"], [69, "        }"], [70, ""], [71, "        return classLoader;"], [72, "    }"], [73, ""], [77, "            // \u4f20\u9012\u7684args\u53c2\u6570\u5206\u4e24\u4e2a\u90e8\u5206:agentJar\u8def\u5f84\u548cagentArgs"], [78, "            // \u5206\u522b\u662fAgent\u7684JAR\u5305\u8def\u5f84\u548c\u671f\u671b\u4f20\u9012\u5230\u670d\u52a1\u7aef\u7684\u53c2\u6570"], [79, "            final int index = args.indexOf(\";\");"], [80, "            final String agentJar = args.substring(0, index);"], [81, "            final String agentArgs = args.substring(index, args.length());"], [84, "            final ClassLoader agentLoader = loadOrDefineClassLoader(agentJar);"], [95, "                    .invoke(null, agentArgs);"]], "deleted": [[6, ""], [7, "import static com.github.ompc.greys.GreysLauncher.JARFILE;"], [27, "//            // \u4f20\u9012\u7684args\u53c2\u6570\u5206\u4e24\u4e2a\u90e8\u5206:agentJar\u8def\u5f84\u548cagentArgs"], [28, "//            // \u5206\u522b\u662fAgent\u7684JAR\u5305\u8def\u5f84\u548c\u671f\u671b\u4f20\u9012\u5230\u670d\u52a1\u7aef\u7684\u53c2\u6570"], [29, "//            final int index = args.indexOf(\";\");"], [30, "//            final String agentJar = args.substring(0, index);"], [31, "//            final String agentArgs = args.substring(index, args.length());"], [34, "            final ClassLoader agentLoader = new URLClassLoader(new URL[]{new URL(\"file:\" + JARFILE)}) {"], [35, ""], [36, "                // \u8fd9\u91cc\u8fd8\u662f\u653e\u5f03\u7834\u574f\u53cc\u4eb2\u59d4\u6d3e\u6a21\u578b\uff0c\u56e0\u4e3a\u63a5\u4e0b\u6765\u7684\u7f16\u7a0b\u6a21\u578b\u592a\u590d\u6742"], [37, "//                @Override"], [38, "//                protected synchronized Class<?> loadClass(String name, boolean resolve) throws ClassNotFoundException {"], [39, "//                    final Class<?> loadedClass = findLoadedClass(name);"], [40, "//                    if (loadedClass != null) {"], [41, "//                        return loadedClass;"], [42, "//                    }"], [43, "//"], [44, "//                    try {"], [45, "//                        Class<?> aClass = findClass(name);"], [46, "//                        if (resolve) {"], [47, "//                            resolveClass(aClass);"], [48, "//                        }"], [49, "//                        return aClass;"], [50, "//                    } catch (Exception e) {"], [51, "//                        return super.loadClass(name, resolve);"], [52, "//                    }"], [53, "//                }"], [54, ""], [55, "            };"], [66, "                    .invoke(null, args);"]]}, "num_lines_added": 59, "num_lines_removed": 30}