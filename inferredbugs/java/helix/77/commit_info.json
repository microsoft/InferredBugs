{"hash": "72edf485e720da407632b2e0f095cff8ca39c6d1", "message": "Add method to wait and return established session's ID (#677)\n\nzkClient's getSessionId() could bring in session race condition: session A is connected in waitUntilConnected, but when zkClient.getSession() is called in zkHelixManager, session A might be already expired and so zkClient.getSession() gets session B. This session ID is critical for the firs time handling new session after zkclient is created in zkHelixManager.\r\n\r\nSolution: add a new method waitForEstablishedSession() to wait for SynCconnected state and return the session id before unlocking the eventLock.\r\n\r\nChange list:\r\n- Add a new method waitForEstablishedSession()\r\n- Add a unit test to cover the new method.", "file_num_lines": 1369, "diff_parsed": {"added": [[1371, "  public long waitForEstablishedSession(long timeout, TimeUnit timeUnit) {"], [1372, "    validateCurrentThread();"], [1373, ""], [1374, "    acquireEventLock();"], [1375, "    try {"], [1376, "      if (!waitForKeeperState(KeeperState.SyncConnected, timeout, timeUnit)) {"], [1377, "        throw new ZkTimeoutException(\"Waiting to be connected to ZK server has timed out.\");"], [1378, "      }"], [1379, "      // Reading session ID before unlocking event lock is critical to guarantee the established"], [1380, "      // session's ID won't change."], [1381, "      return getSessionId();"], [1382, "    } finally {"], [1383, "      getEventLock().unlock();"], [1384, "    }"], [1385, "  }"], [1386, ""], [1393, "    validateCurrentThread();"], [2153, ""], [2154, "  private void validateCurrentThread() {"], [2155, "    if (_zookeeperEventThread != null && Thread.currentThread() == _zookeeperEventThread) {"], [2156, "      throw new IllegalArgumentException(\"Must not be done in the zookeeper event thread.\");"], [2157, "    }"], [2158, "  }"]], "deleted": [[1377, "    if (_zookeeperEventThread != null && Thread.currentThread() == _zookeeperEventThread) {"], [1378, "      throw new IllegalArgumentException(\"Must not be done in the zookeeper event thread.\");"], [1379, "    }"]]}, "num_lines_added": 23, "num_lines_removed": 3}