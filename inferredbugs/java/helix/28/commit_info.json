{"hash": "ab5c9b0912da5bff5af06d27e79fe8761f50d7bd", "message": "[HELIX-19]Allow instance to autojoin a cluster", "file_num_lines": 882, "diff_parsed": {"added": [[68, "import org.apache.helix.model.ConfigScope;"], [70, "import org.apache.helix.model.InstanceConfig;"], [73, "import org.apache.helix.model.builder.ConfigScopeBuilder;"], [123, "  public static final String                  ALLOW_PARTICIPANT_AUTO_JOIN = \"allowParticipantAutoJoin\";"], [689, "    // Read cluster config and see if instance can auto join the cluster"], [690, "    boolean autoJoin = false;"], [691, "    try"], [692, "    {"], [693, "      ConfigScope scope ="], [694, "          new ConfigScopeBuilder().forCluster(getClusterName())"], [695, "                                  .build();"], [696, "      autoJoin = Boolean.parseBoolean(getConfigAccessor().get(scope, ALLOW_PARTICIPANT_AUTO_JOIN));"], [697, "      logger.info(\"Auto joining \" + _clusterName +\" is true\");"], [698, "    }"], [699, "    catch(Exception e)"], [700, "    {"], [701, "    }"], [704, "      if(!autoJoin)"], [705, "      {"], [706, "        throw new HelixException(\"Initial cluster structure is not set up for instance:\""], [708, "      }"], [709, "      else"], [710, "      {"], [711, "        logger.info(\"Auto joining instance \" + _instanceName);"], [712, "        InstanceConfig instanceConfig = new InstanceConfig(_instanceName);"], [713, "        String hostName = _instanceName;"], [714, "        String port = \"\";"], [715, "        int lastPos = _instanceName.lastIndexOf(\"_\");"], [716, "        if (lastPos > 0)"], [717, "        {"], [718, "          hostName = _instanceName.substring(0, lastPos);"], [719, "          port = _instanceName.substring(lastPos + 1);"], [720, "        }"], [721, "        instanceConfig.setHostName(hostName);"], [722, "        instanceConfig.setPort(port);"], [723, "        instanceConfig.setInstanceEnabled(true);"], [724, "        getClusterManagmentTool().addInstance(_clusterName, instanceConfig);"], [725, "      }"]], "deleted": [[685, ""], [688, "      throw new HelixException(\"Initial cluster structure is not set up for instance:\""]]}, "num_lines_added": 38, "num_lines_removed": 2}