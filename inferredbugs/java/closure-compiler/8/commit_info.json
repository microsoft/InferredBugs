{"hash": "8f773e34a83ed8f5eb404dcbf4630a779779ea7e", "message": "-Change the ProcessTweaks pass to inject the compiler overrides by replacing\ncalls to goog.tweak.getCompilerOverrides_\n\nR=nicksantos\nDELTA=87  (49 added, 22 deleted, 16 changed)\n\n\nRevision created by MOE tool push_codebase.\nMOE_MIGRATION=237\n\n\ngit-svn-id: https://closure-compiler.googlecode.com/svn/trunk@683 b0f006be-c8cd-11de-a2e8-8d36a3108c74", "file_num_lines": 393, "diff_parsed": {"added": [[111, "    GET_COMPILER_OVERRIDES(\"goog.tweak.getCompilerOverrides_\"),"], [204, "    CollectTweaksResult result = collectTweaks(root);"], [205, "    applyCompilerDefaultValueOverrides(result.tweakInfos);"], [210, "      changed = stripAllCalls(result.tweakInfos);"], [212, "      changed = replaceGetCompilerOverridesCalls(result.getOverridesCalls);"], [220, "   * Passes the compiler default value overrides to the JS by replacing calls"], [221, "   * to goog.tweak.getCompilerOverrids_ with a map of tweak ID->default value;"], [222, "   */"], [223, "  private boolean replaceGetCompilerOverridesCalls("], [224, "      List<TweakFunctionCall> calls) {"], [225, "    for (TweakFunctionCall call : calls) {"], [226, "      Node callNode = call.callNode;"], [227, "      Node objNode = createCompilerDefaultValueOverridesVarNode(callNode);"], [228, "      callNode.getParent().replaceChild(callNode, objNode);"], [229, "    }"], [230, "    return !calls.isEmpty();"], [231, "  }"], [232, ""], [233, "  /**"], [269, "   * Creates a JS object that holds a map of tweakId -> default value override."], [283, "    return objNode;"], [305, "  private CollectTweaksResult collectTweaks(Node root) {"], [313, "    return new CollectTweaksResult(tweakInfos, pass.getOverridesCalls);"], [314, "  }"], [315, ""], [316, "  private final static class CollectTweaksResult {"], [317, "    final Map<String, TweakInfo> tweakInfos;"], [318, "    final List<TweakFunctionCall> getOverridesCalls;"], [319, ""], [320, "    CollectTweaksResult(Map<String, TweakInfo> tweakInfos,"], [321, "        List<TweakFunctionCall> getOverridesCalls) {"], [322, "      this.tweakInfos = tweakInfos;"], [323, "      this.getOverridesCalls = getOverridesCalls;"], [324, "    }"], [332, "    final List<TweakFunctionCall> getOverridesCalls = Lists.newArrayList();"], [345, ""], [346, "      if (tweakFunc == TweakFunction.GET_COMPILER_OVERRIDES) {"], [347, "        getOverridesCalls.add("], [348, "            new TweakFunctionCall(t.getSourceName(), tweakFunc, n));"], [349, "        return;"], [350, "      }"]], "deleted": [[55, "  /**"], [56, "   * Var name for the map of tweakId->defaultValue of the compiler-specified"], [57, "   * overrides. Added only when stripTweaks == false."], [58, "   */"], [59, "  private static final String DEFAULT_VALUES_VAR_NAME ="], [60, "      \"__JSCOMPILER_TWEAK_DEFAULT_VALUE_OVERRIDES\";"], [61, ""], [210, "    Map<String, TweakInfo> tweakInfos = collectTweaks(root);"], [211, "    applyCompilerDefaultValueOverrides(tweakInfos);"], [216, "      changed = stripAllCalls(tweakInfos);"], [218, "      // Pass the compiler default value overrides to the JS through a specially"], [219, "      // named variable."], [220, "      Node varNode = createCompilerDefaultValueOverridesVarNode("], [221, "          root.getFirstChild());"], [222, "      root.getFirstChild().addChildToFront(varNode);"], [223, "      changed = true;"], [266, "   * Creates the var __JSCOMPILER_TWEAK_DEFAULT_VALUE_OVERRIDES = { ... };"], [267, "   * snippet that is prepended when there are compiler overrides and tweaks"], [268, "   * are not stripped."], [272, "    Node varNode = new Node(Token.VAR)"], [273, "        .copyInformationFrom(sourceInformationNode);"], [274, "    Node nameNode = Node.newString(Token.NAME, DEFAULT_VALUES_VAR_NAME)"], [275, "        .copyInformationFrom(sourceInformationNode);"], [278, "    varNode.addChildToBack(nameNode);"], [279, "    nameNode.addChildToBack(objNode);"], [288, "    return varNode;"], [310, "  private Map<String, TweakInfo> collectTweaks(Node root) {"], [318, "    return tweakInfos;"]]}, "num_lines_added": 41, "num_lines_removed": 28}